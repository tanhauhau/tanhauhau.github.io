<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="x-ua-compatible" content="ie=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
		<link rel="preconnect dns-prefetch" href="https://www.google-analytics.com" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://twitter.com/lihautan" rel="me" />
		<link rel="manifest" href="/manifest.webmanifest" />
		<meta name="theme-color" content="#bd93f9" />
		<link rel="apple-touch-icon" sizes="48x48" href="/icon-48x48.png" />
		<link rel="apple-touch-icon" sizes="72x72" href="/icon-72x72.png" />
		<link rel="apple-touch-icon" sizes="96x96" href="/icon-96x96.png" />
		<link rel="apple-touch-icon" sizes="144x144" href="/icon-144x144.png" />
		<link rel="apple-touch-icon" sizes="192x192" href="/icon-192x192.png" />
		<link rel="apple-touch-icon" sizes="256x256" href="/icon-256x256.png" />
		<link rel="apple-touch-icon" sizes="384x384" href="/icon-384x384.png" />
		<link rel="apple-touch-icon" sizes="512x512" href="/icon-512x512.png" />
		<link rel="icon" href="/icon-48x48.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link
			rel="preload"
			href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,400;0,500;0,700;1,300&family=Noto+Sans+SC:wght@500&display=swap"
			as="style"
			onload="this.rel='stylesheet'"
		/>
		<link
			rel="alternate"
			type="application/rss+xml"
			title="Tan Li Hau&#x27;s RSS Feed"
			href="/rss.xml"
		/>
		<link rel="sitemap" type="application/xml" href="/sitemap.xml" />
		<link rel="webmention" href="https://webmention.io/lihautan.com/webmention" />
		<link rel="pingback" href="https://webmention.io/lihautan.com/xmlrpc" />
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z6Y89Q69VY"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag('js', new Date());

			gtag('config', 'G-Z6Y89Q69VY');
		</script>
		
		<link href="https://lihautan.com/_app/immutable/assets/2.CDMtzrzD.css" rel="stylesheet">
		<link href="https://lihautan.com/_app/immutable/assets/Links.Barm56k2.css" rel="stylesheet">
		<link href="https://lihautan.com/_app/immutable/assets/PreloadingIndicator.CHlB5uuK.css" rel="stylesheet">
		<link href="https://lihautan.com/_app/immutable/assets/code-snippet.Ch6n4AYw.css" rel="stylesheet">
		<link href="https://lihautan.com/_app/immutable/assets/BlogLayout.D1SVHRXd.css" rel="stylesheet">
		<link href="https://lihautan.com/_app/immutable/assets/ldjson.CQpH2WJc.css" rel="stylesheet">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/entry/start.CVysmP4c.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/entry.NOq9Kj6o.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/scheduler.D6VJxl8L.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/entry/app.Bk7PW2KV.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/index.CLAVN-Y5.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/nodes/0.DLHgrcY7.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/nodes/2.CwhX-zvu.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/stores.CLeQvcbJ.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/Links.C4jMQkMc.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/each.DI7TeU31.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/index.DueORT-9.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/PreloadingIndicator.6QGaXoVk.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/nodes/26.CBsPy8pQ.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/code-snippet.Gym6WUAG.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/BlogLayout.BMJM32nZ.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/ldjson.BehsK3rr.js"><title>Contributing to Svelte - Implement {#key} | Tan Li Hau</title><!-- HEAD_svelte-1jsbgzp_START --><meta name="description" content="I am going to share an anecdote on how I implemented {#key} logic block in Svelte"><meta name="image" content="https://lihautan.com/_app/immutable/assets/hero-twitter.BMYe1IDC.jpg"><meta name="og:image" content="https://lihautan.com/_app/immutable/assets/hero-twitter.BMYe1IDC.jpg"><meta name="og:title" content="Contributing to Svelte - Implement {#key}"><meta name="og:description" content="I am going to share an anecdote on how I implemented {#key} logic block in Svelte"><meta name="og:type" content="website"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@lihautan"><meta name="twitter:title" content="Contributing to Svelte - Implement {#key}"><meta name="twitter:description" content="I am going to share an anecdote on how I implemented {#key} logic block in Svelte"><meta name="twitter:image" content="https://lihautan.com/_app/immutable/assets/hero-twitter.BMYe1IDC.jpg"><meta name="keywords" content="Svelte"><meta name="keywords" content="JavaScript"><meta name="keywords" content="Open Source"><meta itemprop="url" content="https://lihautan.com/contributing-to-svelte-implement-key-block"><meta itemprop="image" content="https://lihautan.com/_app/immutable/assets/hero-twitter.BMYe1IDC.jpg"><!-- HTML_TAG_START --><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","author":{"@type":"Person","name":"Tan Li Hau","url":"https://lihautan.com/about/"},"copyrightHolder":{"@type":"Person","name":"Tan Li Hau","url":"https://lihautan.com/about/"},"copyrightYear":"2022","creator":{"@type":"Person","name":"Tan Li Hau","url":"https://lihautan.com/about/"},"publisher":{"@type":"Person","name":"Tan Li Hau","url":"https://lihautan.com/about/"},"description":"I am going to share an anecdote on how I implemented {#key} logic block in Svelte","headline":"Contributing to Svelte - Implement {#key}","name":"Contributing to Svelte - Implement {#key}","inLanguage":"en"}</script><!-- HTML_TAG_END --><!-- HTML_TAG_START --><script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","description":"Breadcrumbs list","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","item":{"@id":"https://lihautan.com","name":"Homepage"},"name":"Homepage","position":1},{"@type":"ListItem","item":{"@id":"https://lihautan.com/contributing-to-svelte-implement-key-block","name":"Contributing to Svelte - Implement {#key}"},"name":"Contributing to Svelte - Implement {#key}","position":2}]}</script><!-- HTML_TAG_END --><!-- HEAD_svelte-1jsbgzp_END -->
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents">   <a href="#content" class="skip svelte-1x8iuzz" data-svelte-h="svelte-198b79b">Skip to content</a> <header class="svelte-1x8iuzz"><nav><ul class="mode-sidebar svelte-2qf5mw"><li class="svelte-2qf5mw" data-svelte-h="svelte-1c15i4q"><a href="/" class="svelte-2qf5mw">Tan Li Hau</a></li> <li class="desktop svelte-2qf5mw" data-svelte-h="svelte-jyiaso"><a data-sveltekit-preload-data href="/about" class="svelte-2qf5mw">About</a></li> <li class="desktop svelte-2qf5mw" data-svelte-h="svelte-nil8z4"><a data-sveltekit-preload-data href="/blogs" class="svelte-2qf5mw">Writings</a></li> <li class="desktop svelte-2qf5mw" data-svelte-h="svelte-lr8cqc"><a data-sveltekit-preload-data href="/talks" class="svelte-2qf5mw">Talks</a></li> <li class="desktop svelte-2qf5mw" data-svelte-h="svelte-1oruudc"><a data-sveltekit-preload-data href="/notes" class="svelte-2qf5mw">Notes</a></li> <li class="desktop svelte-2qf5mw" data-svelte-h="svelte-18xilfe"><a data-sveltekit-preload-data href="/books" class="svelte-2qf5mw">Books</a></li> <li class="social svelte-2qf5mw" data-svelte-h="svelte-1bsaw7m"><a aria-label="Twitter account" href="https://twitter.com/lihautan" class="svelte-2qf5mw"><svg viewBox="0 0 24 24" width="1em" height="1em" class="svelte-2qf5mw"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66
  10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5
  4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a> <a aria-label="Github account" href="https://github.com/tanhauhau" class="svelte-2qf5mw"><svg viewBox="0 0 24 24" width="1em" height="1em" class="svelte-2qf5mw"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0
  0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07
  5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65
  5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42
  3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a> <a aria-label="YouTube account" href="https://youtube.com/c/lihautan" class="svelte-2qf5mw"><svg viewBox="0 0 461.001 461.001" width="1em" height="1em" class="svelte-2qf5mw"><path d="M365.257 67.393H95.744C42.866 67.393 0 110.259 0 163.137v134.728c0 52.878 42.866 95.744 95.744 95.744h269.513c52.878 0 95.744-42.866 95.744-95.744V163.137c0-52.878-42.866-95.744-95.744-95.744zm-64.751 169.663-126.06 60.123c-3.359 1.602-7.239-.847-7.239-4.568V168.607c0-3.774 3.982-6.22 7.348-4.514l126.06 63.881c3.748 1.899 3.683 7.274-.109 9.082z"></path></svg></a></li> </ul></nav></header> <div class="sidebar svelte-s9hlkv">  <div class="float svelte-s9hlkv" data-svelte-h="svelte-x1w5me"><svg viewBox="0 0 30 50" width="30" height="50"><circle fill="currentColor" cy="15" cx="15" r="3"></circle><circle fill="currentColor" cy="25" cx="15" r="3"></circle><circle fill="currentColor" cy="35" cx="15" r="3"></circle></svg></div> </div> <main id="content" class="svelte-1x8iuzz"> <h1>Contributing to Svelte - Implement {#key}</h1> <div class="date svelte-13b38er">September 27, 2020</div> <a class="tag series svelte-13b38er" href="/series/Contributing to Svelte/">Series: Contributing to Svelte</a> <a class="tag svelte-13b38er" href="/tags/Svelte/">Svelte</a><a class="tag svelte-13b38er" href="/tags/JavaScript/">JavaScript</a><a class="tag svelte-13b38er" href="/tags/Open Source/">Open Source</a> <section role="navigation" aria-label="Table of Contents" class="svelte-zmasws"><ol class="svelte-zmasws"><li class="svelte-zmasws"><a href="#background" class="svelte-zmasws">Background</a>  </li><li class="svelte-zmasws"><a href="#the-motivation" class="svelte-zmasws">The motivation</a> <ol class="svelte-zmasws"><li class="svelte-zmasws"><a href="#transitions-for-reactive-data-change" class="svelte-zmasws">Transitions for reactive data change</a>  </li> </ol> </li><li class="svelte-zmasws"><a href="#the-implementation" class="svelte-zmasws">The implementation</a> <ol class="svelte-zmasws"><li class="svelte-zmasws"><a href="#parsing" class="svelte-zmasws">Parsing</a>  </li><li class="svelte-zmasws"><a href="#tracking-references-and-dependencies" class="svelte-zmasws">Tracking references and dependencies</a>  </li><li class="svelte-zmasws"><a href="#creating-code-blocks-fragments" class="svelte-zmasws">Creating code blocks &amp; fragments</a>  </li><li class="svelte-zmasws"><a href="#creating-code-for-ssr" class="svelte-zmasws">Creating code for SSR</a>  </li><li class="svelte-zmasws"><a href="#generate-code" class="svelte-zmasws">Generate code</a>  </li><li class="svelte-zmasws"><a href="#a-few-other-implementation-consideration" class="svelte-zmasws">A few other implementation consideration</a>  </li> </ol> </li><li class="svelte-zmasws"><a href="#the-testing" class="svelte-zmasws">The testing</a>  </li><li class="svelte-zmasws"><a href="#closing-notes" class="svelte-zmasws">Closing Notes</a>  </li></ol> </section> <article class="blog"><section data-svelte-h="svelte-1y3ejlq"><h2><a href="#background" id="background">Background</a></h2> <p>Unlike the other contributing to Svelte posts [<a href="/contributing-to-svelte-fixing-issue-5012">1</a>] [<a href="/contributing-to-svelte-fixing-issue-4392">2</a>], which I wrote it while implementing the fix, describing as detailed as possible, today I am going to share the process of how I implemented the <code class="inline">{#key}</code> block retrospectively.</p> <p>The implementation of the <code class="inline">{#key}</code> block is much simpler, relative to <code class="inline">{#if}</code>, <code class="inline">{#await}</code> or <code class="inline">{#each}</code>. And I believe the process of implementing the <code class="inline">{#key}</code> block helps paint the pratical side of <a href="/the-svelte-compiler-handbook">&quot;The Svelte Compiler Handbook&quot;</a> or my <a href="/looking-into-the-svelte-compiler">&quot;Looking into the Svelte compiler&quot; talk</a>.</p></section> <section><h2 data-svelte-h="svelte-lhxw09"><a href="#the-motivation" id="the-motivation">The motivation</a></h2> <p data-svelte-h="svelte-mq44gc">The idea of <code class="inline">{#key}</code> block starts with the feature request 2 years ago <em>(yea, it&#39;s that long)</em> for <strong>the ability to key a non-each component</strong>, <a href="https://github.com/sveltejs/svelte/issues/1469" rel="nofollow">GitHub issue #1469</a>.</p> <p data-svelte-h="svelte-1syg10g">To <code class="inline">key</code> a component, is to force recreation of the component when the <code class="inline">key</code> changes.</p> <p data-svelte-h="svelte-gtx1f7">And you see this ability of destroying and creating new components when using <code class="inline">{#each}</code> with <code class="inline">key</code>:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="prism language-svelte"><code><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"></div><div class="line">  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'alice'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><div class="line">  <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></div><div class="line">    data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'bob'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><div class="line">  <span class="token punctuation">&#125;</span></div><div class="line"></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></div><div class="line"><span class="token each"><span class="token punctuation">&#123;</span><span class="token keyword">#each</span> <span class="token language-javascript">data </span><span class="token keyword">as</span> <span class="token language-javascript">item </span><span class="token language-javascript"><span class="token punctuation">(</span>item<span class="token punctuation">.</span>id<span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span></div><div class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token language-javascript"><span class="token punctuation">&#123;</span> item<span class="token punctuation">.</span>name <span class="token punctuation">&#125;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></div><div class="line"><span class="token each"><span class="token punctuation">&#123;</span><span class="token keyword">/each</span><span class="token punctuation">&#125;</span></span></div></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-1e3h688"><a href="https://svelte.dev/repl/1be3a0b123aa4384853ff5abd103f9ae" rel="nofollow">REPL</a></p> <p data-svelte-h="svelte-gn2eyn">When we call the function <code class="inline">update</code>, we removed <code class="inline">alice</code> from the <code class="inline">data</code> and we added <code class="inline">bob</code>. The net effect is still having a list of 1 item. However, instead of reusing the 1 <code class="inline">&lt;div /&gt;</code> by updating <code class="inline">{ item.name }</code> to <code class="inline">&quot;bob&quot;</code>, Svelte removes and destroys the <code class="inline">&lt;div /&gt;</code> and create a new <code class="inline">&lt;div /&gt;</code> for <code class="inline">bob</code>. This is because of the <a href="https://svelte.dev/tutorial/keyed-each-blocks" rel="nofollow">key we specified to the <code class="inline">{#each}</code> block</a>. Svelte will not reuse the <code class="inline">&lt;div /&gt;</code> because it was created with a different <code class="inline">key</code>.</p> <p data-svelte-h="svelte-18fbfww">One of the benefits of having a key for <code class="inline">{#each}</code> item is to be able to add transition to the item correctly. Without a <code class="inline">key</code> to identify which item is added / removed, the transiion on a <code class="inline">{#each}</code> list will always applied to the last item, when the list grows or shrinks in length.</p> <p data-svelte-h="svelte-qr65wv"><a href="https://svelte.dev/repl/b1f5815f8b5f4634afa9025492739fa4" rel="nofollow">Try with and without the <code class="inline">key</code> in this REPL</a> to see the importance of having a <code class="inline">key</code>.</p> <blockquote data-svelte-h="svelte-hmy0j2"><p>This is similar to the <code class="inline">key</code> attribute of React, if you are familiar with React. <a href="https://www.nikgraf.com/blog/using-reacts-key-attribute-to-remount-a-component" rel="nofollow">Check this out on how to remount a component with the <code class="inline">key</code> attribute in React</a>.</p></blockquote> <p data-svelte-h="svelte-mm2qe9">However, the ability of having to <code class="inline">key</code> an element / component only exist for the <code class="inline">{#each}</code> block. To workaround the constraint, it&#39;s common to use the <strong>&quot;1-item keyed-each hack&quot;</strong>:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="prism language-svelte"><code><div class="line"><span class="token each"><span class="token punctuation">&#123;</span><span class="token keyword">#each</span> <span class="token language-javascript">key </span><span class="token keyword">as</span> <span class="token language-javascript">k </span><span class="token language-javascript"><span class="token punctuation">(</span>k<span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span></div><div class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token punctuation">/></span></span></div><div class="line"><span class="token each"><span class="token punctuation">&#123;</span><span class="token keyword">/each</span><span class="token punctuation">&#125;</span></span></div></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-abmja5">The <code class="inline">&lt;div /&gt;</code> will be recreated if the <code class="inline">key</code> has changed.</p></section> <section><h3 data-svelte-h="svelte-1sj2ye0"><a href="#transitions-for-reactive-data-change" id="transitions-for-reactive-data-change">Transitions for reactive data change</a></h3> <p data-svelte-h="svelte-yuj35k">Another commonly brought up request, to <strong>be able to apply <code class="inline">transition:</code> to an element when a reactive data changes</strong> (<a href="https://github.com/sveltejs/svelte/issues/5119" rel="nofollow">GitHub issue #5119</a>):</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="prism language-svelte"><code><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"></div><div class="line">  <span class="token keyword">import</span> <span class="token punctuation">&#123;</span> fade <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'svelte/transition'</span></div><div class="line">  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></div><div class="line">  <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> count <span class="token operator">+=</span><span class="token number">1</span></div><div class="line"></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></div><div class="line"></div><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">on:</span>click=</span><span class="token language-javascript"><span class="token punctuation">&#123;</span>handleClick<span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span>Click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></div><div class="line"></div><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>You clicked <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span> <span class="token attr-name"><span class="token namespace">transition:</span>fade</span><span class="token punctuation">></span></span><span class="token language-javascript"><span class="token punctuation">&#123;</span>count<span class="token punctuation">&#125;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">></span></span> times<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span></div></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-3nbhsl">This is another facet of the same issue.</p> <p data-svelte-h="svelte-1b4c9j5">We need an ability to transition the old element out, and transition a new element in when a data, or a <code class="inline">key</code> changes.</p> <p data-svelte-h="svelte-q5wtm9">A workaround, again, is to use the <strong>&quot;1-item keyed-each hack&quot;</strong>:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="prism language-svelte"><code><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"></div><div class="line">  <span class="token keyword">import</span> <span class="token punctuation">&#123;</span> fade <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'svelte/transition'</span></div><div class="line">  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></div><div class="line">  <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> count <span class="token operator">+=</span><span class="token number">1</span></div><div class="line"></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></div><div class="line"></div><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">on:</span>click=</span><span class="token language-javascript"><span class="token punctuation">&#123;</span>handleClick<span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span>Click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></div><div class="line"></div><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>You clicked</div><div class="line">  <span class="token each"><span class="token punctuation">&#123;</span><span class="token keyword">#each</span> <span class="token language-javascript"><span class="token punctuation">[</span>count<span class="token punctuation">]</span> </span><span class="token keyword">as</span> <span class="token language-javascript">count </span><span class="token language-javascript"><span class="token punctuation">(</span>count<span class="token punctuation">)</span></span><span class="token punctuation">&#125;</span></span></div><div class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span> <span class="token attr-name"><span class="token namespace">transition:</span>fade</span><span class="token punctuation">></span></span><span class="token language-javascript"><span class="token punctuation">&#123;</span>count<span class="token punctuation">&#125;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">></span></span></div><div class="line">  <span class="token each"><span class="token punctuation">&#123;</span><span class="token keyword">/each</span><span class="token punctuation">&#125;</span></span></div><div class="line"> times<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span></div></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-8eqh37">So the proposal of the feature request was to have a <code class="inline">{#key}</code> block:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="prism language-"><code><span class="line">&lt;p&gt;You clicked</span>
<span class="line">  &#123;#key count&#125;</span>
<span class="line">    &lt;strong transition:fade&gt;&#123;count&#125;&lt;/strong&gt;</span>
<span class="line">  &#123;/key&#125;</span>
<span class="line"> times&lt;/p&gt;</span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-umxxmu">I&#39;ve seen this issue months ago, and I passed the issue. I didn&#39;t think I know good enough to implement a new logic block. However, the issue recently resurfaced as someone commented on it recently. And this time, I felt I am ready, so here&#39;s my journey of implementing the <code class="inline">{#key}</code> block.</p></section> <section data-svelte-h="svelte-j5b5ef"><h2><a href="#the-implementation" id="the-implementation">The implementation</a></h2> <p>As explained in <a href="/the-svelte-compiler-handbook">&quot;The Svelte Compiler Handbook&quot;</a>, the Svelte compilation process can be broken into steps:</p> <ul><li>Parsing</li> <li>Tracking references and dependencies</li> <li>Creating code blocks &amp; fragments</li> <li>Generate code</li></ul> <p>Of course, that&#39;s the steps that we are going to work on as well.</p></section> <section><h3 data-svelte-h="svelte-1gj91mw"><a href="#parsing" id="parsing">Parsing</a></h3> <p data-svelte-h="svelte-k1y4md">The actual parsing starts <a href="https://github.com/sveltejs/svelte/blob/82dc26a31c37906153e07686b73d3af08dd50154/src/compiler/parse/index.ts#L51" rel="nofollow">here in src/compiler/parse/index.ts</a>:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">let</span><span style="color: var(--shiki-color-text)"> state</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">ParserState</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> fragment;</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">while</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.index </span><span style="color: var(--shiki-token-keyword)">&lt;</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">template</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">length</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  state </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">state</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">) </span><span style="color: var(--shiki-token-keyword)">||</span><span style="color: var(--shiki-color-text)"> fragment;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-yiw3l9">There are 4 states in the parser:</p> <ul data-svelte-h="svelte-5zvjtl"><li><strong>fragment</strong> - in this state, we check the current character and determine which state we should proceed to</li> <li><strong>tag</strong> - we enter this state when we encounter <code class="inline">&lt;</code> character. In this state, we are going to parse HTML tags (eg: <code class="inline">&lt;p&gt;</code>), attributes (eg: <code class="inline">class</code>) and directives (eg: <code class="inline">on:</code>).</li> <li><strong>mustache</strong> - we enter this state when we encounter <code class="inline">{</code> character. In this state, we are going to parse expression, <code class="inline">{ value }</code> and logic blocks <code class="inline">{#if}</code></li> <li><strong>text</strong> - In this state, we are going to parse texts that are neither <code class="inline">&lt;</code> nor <code class="inline">{</code>, which includes whitespace, newlines, and texts!</li></ul> <p data-svelte-h="svelte-wbzvqp">To be able to parse the <code class="inline">{#key}</code> block, we are going to take a look at the <a href="https://github.com/sveltejs/svelte/blob/82dc26a31c37906153e07686b73d3af08dd50154/src/compiler/parse/state/mustache.ts#L35" rel="nofollow"><strong>mustache</strong> state function</a>.</p> <p data-svelte-h="svelte-8e8hgm">The <code class="inline">{#key}</code> block syntax is similar to <code class="inline">{#if}</code> without <code class="inline">else</code>, we take in an expression in the opening block and that&#39;s all:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="prism language-svelte"><code><div class="line"><span class="token language-javascript"><span class="token punctuation">&#123;</span>#key expression<span class="token punctuation">&#125;</span></span></div><div class="line">   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token punctuation">/></span></span></div><div class="line"><span class="token language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">/</span>key<span class="token punctuation">&#125;</span></span></div><div class="line"></div><div class="line"><span class="token comment">&lt;!-- similar to --></span></div><div class="line"><span class="token language-javascript"><span class="token punctuation">&#123;</span>#<span class="token keyword">if</span> expression<span class="token punctuation">&#125;</span></span></div><div class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token punctuation">/></span></span></div><div class="line"><span class="token language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token punctuation">&#125;</span></span></div></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-182gnnf">So over here, when we encounter a <code class="inline">{#</code>, we add a case to check if we are starting a <code class="inline">{#key}</code> block:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">parser</span><span style="color: var(--shiki-token-function)">.eat</span><span style="color: var(--shiki-color-text)">(#)) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// if &#123;#if foo&#125;, &#123;#each foo&#125; or &#123;#await foo&#125;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">let</span><span style="color: var(--shiki-color-text)"> type;</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">parser</span><span style="color: var(--shiki-token-function)">.eat</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&#39;if&#39;</span><span style="color: var(--shiki-color-text)">)) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    type </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;IfBlock&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">parser</span><span style="color: var(--shiki-token-function)">.eat</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&#39;each&#39;</span><span style="color: var(--shiki-color-text)">)) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    type </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;EachBlock&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">parser</span><span style="color: var(--shiki-token-function)">.eat</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&#39;await&#39;</span><span style="color: var(--shiki-color-text)">)) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    type </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;AwaitBlock&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line inserted"><span style="color: var(--shiki-color-text)">   &#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">parser</span><span style="color: var(--shiki-token-function)">.eat</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&#39;key&#39;</span><span style="color: var(--shiki-color-text)">)) &#123;</span></span>
<span class="line inserted"><span style="color: var(--shiki-color-text)">     type </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;KeyBlock&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">parser</span><span style="color: var(--shiki-token-function)">.error</span><span style="color: var(--shiki-color-text)">(&#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      code</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#96;expected-block-type&#96;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line deleted"><span style="color: var(--shiki-color-text)">       message</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#96;Expected if, each or await&#96;</span></span>
<span class="line inserted"><span style="color: var(--shiki-color-text)">       message: </span><span style="color: var(--shiki-token-string-expression)">&#96;Expected if, each, await or key&#96;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125;);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125;</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-1oqbtr">Similarly, for closing block <code class="inline">{/</code>, we are going to make sure that <code class="inline">{#key}</code> closes with <code class="inline">{/key}</code>:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">parser</span><span style="color: var(--shiki-token-function)">.eat</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&#39;/&#39;</span><span style="color: var(--shiki-color-text)">)) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">let</span><span style="color: var(--shiki-color-text)"> block </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">parser</span><span style="color: var(--shiki-token-function)">.current</span><span style="color: var(--shiki-color-text)">();</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">let</span><span style="color: var(--shiki-color-text)"> expected;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-color-text)">.type </span><span style="color: var(--shiki-token-keyword)">===</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;IfBlock&#39;</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    expected </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;if&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-color-text)">.type </span><span style="color: var(--shiki-token-keyword)">===</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;EachBlock&#39;</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    expected </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;each&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-color-text)">.type </span><span style="color: var(--shiki-token-keyword)">===</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;AwaitBlock&#39;</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    expected </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;await&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line inserted"><span style="color: var(--shiki-color-text)">   &#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-color-text)">.type </span><span style="color: var(--shiki-token-keyword)">===</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;KeyBlock&#39;</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line inserted"><span style="color: var(--shiki-color-text)">     expected </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;key&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">parser</span><span style="color: var(--shiki-token-function)">.error</span><span style="color: var(--shiki-color-text)">(&#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      code</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#96;unexpected-block-close&#96;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      message</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#96;Unexpected block closing tag&#96;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125;);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125;</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-h3dtia">The next step is to read the JS expression. Since all logic blocks, <code class="inline">{#if}</code>, <code class="inline">{#each}</code> and <code class="inline">{#await}</code> will read the JS expression next, it is no different for <code class="inline">{#key}</code> and it is already taken care of:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-token-constant)">parser</span><span style="color: var(--shiki-token-function)">.require_whitespace</span><span style="color: var(--shiki-color-text)">();</span></span>
<span class="line dim"></span>
<span class="line dim"><span style="color: var(--shiki-token-comment)">// read the JS expression</span></span>
<span class="line highlight"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">expression</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">read_expression</span><span style="color: var(--shiki-color-text)">(parser);</span></span>
<span class="line dim"></span>
<span class="line dim"><span style="color: var(--shiki-token-comment)">// create the AST node</span></span>
<span class="line dim"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">TemplateNode</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> &#123;</span><span style="color: var(--shiki-token-keyword)">...</span><span style="color: var(--shiki-color-text)">&#125;;</span></span>
<span class="line dim"></span>
<span class="line dim"><span style="color: var(--shiki-token-constant)">parser</span><span style="color: var(--shiki-token-function)">.allow_whitespace</span><span style="color: var(--shiki-color-text)">();</span></span>
<span class="line dim"></span>
<span class="line dim"><span style="color: var(--shiki-token-comment)">// other logic blocks specific syntax</span></span>
<span class="line dim"><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (type </span><span style="color: var(--shiki-token-keyword)">===</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;EachBlock&#39;</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// &#123;#each&#125; block specific syntax for &#123;#each list as item&#125;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-fkq4tt">So, let&#39;s move on to the next step!</p></section> <section><h3 data-svelte-h="svelte-reg4hz"><a href="#tracking-references-and-dependencies" id="tracking-references-and-dependencies">Tracking references and dependencies</a></h3> <p data-svelte-h="svelte-vwpqrq">If you noticed in the previous step, the type name we created for <code class="inline">{#key}</code> block is called <code class="inline">KeyBlock</code>.</p> <p data-svelte-h="svelte-36ehsx">So, to keep the name consistent, we are going to create a <code class="inline">KeyBlock</code> class in <code class="inline">src/compiler/compile/nodes/KeyBlock.ts</code>:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">import</span><span style="color: var(--shiki-color-text)"> Expression </span><span style="color: var(--shiki-token-keyword)">from</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;./shared/Expression&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">import</span><span style="color: var(--shiki-color-text)"> map_children </span><span style="color: var(--shiki-token-keyword)">from</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;./shared/map_children&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">import</span><span style="color: var(--shiki-color-text)"> AbstractBlock </span><span style="color: var(--shiki-token-keyword)">from</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;./shared/AbstractBlock&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">export</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">default</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">class</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">KeyBlock</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">extends</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">AbstractBlock</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// for discriminant property for TypeScript to differentiate types</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  type</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;KeyBlock&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">  expression</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">Expression</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">constructor</span><span style="color: var(--shiki-color-text)">(component</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> parent</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> scope</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> info) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">super</span><span style="color: var(--shiki-color-text)">(component</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> parent</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> scope</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> info);</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// create an Expression instance for the expression</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.expression </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">new</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">Expression</span><span style="color: var(--shiki-color-text)">(component</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> scope</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">info</span><span style="color: var(--shiki-color-text)">.expression);</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// loop through children and create respective node instance</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.children </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">map_children</span><span style="color: var(--shiki-color-text)">(component</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> scope</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">info</span><span style="color: var(--shiki-color-text)">.children);</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// simple validation: make sure the block is not empty</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-token-function)">.warn_if_empty_block</span><span style="color: var(--shiki-color-text)">();</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-11ntoqe">I&#39;ve added comments annotating the code above, hopefully it&#39;s self-explanatory.</p> <p data-svelte-h="svelte-1wosu5z">A few more points:</p> <ul data-svelte-h="svelte-1cs5zc7"><li><code class="inline">info</code> is the AST node we got from the parsing.</li> <li>the <code class="inline">class Expression</code> is constructed with the JavaScript AST of the expression and it is where we traverse the AST and marked the variables within the expression as <code class="inline">referenced: true</code>.</li> <li><code class="inline">map_children</code> is used to map the <code class="inline">children</code> of the <code class="inline">KeyBlock</code> AST node to the compile node.</li></ul> <blockquote data-svelte-h="svelte-mq96i0"><p>Pardon for my lack of &quot;appropriate&quot; naming to differentiate the nodes in the Svelte codebase.</p> <p>Throughout the Svelte compilation process, the node is transformed one to another, which in every step of the transformation, new analysis is performed, and new information are added.</p> <p>Here, I am going to call:</p> <ul><li>the node resulting from the parser: <strong>AST node</strong></li> <li>the node created by the <code class="inline">Component</code>, which extends from <a href="https://github.com/sveltejs/svelte/blob/caebe0deb80d959ad7c7b5276d7e017be71769c7/src/compiler/compile/nodes/shared/Node.ts" rel="nofollow"><code class="inline">compiler/compile/nodes/shared/Node.ts</code></a>: <strong>compile node</strong> <em>(because they are stored in the <code class="inline">compile</code> folder)</em></li> <li>the node created by the <code class="inline">Renderer</code>, which extends from <a href="https://github.com/sveltejs/svelte/blob/2b2f40d32ae36a94b77b69959494687073a3ebbc/src/compiler/compile/render_dom/wrappers/shared/Wrapper.ts#L7" rel="nofollow"><code class="inline">compiler/compile/render_dom/wrappers/shared/Wrapper.ts</code></a>: <strong>render-dom Wrapper</strong> <em>(also because they are stored in the <code class="inline">render_dom/wrappers</code> folder)</em></li></ul></blockquote> <p data-svelte-h="svelte-1mwj5gz">If you managed to keep up so far, you may be sensing where we are heading next.</p> <p data-svelte-h="svelte-1uw2if6">We need to add <code class="inline">KeyBlock</code> into <code class="inline">map_children</code>:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-token-comment)">// src/compiler/compile/nodes/shared/map_children.ts</span></span>
<span class="line dim"><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">get_constructor</span><span style="color: var(--shiki-color-text)">(type) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">switch</span><span style="color: var(--shiki-color-text)"> (type) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">case</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;AwaitBlock&#39;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> AwaitBlock;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">case</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;Body&#39;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> Body;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">case</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;KeyBlock&#39;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> KeyBlock;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-ao8sn2">Also, we need to add <code class="inline">KeyBlock</code> as one of the <code class="inline">INode</code> type for TypeScript:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-token-comment)">// src/compiler/compile/nodes/interfaces.ts</span></span>
<span class="line dim"><span style="color: var(--shiki-token-keyword)">export</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">type</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">INode</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">|</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">Action</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">|</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">Animation</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">|</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">KeyBlock</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line dim"><span style="color: var(--shiki-token-comment)">// ...</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-56ioey">And now, let&#39;s move on to implementing a <strong>render-dom Wrapper</strong> for <code class="inline">KeyBlock</code>.</p></section> <section><h3 data-svelte-h="svelte-v7amfb"><a href="#creating-code-blocks-fragments" id="creating-code-blocks-fragments">Creating code blocks &amp; fragments</a></h3> <p data-svelte-h="svelte-1gm8xuh">At this point, we need to decide how the compiled JS should look like, it&#39;s time for us to <strong>reverse-compile Svelte in your head</strong>!</p> <p data-svelte-h="svelte-x9uxyc">If you&#39;ve read my <a href="/compile-svelte-in-your-head-part-4">Compile Svelte in your head (Part 4)</a>, you&#39;ve seen how we create a different <code class="inline">create_fragment</code> function for each of the logic branches, so we can control the content within a logic branch as a whole.</p> <p data-svelte-h="svelte-121ox0f">Similarly, we can create a <code class="inline">create_fragment</code> function for the content of the <code class="inline">{#key}</code>, then we can control when to create / mount / update / destroy the content.</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">create_key_block</span><span style="color: var(--shiki-color-text)">(ctx) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// instructions to create / mount / update / destroy inner content of &#123;#key&#125;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">c</span><span style="color: var(--shiki-color-text)">() &#123;&#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">m</span><span style="color: var(--shiki-color-text)">() &#123;&#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">p</span><span style="color: var(--shiki-color-text)">() &#123;&#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">d</span><span style="color: var(--shiki-color-text)">() &#123;&#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125;;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-6o5bc0">To use the <code class="inline">create_key_block</code>:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">key_block</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">create_key_block</span><span style="color: var(--shiki-color-text)">(ctx);</span></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// create the elements for the &#123;#key&#125;</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">key_block</span><span style="color: var(--shiki-token-function)">.c</span><span style="color: var(--shiki-color-text)">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// mount the elements in the &#123;#key&#125;</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">key_block</span><span style="color: var(--shiki-token-function)">.m</span><span style="color: var(--shiki-color-text)">(target</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> anchor);</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// update the elements in the &#123;#key&#125;</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">key_block</span><span style="color: var(--shiki-token-function)">.p</span><span style="color: var(--shiki-color-text)">(ctx</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> dirty);</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// destroy the elements in the &#123;#key&#125;</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">key_block</span><span style="color: var(--shiki-token-function)">.d</span><span style="color: var(--shiki-color-text)">(detaching);</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// intro &amp; outro the elements in the &#123;#key&#125;</span></span>
<span class="line"><span style="color: var(--shiki-token-function)">transition_in</span><span style="color: var(--shiki-color-text)">(key_block);</span></span>
<span class="line"><span style="color: var(--shiki-token-function)">transition_out</span><span style="color: var(--shiki-color-text)">(key_block);</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-tbzgfw">The next thing to do, is to place these statements in the right position:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">create_fragment</span><span style="color: var(--shiki-color-text)">(ctx) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// init</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">let</span><span style="color: var(--shiki-color-text)"> key_block </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">create_key_block</span><span style="color: var(--shiki-color-text)">(ctx);</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">c</span><span style="color: var(--shiki-color-text)">() &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-comment)">// create</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-constant)">key_block</span><span style="color: var(--shiki-token-function)">.c</span><span style="color: var(--shiki-color-text)">();</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">m</span><span style="color: var(--shiki-color-text)">(target</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> anchor) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-comment)">// mount</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-constant)">key_block</span><span style="color: var(--shiki-token-function)">.m</span><span style="color: var(--shiki-color-text)">(target</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> anchor);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">p</span><span style="color: var(--shiki-color-text)">(ctx</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> dirty) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-comment)">// update</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-constant)">key_block</span><span style="color: var(--shiki-token-function)">.p</span><span style="color: var(--shiki-color-text)">(ctx</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> dirty);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">i</span><span style="color: var(--shiki-color-text)">(local) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-comment)">// intro</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-function)">transition_in</span><span style="color: var(--shiki-color-text)">(key_block);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">o</span><span style="color: var(--shiki-color-text)">(local) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-comment)">// outro</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-function)">transition_out</span><span style="color: var(--shiki-color-text)">(key_block);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">d</span><span style="color: var(--shiki-color-text)">(detaching) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-comment)">// destroy</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-constant)">key_block</span><span style="color: var(--shiki-token-function)">.d</span><span style="color: var(--shiki-color-text)">(detaching);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125;;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-tdy34m">Now, the most important piece of the <code class="inline">{#key}</code> block, the logic to</p> <ul data-svelte-h="svelte-m8hq1x"><li>check if the expression has changed</li> <li>if so, recreate the elements inside the <code class="inline">{#key}</code> block</li></ul> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">create_fragment</span><span style="color: var(--shiki-color-text)">(ctx) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// we store the previous key expression value</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">let</span><span style="color: var(--shiki-color-text)"> previous_key </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> value_of_the_key_expression;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">p</span><span style="color: var(--shiki-color-text)">(ctx</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> dirty) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-comment)">// if the any variables within the key has changed, and</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        dirty </span><span style="color: var(--shiki-token-keyword)">&amp;</span><span style="color: var(--shiki-color-text)"> dynamic_variables_in_key_expression </span><span style="color: var(--shiki-token-keyword)">&amp;&amp;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-comment)">// if the value of the key expression has changed</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        previous_key </span><span style="color: var(--shiki-token-keyword)">!==</span><span style="color: var(--shiki-color-text)"> (previous_key </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> value_of_the_key_expression)</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      ) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-comment)">// destroy the elements</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-comment)">// detaching = 1 (true) to remove the elements immediately</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-constant)">key_block</span><span style="color: var(--shiki-token-function)">.d</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-constant)">1</span><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-comment)">// create a new key_block</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        key_block </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">create_key_block</span><span style="color: var(--shiki-color-text)">(ctx);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-constant)">key_block</span><span style="color: var(--shiki-token-function)">.c</span><span style="color: var(--shiki-color-text)">();</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-comment)">// mount the new key_block</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-constant)">key_block</span><span style="color: var(--shiki-token-function)">.m</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-keyword)">...</span><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      &#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-comment)">// if the key has not changed, make sure the content of &#123;#key&#125; is up to date</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-constant)">key_block</span><span style="color: var(--shiki-token-function)">.p</span><span style="color: var(--shiki-color-text)">();</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      &#125;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-wge6rr">If there is transition in the content of the <code class="inline">key_block</code>, we need extra code for the transition:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-comment)">// instead of key_block.d(1);</span></span>
<span class="line"><span style="color: var(--shiki-token-function)">group_outros</span><span style="color: var(--shiki-color-text)">();</span></span>
<span class="line"><span style="color: var(--shiki-token-function)">transition_out</span><span style="color: var(--shiki-color-text)">(key_block</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">1</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">1</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> noop);</span></span>
<span class="line"><span style="color: var(--shiki-token-function)">check_outros</span><span style="color: var(--shiki-color-text)">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// before key_block.m(...)</span></span>
<span class="line"><span style="color: var(--shiki-token-function)">transition_in</span><span style="color: var(--shiki-color-text)">(key_block);</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-i8jvdo">I am going to gloss over the details of how <code class="inline">outros</code> / <code class="inline">intros</code> work, we will cover them in the later parts of &quot;Compile Svelte in your head&quot;, so let&#39;s assume these code are up for the job.</p> <p data-svelte-h="svelte-endjd4">Now we have done the reverse-compile Svelte in your head, let&#39;s reverse the reverse, and write the render code for Svelte <code class="inline">{#key}</code> block.</p> <p data-svelte-h="svelte-1wxkcum">Here are some setup code for the render-dom Wrapper for <code class="inline">{#key}</code>:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">export</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">default</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">class</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">KeyBlockWrapper</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">extends</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">Wrapper</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// the &#96;key_block&#96; variable</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  var</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">Identifier</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> &#123; type</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;Identifier&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> name</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;key_block&#39;</span><span style="color: var(--shiki-color-text)"> &#125;;</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">constructor</span><span style="color: var(--shiki-color-text)">(renderer</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">Renderer</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> block</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">Block</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> parent</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">Wrapper</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> node</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">EachBlock</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> strip_whitespace</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">boolean</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> next_sibling</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">Wrapper</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">super</span><span style="color: var(--shiki-color-text)">(renderer</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> block</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> parent</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> node);</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// deoptimisation, set flag indicate the content is not static</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-token-function)">.cannot_use_innerhtml</span><span style="color: var(--shiki-color-text)">();</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-token-function)">.not_static_content</span><span style="color: var(--shiki-color-text)">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// get all the dynamic variables within the expression</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// useful for later</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.dependencies </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">node</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">expression</span><span style="color: var(--shiki-token-function)">.dynamic_dependencies</span><span style="color: var(--shiki-color-text)">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// create a new &#96;create_fragment&#96; function</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.block </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.child</span><span style="color: var(--shiki-color-text)">(&#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      comment</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">create_debugging_comment</span><span style="color: var(--shiki-color-text)">(node</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">renderer</span><span style="color: var(--shiki-color-text)">.component)</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      name</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">renderer</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">component</span><span style="color: var(--shiki-token-function)">.get_unique_name</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&#39;create_key_block&#39;</span><span style="color: var(--shiki-color-text)">)</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      type</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;key&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125;);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">renderer</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">blocks</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(block);</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// create render-dom Wrappers for the children</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.fragment </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">new</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">FragmentWrapper</span><span style="color: var(--shiki-color-text)">(renderer</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.block</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">node</span><span style="color: var(--shiki-color-text)">.children</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> parent</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> strip_whitespace</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> next_sibling);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-function)">render</span><span style="color: var(--shiki-color-text)">(block</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">Block</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> parent_node</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">Identifier</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> parent_nodes</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">Identifier</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// NOTE: here is where we write the render code</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-1wosu5z">A few more points:</p> <ul data-svelte-h="svelte-w72svt"><li>the <code class="inline">block</code> in the <code class="inline">render</code> method is the current <code class="inline">create_fragment</code> function that the <code class="inline">{#key}</code> block is in; <code class="inline">this.block</code> is the new <code class="inline">create_fragment</code> function that we created to put the content of the <code class="inline">{#key}</code> block<ul><li>we named the new <code class="inline">create_fragment</code> function <code class="inline">&quot;create_key_block&quot;</code></li> <li>to make sure there&#39;s no conflicting names, we use <code class="inline">renderer.component.get_unique_name()</code></li></ul></li> <li>All <strong>render-dom wrappers</strong> has a property named <code class="inline">var</code>, which is the variable name referencing the element / block to be created by the <strong>render-dom wrapper</strong>.<ul><li>the <code class="inline">var</code> name will be <a href="https://github.com/sveltejs/svelte/blob/8148a7a33444805320923e4c4e071f62dee3df6c/src/compiler/compile/render_dom/Block.ts#L118-L152" rel="nofollow">deconflicted by the Renderer</a></li></ul></li></ul> <p data-svelte-h="svelte-zcm4g9">Now, let&#39;s implement the <code class="inline">render</code> method.</p> <p data-svelte-h="svelte-1totel9">Firstly, render the children into <code class="inline">this.block</code>:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-token-function)">render</span><span style="color: var(--shiki-color-text)">(block: Block</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> parent_node: Identifier</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> parent_nodes: Identifier) &#123;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">fragment</span><span style="color: var(--shiki-token-function)">.render</span><span style="color: var(--shiki-color-text)">(</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.block</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">null</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">    (</span><span style="color: var(--shiki-token-function)">x</span><span style="color: var(--shiki-token-string-expression)">&#96;#nodes&#96;</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">as</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">unknown</span><span style="color: var(--shiki-color-text)">) </span><span style="color: var(--shiki-token-keyword)">as</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">Identifier</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  );</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-1mjeduw">We pass in <code class="inline">null</code> as <code class="inline">parent_node</code> and <code class="inline">x`#nodes`</code> as <code class="inline">parent_nodes</code> to indicate that the children will be rendered at the root of the <code class="inline">this.block</code>.</p> <hr> <p data-svelte-h="svelte-nj91qk">If I am implementing the <code class="inline">render</code> method of an Element render-dom Wrapper, and currently rendering the <code class="inline">&lt;div&gt;</code> in the following code snippet:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-color-text)">&lt;</span><span style="color: var(--shiki-token-string-expression)">div</span><span style="color: var(--shiki-color-text)">&gt;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &lt;</span><span style="color: var(--shiki-token-string-expression)">span</span><span style="color: var(--shiki-color-text)"> /&gt;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&lt;/</span><span style="color: var(--shiki-token-string-expression)">div</span><span style="color: var(--shiki-color-text)">&gt;</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-vkswtg">then I will render the <code class="inline">&lt;span /&gt;</code> with:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-constant)">spanWrapper</span><span style="color: var(--shiki-token-function)">.render</span><span style="color: var(--shiki-color-text)">(</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  block</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-comment)">// div&#39;s var</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-function)">x</span><span style="color: var(--shiki-token-string-expression)">&#96;</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">var</span><span style="color: var(--shiki-color-text)">.name</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.childNodes&#96;</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-comment)">// div.childNodes</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">);</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-1g9m0ct">so the <code class="inline">&lt;span /&gt;</code> will be inserted into the current <code class="inline">&lt;div /&gt;</code> and hydrate from the <code class="inline">&lt;div /&gt;</code>&#39;s childNodes.</p> <hr> <p data-svelte-h="svelte-1w9wg06">Next, I am going to insert code into each of the fragment methods:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-comment)">// let key_block = create_key_block(ctx);</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">init</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;let </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)"> = </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-color-text)">.name</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">(#ctx)&#96;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// key_block.c();</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">create</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.c();&#96;</span><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// key_block.m(...);</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">mount</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.m(</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">parent_node </span><span style="color: var(--shiki-token-keyword)">||</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&quot;#target&quot;</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">, </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">parent_node </span><span style="color: var(--shiki-token-keyword)">?</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&quot;null&quot;</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&quot;#anchor&quot;</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">);&#96;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// key_block.p(...);</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">update</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.p(#ctx, #dirty);&#96;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// key_block.d(...);</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">destroy</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.d(detaching)&#96;</span><span style="color: var(--shiki-color-text)">);</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-1wosu5z">A few more points:</p> <ul data-svelte-h="svelte-1dactz4"><li>we push the code into respective methods of the <code class="inline">block</code>, eg: <code class="inline">init</code>, <code class="inline">create</code>, <code class="inline">mount</code>, ...</li> <li>we use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals#Tagged_templates" rel="nofollow">tagged templates</a>, <code class="inline">b`...`</code> to create a JavaScript AST node. The <code class="inline">b</code> tag function allow us to pass in JavaScript AST node as placeholder, so that is very convenient.<ul><li>You can check out more about the <code class="inline">b</code> tag function from <a href="https://github.com/Rich-Harris/code-red" rel="nofollow">code-red</a></li></ul></li></ul> <p data-svelte-h="svelte-axnm6c">Now, to implement the dirty checking, we use <code class="inline">this.dependencies</code></p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">is_dirty</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">renderer</span><span style="color: var(--shiki-token-function)">.dirty</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.dependencies);</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-a82gse">To determine whether our expression value has changed, we are going to compute the expression and compare it with <code class="inline">previous_key</code> and determine whether it has changed.</p> <p data-svelte-h="svelte-1kqoyh6">Here&#39;s a recap of the compiled code that we&#39;ve come up previously:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-comment)">// we store the previous key expression value</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">let</span><span style="color: var(--shiki-color-text)"> previous_key </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> value_of_the_key_expression;</span></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// if the value of the key expression has changed</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">previous_key </span><span style="color: var(--shiki-token-keyword)">!==</span><span style="color: var(--shiki-color-text)"> (previous_key </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> value_of_the_key_expression)</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-lru3e0">We start with declaring the variable, <code class="inline">previous_key</code>:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">previous_key</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.get_unique_name</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&#39;previous_key&#39;</span><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">snippet</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">node</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">expression</span><span style="color: var(--shiki-token-function)">.manipulate</span><span style="color: var(--shiki-color-text)">(block);</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.add_variable</span><span style="color: var(--shiki-color-text)">(previous_key</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> snippet);</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-9ikqht"><code class="inline">expression.manipulate(block)</code> will convert the expression to refer to the <code class="inline">ctx</code> variable, for example:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-constant)">human</span><span style="color: var(--shiki-color-text)">.age </span><span style="color: var(--shiki-token-keyword)">+</span><span style="color: var(--shiki-color-text)"> limit</span></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// into something like</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">ctx[</span><span style="color: var(--shiki-token-constant)">0</span><span style="color: var(--shiki-color-text)">].age </span><span style="color: var(--shiki-token-keyword)">+</span><span style="color: var(--shiki-color-text)"> ctx[</span><span style="color: var(--shiki-token-constant)">2</span><span style="color: var(--shiki-color-text)">]</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-1xpyy9c">Next we are going to compare the new value and assign it to <code class="inline">previous_key</code> after that.</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">has_change</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">x</span><span style="color: var(--shiki-token-string-expression)">&#96;</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">previous_key</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)"> !== (</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">previous_key</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)"> = </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">snippet</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">)&#96;</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-1bjjaay">And to combine all of these, we have:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">update</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">  if (</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">is_dirty</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)"> &amp;&amp; </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">has_change</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">    </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.d(1);</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">    </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)"> = </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-color-text)">.name</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">(#ctx);</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">    </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.c();</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">    </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.m(</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-token-function)">.get_update_mount_node</span><span style="color: var(--shiki-color-text)">(anchor)</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">, </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">anchor</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">);</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">  &#125; else &#123;</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">    </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.p(#ctx, #dirty);</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">  &#125;</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">&#96;</span><span style="color: var(--shiki-color-text)">);</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-1m7kbpf">We are using the <code class="inline">anchor</code> when we are mounting the new <code class="inline">key_block</code>, you can check out <a href="/compile-svelte-in-your-head-part-4/#the-extra-text-node">Compile Svelte in your head Part 4: the extra text node</a>, explaining why we need the anchor node, and here is how the anchor node being computed:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">anchor</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-token-function)">.get_or_create_anchor</span><span style="color: var(--shiki-color-text)">(block</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> parent_node</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> parent_nodes);</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-yntp1w">It could be the next sibling, or it could be a new <code class="inline">empty()</code> text node created.</p> <p data-svelte-h="svelte-17ojmqz">Finally, if the content has transition, we need to add code for the transition as well:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">has_transitions</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">!!</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-color-text)">.has_intro_method </span><span style="color: var(--shiki-token-keyword)">||</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-color-text)">.has_outro_method);</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">transition_out</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">  @group_outros();</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">  @transition_out(</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">, 1, 1, @noop);</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">  @check_outros();</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">&#96;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">transition_in</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">  @transition_in(</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">);</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">&#96;</span><span style="color: var(--shiki-color-text)">;</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-1nhmsbz">Where to place them? Well, I&#39;ll leave that as your exercise to figure that out. 😉</p></section> <section><h3 data-svelte-h="svelte-k2lf1h"><a href="#creating-code-for-ssr" id="creating-code-for-ssr">Creating code for SSR</a></h3> <p data-svelte-h="svelte-6650y8">For SSR, it is much simpler than for the <code class="inline">dom</code>. <code class="inline">{#key}</code> block has no special meaning in SSR, because, you will only render once in SSR:</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">import</span><span style="color: var(--shiki-color-text)"> KeyBlock </span><span style="color: var(--shiki-token-keyword)">from</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;../../nodes/KeyBlock&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">import</span><span style="color: var(--shiki-color-text)"> Renderer</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> &#123; RenderOptions &#125; </span><span style="color: var(--shiki-token-keyword)">from</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;../Renderer&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">export</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">default</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)">(node</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">KeyBlock</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> renderer</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">Renderer</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> options</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">RenderOptions</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">	</span><span style="color: var(--shiki-token-constant)">renderer</span><span style="color: var(--shiki-token-function)">.render</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-constant)">node</span><span style="color: var(--shiki-color-text)">.children</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> options);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!-- HTML_TAG_END --></div> <p data-svelte-h="svelte-f4fe3s">☝️ That&#39;s all the code we need for SSR. We are rendering the children, passing down the <code class="inline">options</code>, and add no extra code for the <code class="inline">{#key}</code> block.</p></section> <section data-svelte-h="svelte-9sbh81"><h3><a href="#generate-code" id="generate-code">Generate code</a></h3> <p>Well, everything in this step is set up generic enough to handle most use case.</p> <p>So, nothing to change here. 🤷‍♂️</p></section> <section data-svelte-h="svelte-140znc9"><h3><a href="#a-few-other-implementation-consideration" id="a-few-other-implementation-consideration">A few other implementation consideration</a></h3> <ul><li>What if the expression in the <code class="inline">{#key}</code> block is not dynamic, do we give warnings? or optimise the output?</li> <li>How will <a href="https://svelte.dev/docs#svelte_options" rel="nofollow"><code class="inline">&lt;svelte:options immutable={true}&gt;</code></a> affect the code output?</li></ul></section> <section><h2 data-svelte-h="svelte-18doo65"><a href="#the-testing" id="the-testing">The testing</a></h2> <p data-svelte-h="svelte-micnsq">You&#39;ve seen me implementing test cases in the previous &quot;Contributing to Svelte&quot; articles [<a href="/contributing-to-svelte-fixing-issue-5012">1</a>] [<a href="/contributing-to-svelte-fixing-issue-4392">2</a>], here I am going to skip showing the implementation of the test cases, and probably point out some thoughts I had when coming up with tests:</p> <ol><li data-svelte-h="svelte-14ceemi"><p><strong>Happy path:</strong> changing the key expression should recreate the content</p></li> <li data-svelte-h="svelte-1kyw606"><p><strong>Happy path:</strong> Transition when recreating the content should work ✨</p></li> <li><p data-svelte-h="svelte-105kmeo"><strong>Possible edge case:</strong> Changing variables other than the key expression should <strong>not</strong> recreate the content in <code class="inline">{#key}</code></p> <div class="code-section"><!-- HTML_TAG_START --><pre class="prism language-svelte"><code><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"></div><div class="line">  <span class="token keyword">let</span> reactive1<span class="token punctuation">;</span></div><div class="line">  <span class="token keyword">let</span> reactive2<span class="token punctuation">;</span></div><div class="line">  <span class="token keyword">let</span> key<span class="token punctuation">;</span></div><div class="line"></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></div><div class="line"></div><div class="line"><span class="token language-javascript"><span class="token punctuation">&#123;</span>#key key<span class="token punctuation">&#125;</span></span></div><div class="line">   <span class="token language-javascript"><span class="token punctuation">&#123;</span>key<span class="token punctuation">&#125;</span></span> <span class="token language-javascript"><span class="token punctuation">&#123;</span>reactive1<span class="token punctuation">&#125;</span></span></div><div class="line"><span class="token language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">/</span>key<span class="token punctuation">&#125;</span></span></div><div class="line"></div><div class="line"><span class="token language-javascript"><span class="token punctuation">&#123;</span>reactive2<span class="token punctuation">&#125;</span></span></div></code></pre><!-- HTML_TAG_END --></div></li> <li><p data-svelte-h="svelte-14fac6i"><strong>Possible edge case:</strong> Changing the variables within the key expression but the result value of the key expression stay the same</p> <div class="code-section"><!-- HTML_TAG_START --><pre class="prism language-svelte"><code><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"></div><div class="line">   <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></div><div class="line">   <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></div><div class="line">   <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></div><div class="line">     a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></div><div class="line">     b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></div><div class="line">   <span class="token punctuation">&#125;</span></div><div class="line"></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></div><div class="line"><span class="token language-javascript"><span class="token punctuation">&#123;</span>#key a <span class="token operator">+</span> b<span class="token punctuation">&#125;</span></span></div><div class="line">   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token punctuation">/></span></span></div><div class="line"><span class="token language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">/</span>key<span class="token punctuation">&#125;</span></span></div></code></pre><!-- HTML_TAG_END --></div></li></ol></section> <section data-svelte-h="svelte-5pgbuu"><h2><a href="#closing-notes" id="closing-notes">Closing Notes</a></h2> <p>You can read the <a href="https://github.com/sveltejs/svelte/pull/5397" rel="nofollow">Pull Request #5397</a> to read the final implementation.</p> <hr> <p>If you wish to learn more about Svelte, <a href="https://twitter.com/lihautan" rel="nofollow">follow me on Twitter</a>.</p> <p>If you have anything unclear about this article, find me on <a href="https://twitter.com/lihautan" rel="nofollow">Twitter</a> too!</p></section></article> <div style="height: 1px; width: 100%"></div> </main> <footer class="svelte-1x8iuzz"> </footer> 
			
			<script>
				{
					__sveltekit_lzgyl9 = {
						base: new URL(".", location).pathname.slice(0, -1),
						assets: "https://lihautan.com"
					};

					const element = document.currentScript.parentElement;

					const data = [null,null,null];

					Promise.all([
						import("https://lihautan.com/_app/immutable/entry/start.CVysmP4c.js"),
						import("https://lihautan.com/_app/immutable/entry/app.Bk7PW2KV.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 2, 26],
							data,
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
