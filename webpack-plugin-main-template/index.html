<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="x-ua-compatible" content="ie=edge" />
  	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
		<link rel="preconnect dns-prefetch" href="https://www.google-analytics.com" />
	  <link rel="preconnect dns-prefetch" href="https://fonts.googleapis.com" />
		<link href="https://twitter.com/lihautan" rel="me" />
  	<link rel="manifest" href="/manifest.webmanifest" />
		<meta name="theme-color" content="#bd93f9" />
		<link rel="apple-touch-icon" sizes="48x48" href="/icon-48x48.png" />
		<link rel="apple-touch-icon" sizes="72x72" href="/icon-72x72.png" />
		<link rel="apple-touch-icon" sizes="96x96" href="/icon-96x96.png" />
		<link rel="apple-touch-icon" sizes="144x144" href="/icon-144x144.png" />
		<link rel="apple-touch-icon" sizes="192x192" href="/icon-192x192.png" />
		<link rel="apple-touch-icon" sizes="256x256" href="/icon-256x256.png" />
		<link rel="apple-touch-icon" sizes="384x384" href="/icon-384x384.png" />
		<link rel="apple-touch-icon" sizes="512x512" href="/icon-512x512.png" />
		<link rel="icon" href="/icon-48x48.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="preconnect dns-prefetch" href="https://fonts.googleapis.com" />
		<link rel="preload"
			href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,400;0,500;0,700;1,300&display=swap" as="style"
			onload="this.rel='stylesheet'">
		<link rel="alternate" type="application/rss+xml" title="Tan Li Hau&#x27;s RSS Feed" href="/rss.xml"/>
		<link rel="sitemap" type="application/xml" href="/sitemap.xml"/>
		<link rel="webmention" href="https://webmention.io/lihautan.com/webmention" />
		<link rel="pingback" href="https://webmention.io/lihautan.com/xmlrpc" />
		<meta http-equiv="content-security-policy" content=""><title>Webpack&#39;s TemplatePlugin | Tan Li Hau</title><meta name="description" content="If you are using webpack to bundle your library, you most likely will export something in your entry file:And if you build it with webpack just like that, out-of-the-box, you may be surprised that if you try to ..." data-svelte="svelte-1vzsqtc"><meta name="image" content="/_app/assets/twitter-card-image-fec9b660.jpg" data-svelte="svelte-1vzsqtc"><meta name="og:image" content="/_app/assets/twitter-card-image-fec9b660.jpg" data-svelte="svelte-1vzsqtc"><meta name="og:title" content="Webpack&#39;s TemplatePlugin" data-svelte="svelte-1vzsqtc"><meta name="og:description" content="If you are using webpack to bundle your library, you most likely will export something in your entry file:And if you build it with webpack just like that, out-of-the-box, you may be surprised that if you try to ..." data-svelte="svelte-1vzsqtc"><meta name="og:type" content="website" data-svelte="svelte-1vzsqtc"><meta name="twitter:card" content="summary_large_image" data-svelte="svelte-1vzsqtc"><meta name="twitter:creator" content="@lihautan" data-svelte="svelte-1vzsqtc"><meta name="twitter:title" content="Webpack&#39;s TemplatePlugin" data-svelte="svelte-1vzsqtc"><meta name="twitter:description" content="If you are using webpack to bundle your library, you most likely will export something in your entry file:And if you build it with webpack just like that, out-of-the-box, you may be surprised that if you try to ..." data-svelte="svelte-1vzsqtc"><meta name="twitter:image" content="/_app/assets/twitter-card-image-fec9b660.jpg" data-svelte="svelte-1vzsqtc"><meta itemprop="url" content="https://lihautan.com/webpack-plugin-main-template/" data-svelte="svelte-1vzsqtc"><meta itemprop="image" content="/_app/assets/twitter-card-image-fec9b660.jpg" data-svelte="svelte-1vzsqtc">
	<link rel="stylesheet" href="/_app/assets/vendor-cb7fd1e3.css">
	<link rel="stylesheet" href="/_app/assets/pages/__layout.svelte-68f4428f.css">
	<link rel="stylesheet" href="/_app/assets/Links-80fbd6f2.css">
	<link rel="stylesheet" href="/_app/assets/code-snippet-f592027d.css">
	<link rel="stylesheet" href="/_app/assets/BlogLayout-3d74e761.css">
	<link rel="stylesheet" href="/_app/assets/WebMentions-97df5d68.css">
	<link rel="stylesheet" href="/_app/assets/TableOfContent-9d27b0ce.css">
	<link rel="modulepreload" href="/_app/start-51123d14.js">
	<link rel="modulepreload" href="/_app/chunks/vendor-569a3c5c.js">
	<link rel="modulepreload" href="/_app/pages/__layout.svelte-9b1df45b.js">
	<link rel="modulepreload" href="/_app/chunks/stores-ee936cd4.js">
	<link rel="modulepreload" href="/_app/chunks/Links-7bd4e938.js">
	<link rel="modulepreload" href="/_app/pages/webpack-plugin-main-template/index.md-2c39eae6.js">
	<link rel="modulepreload" href="/_app/chunks/BlogLayout-17b76cb2.js">
	<link rel="modulepreload" href="/_app/chunks/WebMentions-968cc380.js">
	<link rel="modulepreload" href="/_app/chunks/TableOfContent-dbc18cb8.js">
	<link rel="modulepreload" href="/_app/chunks/twitter-card-image-a57df29d.js">
	</head>
	<body>
		<div id="svelte">


<a href="#content" class="skip svelte-70a8h7">Skip to content</a>

	<header class="svelte-70a8h7"><nav><ul class="mode-sidebar svelte-1hc74yu"><li class="svelte-1hc74yu"><a href="/" class="svelte-1hc74yu">Tan Li Hau</a></li>
	<li class="svelte-1hc74yu"><a href="/about" class="svelte-1hc74yu">About</a></li>
	<li class="svelte-1hc74yu"><a href="/blogs" class="svelte-1hc74yu">Writings</a></li>
	<li class="svelte-1hc74yu"><a href="/talks" class="svelte-1hc74yu">Talks</a></li>
	<li class="svelte-1hc74yu"><a href="/notes" class="svelte-1hc74yu">Notes</a></li>
	<li class="svelte-1hc74yu"><a href="/newsletter" class="svelte-1hc74yu">Newsletter</a></li>
	<li class="social svelte-1hc74yu"><a aria-label="Twitter account" href="https://twitter.com/lihautan" class="svelte-1hc74yu"><svg viewBox="0 0 24 24" width="1em" height="1em" class="svelte-1hc74yu"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66
  10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5
  4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a>
		<a aria-label="Github account" href="https://github.com/tanhauhau" class="svelte-1hc74yu"><svg viewBox="0 0 24 24" width="1em" height="1em" class="svelte-1hc74yu"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0
  0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07
  5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65
  5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42
  3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a>
		<a aria-label="YouTube account" href="https://youtube.com/c/lihautan" class="svelte-1hc74yu"><svg viewBox="0 0 461.001 461.001" width="1em" height="1em" class="svelte-1hc74yu"><path d="M365.257 67.393H95.744C42.866 67.393 0 110.259 0 163.137v134.728c0 52.878 42.866 95.744 95.744 95.744h269.513c52.878 0 95.744-42.866 95.744-95.744V163.137c0-52.878-42.866-95.744-95.744-95.744zm-64.751 169.663-126.06 60.123c-3.359 1.602-7.239-.847-7.239-4.568V168.607c0-3.774 3.982-6.22 7.348-4.514l126.06 63.881c3.748 1.899 3.683 7.274-.109 9.082z"></path></svg></a></li>
</ul></nav></header>

<main id="content" class="svelte-70a8h7">

<h1>Webpack&#39;s TemplatePlugin</h1>





<article class="blog"><section role="navigation" aria-label="Table of Contents" class="svelte-j01zi8"><ol class="svelte-j01zi8"><li class="svelte-j01zi8"><a href="#webpack-s-output-library-options" class="svelte-j01zi8">Webpack&#39;s output.library *  options</a>
				<ol class="svelte-j01zi8"><li class="svelte-j01zi8"><a href="#1-name-of-a-module-system-commonjs-commonjs2-amd-umd" class="svelte-j01zi8">1. Name of a module system:  `&quot;commonjs&quot;` ,  `&quot;commonjs2&quot;` ,  `&quot;amd&quot;` ,  `&quot;umd&quot;` , ...</a>
								
							</li><li class="svelte-j01zi8"><a href="#2-name-of-a-variable-var-this-self-window-global" class="svelte-j01zi8">2. Name of a variable:  `&quot;var&quot;` ,  `&quot;this&quot;` ,  `&quot;self&quot;` ,  `&quot;window&quot;` ,  `&quot;global&quot;`</a>
								
							</li>
					</ol>
			</li><li class="svelte-j01zi8"><a href="#writing-a-webpack-plugin" class="svelte-j01zi8">Writing a webpack plugin</a>
				
			</li><li class="svelte-j01zi8"><a href="#closing-note" class="svelte-j01zi8">Closing Note</a>
				
			</li></ol>
</section>
<p>If you are using webpack to bundle your library, you most likely will export something in your entry file:</p>
<div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-comment)">// weback.config.js</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">module</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">exports</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  entry</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;./src/index.js&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;;</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// src/index.js</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">export</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">default</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;foo&#39;</span><span style="color: var(--shiki-color-text)">;</span></span></code></pre><!-- HTML_TAG_END --></div>
<p>And if you build it with webpack just like that, out-of-the-box, you may be surprised that if you try to <code class="inline">require()</code> the built file, you would find that there&#39;s nothing being exported by the built file.</p>
<div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">foo</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">require</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&#39;./dist/bundle.js&#39;</span><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">console</span><span style="color: var(--shiki-token-function)">.log</span><span style="color: var(--shiki-color-text)">(foo); </span><span style="color: var(--shiki-token-comment)">// prints &#96;&#123;&#125;&#96; (empty object)</span></span></code></pre><!-- HTML_TAG_END --></div>
<p>If you&#39;ve read <a href="/i-wrote-my-module-bundler/">my previous article on writing a module bundler</a>, you can imagine that the output bundle looks something like this:</p>
<div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-comment)">// dist/bundle.js</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">webpackStart</span><span style="color: var(--shiki-color-text)">(&#123; moduleMap</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> entryPoint &#125;) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">require</span><span style="color: var(--shiki-color-text)">(entryPoint);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;)(&#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-string-expression)">&#39;src/index.js&#39;</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)">(exports</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> require) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">exports</span><span style="color: var(--shiki-color-text)">.default </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;foo&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;);</span></span></code></pre><!-- HTML_TAG_END --></div>
<p><em>(Everything should be familiar, except the fact that instead of calling <code class="inline">webpackStart</code> in a separate statement, I made it into a IIFE (Immediately Invoked Function Expression) for reasons that will be apparent later)</em></p>
<p>In order to build for a library, ie: to expose whatever is exported by the entry file, webpack provides 3 options that you can play with:</p>
<ul><li><a href="https://webpack.js.org/configuration/output/#outputlibrary" rel="nofollow">output.library</a></li>
<li><a href="https://webpack.js.org/configuration/output/#outputlibraryexport" rel="nofollow">output.libraryExport</a></li>
<li><a href="https://webpack.js.org/configuration/output/#outputlibrarytarget" rel="nofollow">output.libraryTarget</a></li></ul>
<section><h2><a href="#webpack-s-output-library-options" id="webpack-s-output-library-options">Webpack&#39;s output.library* options</a></h2>
<p>To understand how each of them works, let&#39;s start with <code class="inline">output.libraryTarget</code>.</p>
<p><code class="inline">output.libraryTarget</code> accepts <code class="inline">string</code> as value, there are 2 main groups of values that you can provide to the <code class="inline">output.libraryTarget</code> option:</p></section>
<section><h3><a href="#1-name-of-a-module-system-commonjs-commonjs2-amd-umd" id="1-name-of-a-module-system-commonjs-commonjs2-amd-umd">1. Name of a module system: <code class="inline">&quot;commonjs&quot;</code>, <code class="inline">&quot;commonjs2&quot;</code>, <code class="inline">&quot;amd&quot;</code>, <code class="inline">&quot;umd&quot;</code>, ...</a></h3>
<p>Webpack allows you to specify the name of the module system that you want to use to expose the exported values of the entry file.</p>
<p>You can specify a module system that is different from the one that you are using in your library.</p>
<p>Let&#39;s try <code class="inline">commonjs2</code> as an example:</p>
<div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-token-comment)">// webpack.config.js</span></span>
<span class="line dim"><span style="color: var(--shiki-token-constant)">module</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">exports</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  libraryTarget</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;commonjs2&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;;</span></span>
<span class="line dim"><span style="color: var(--shiki-token-comment)">// dist/bundle.js</span></span>
<span class="line highlight"><span style="color: var(--shiki-token-constant)">module</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">exports</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">webpackStart</span><span style="color: var(--shiki-color-text)">(&#123; moduleMap</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> entryPoint &#125;) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">require</span><span style="color: var(--shiki-color-text)">(entryPoint);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;)(&#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-string-expression)">&#39;src/index.js&#39;</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)">(exports</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> require) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">exports</span><span style="color: var(--shiki-color-text)">.default </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;foo&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;);</span></span></code></pre><!-- HTML_TAG_END --></div>
<p><code class="inline">commonjs2</code> uses <code class="inline">module.exports</code> to export values from a module. In this example, webpack assigns the return value of the IIFE to <code class="inline">module.exports</code>.</p>
<p>If you look at the bundled code, it is not much different than the one without specifying <code class="inline">output.libraryTarget</code>. The only difference is that the bundled code is prefixed with <code class="inline">module.exports =</code>;</p>
<blockquote><p>By the way, if you are curious about the difference between commonjs and commonjs2, you can follow the thread of <a href="https://github.com/webpack/webpack/issues/1114" rel="nofollow">this issue</a>.</p></blockquote></section>
<section><h3><a href="#2-name-of-a-variable-var-this-self-window-global" id="2-name-of-a-variable-var-this-self-window-global">2. Name of a variable: <code class="inline">&quot;var&quot;</code>, <code class="inline">&quot;this&quot;</code>, <code class="inline">&quot;self&quot;</code>, <code class="inline">&quot;window&quot;</code>, <code class="inline">&quot;global&quot;</code></a></h3>
<p>On the other hand, instead of exposing the library content through a module system, you can specify the variable name which the export object is assigned to.</p>
<p>Let&#39;s take <code class="inline">self</code> as an example:</p>
<div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-token-comment)">// webpack.config.js</span></span>
<span class="line dim"><span style="color: var(--shiki-token-constant)">module</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">exports</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  libraryTarget</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;self&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;;</span></span>
<span class="line dim"><span style="color: var(--shiki-token-comment)">// dist/bundle.js</span></span>
<span class="line highlight"><span style="color: var(--shiki-token-constant)">Object</span><span style="color: var(--shiki-token-function)">.assign</span><span style="color: var(--shiki-color-text)">(</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  self</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  (</span><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">webpackStart</span><span style="color: var(--shiki-color-text)">(&#123; moduleMap</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> entryPoint &#125;) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">require</span><span style="color: var(--shiki-color-text)">(entryPoint);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125;)(&#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-string-expression)">&#39;src/index.js&#39;</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)">(exports</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> require) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-constant)">exports</span><span style="color: var(--shiki-color-text)">.default </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;foo&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125;)</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line dim"><span style="color: var(--shiki-token-comment)">// self.default === &#39;foo&#39;</span></span></code></pre><!-- HTML_TAG_END --></div>
<p>All the exported values are assigned to <code class="inline">self</code>.</p>
<p>Again observe the bundled code, this time round we prefixed the bundled code with <code class="inline">Object.assign(self,</code> and suffixed it with <code class="inline">);</code>.</p>
<p>Specifiying the <code class="inline">output.libraryTarget</code> as <code class="inline">var</code> on the other hand, allows you to assign it to a variable name, which you can provide in <code class="inline">output.library</code> option:</p>
<div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-token-comment)">// webpack.config.js</span></span>
<span class="line dim"><span style="color: var(--shiki-token-constant)">module</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">exports</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  library</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;myApp&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  libraryTarget</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;var&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;;</span></span>
<span class="line dim"></span>
<span class="line dim"><span style="color: var(--shiki-token-comment)">// dist/bundle.js</span></span>
<span class="line highlight"><span style="color: var(--shiki-token-keyword)">var</span><span style="color: var(--shiki-color-text)"> myApp </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">webpackStart</span><span style="color: var(--shiki-color-text)">(&#123; moduleMap</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> entryPoint &#125;) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">require</span><span style="color: var(--shiki-color-text)">(entryPoint);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;)(&#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-string-expression)">&#39;src/index.js&#39;</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)">(exports</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> require) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">exports</span><span style="color: var(--shiki-color-text)">.default </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;foo&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;);</span></span>
<span class="line dim"></span>
<span class="line dim"><span style="color: var(--shiki-token-comment)">// myApp === &#123; default: &#39;foo&#39; &#125;</span></span></code></pre><!-- HTML_TAG_END --></div>
<p>If you don&#39;t want <code class="inline">myApp</code> to contain all the exported value of the entry file, you can provide the key that you want to export only in the <code class="inline">output.libraryExport</code> option:</p>
<div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-token-comment)">// webpack.config.js</span></span>
<span class="line dim"><span style="color: var(--shiki-token-constant)">module</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">exports</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  library</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;myApp&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  libraryTarget</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;var&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  libraryExport</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;default&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;;</span></span>
<span class="line dim"></span>
<span class="line dim"><span style="color: var(--shiki-token-comment)">// dist/bundle.js</span></span>
<span class="line dim"><span style="color: var(--shiki-token-keyword)">var</span><span style="color: var(--shiki-color-text)"> myApp </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">webpackStart</span><span style="color: var(--shiki-color-text)">(&#123; moduleMap</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> entryPoint &#125;) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">require</span><span style="color: var(--shiki-color-text)">(entryPoint);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;)(&#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-string-expression)">&#39;src/index.js&#39;</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)">(exports</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> require) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">exports</span><span style="color: var(--shiki-color-text)">.default </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;foo&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">&#125;).default;</span></span>
<span class="line dim"></span>
<span class="line dim"><span style="color: var(--shiki-token-comment)">// myApp === &#39;foo&#39;</span></span></code></pre><!-- HTML_TAG_END --></div>
<p>Again you can observe that by playing different option values of <code class="inline">output.library</code>, <code class="inline">output.libraryTarget</code>, <code class="inline">output.libraryExport</code>, webpack adds different prefix and suffix to the bundled code:</p>
<div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-comment)">// libraryTarget: &#39;commonjs2&#39;:</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">module</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">exports</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> &#123;&#123;BUNDLED_CODE&#125;&#125;;</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// libraryTarget: &#39;self&#39;:</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">Object</span><span style="color: var(--shiki-token-function)">.assign</span><span style="color: var(--shiki-color-text)">(self</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> &#123;&#123;BUNDLED_CODE&#125;&#125;);</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// library: &#39;myApp&#39;, libraryTarget: &#39;var&#39;:</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">var</span><span style="color: var(--shiki-color-text)"> myApp </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> &#123;&#123;BUNDLED_CODE&#125;&#125;;</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// library: &#39;myApp&#39;, libraryTarget: &#39;var&#39;, libraryExport: &#39;default&#39;:</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">var</span><span style="color: var(--shiki-color-text)"> myApp </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> &#123;&#123;BUNDLED_CODE&#125;&#125;.default;</span></span></code></pre><!-- HTML_TAG_END --></div>
<p>So, instead of using the webpack built-in library targets, what should we do if we want to support a custom library target that looks something like below:</p>
<div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-comment)">// libraryTarget: ???</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">customRegistry</span><span style="color: var(--shiki-token-function)">.register</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&#39;my-app&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> &#123;&#123;BUNDLED_CODE&#125;&#125;);</span></span></code></pre><!-- HTML_TAG_END --></div>
<p>I searched through the <a href="https://webpack.js.org/configuration/output/" rel="nofollow">webpack official docs</a> and found no options that allows that. So the only solution at the moment is to write a webpack plugin.</p></section>
<section><h2><a href="#writing-a-webpack-plugin" id="writing-a-webpack-plugin">Writing a webpack plugin</a></h2>
<p>After digging around the <a href="https://github.com/webpack/webpack" rel="nofollow">webpack source code</a>, I found out that <a href="https://github.com/webpack/webpack/blob/master/lib/LibraryTemplatePlugin.js" rel="nofollow">LibraryTemplatePlugin</a> instantiates different TemplatePlugins based on the value of the <code class="inline">output.libraryTarget</code> option:</p>
<div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-comment)">// webpack/lib/LibraryTemplatePlugin.js</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">class</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">LibraryTemplatePlugin</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line"><span style="color: var(--shiki-token-function)">apply</span><span style="color: var(--shiki-color-text)"> (compiler) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">switch</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">options</span><span style="color: var(--shiki-color-text)">.libraryTarget) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">case</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;amd&#39;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">case</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;amd-require&#39;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">new</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">AmdTemplatePlugin</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-comment)">/*...*/</span><span style="color: var(--shiki-color-text)">)</span><span style="color: var(--shiki-token-function)">.apply</span><span style="color: var(--shiki-color-text)">(compiler);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">break</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">case</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;var&#39;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">new</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">SetVarTemplatePlugin</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-comment)">/*...*/</span><span style="color: var(--shiki-color-text)">)</span><span style="color: var(--shiki-token-function)">.apply</span><span style="color: var(--shiki-color-text)">(compiler);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">break</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">case</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;this&#39;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">case</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;self&#39;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">case</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;window&#39;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">new</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">SetVarTemplatePlugin</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-comment)">/*...*/</span><span style="color: var(--shiki-color-text)">)</span><span style="color: var(--shiki-token-function)">.apply</span><span style="color: var(--shiki-color-text)">(compiler);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">break</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!-- HTML_TAG_END --></div>
<p>I went to look into one of the TemplatePlugins, the <a href="https://github.com/webpack/webpack/blob/master/lib/SetVarTemplatePlugin.js" rel="nofollow">SetVarTemplatePlugin</a>:</p>
<div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> &#123; </span><span style="color: var(--shiki-token-constant)">ConcatSource</span><span style="color: var(--shiki-color-text)"> &#125; </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">require</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&#39;webpack-sources&#39;</span><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line dim"></span>
<span class="line dim"><span style="color: var(--shiki-token-keyword)">class</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">SetVarTemplatePlugin</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-function)">apply</span><span style="color: var(--shiki-color-text)">(compiler) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">compiler</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">hooks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">thisCompilation</span><span style="color: var(--shiki-token-function)">.tap</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&#39;SetVarTemplatePlugin&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> compilation </span><span style="color: var(--shiki-token-keyword)">=&gt;</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-constant)">hooks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">render</span><span style="color: var(--shiki-token-function)">.tap</span><span style="color: var(--shiki-color-text)">(</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-string-expression)">&#39;SetVarTemplatePlugin&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">        (source</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> &#123; chunk</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> chunkGraph &#125;) </span><span style="color: var(--shiki-token-keyword)">=&gt;</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">          </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">          </span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">prefix</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#96;</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">varExpression</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)"> =&#96;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">          </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">new</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">ConcatSource</span><span style="color: var(--shiki-color-text)">(prefix</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> source);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">        &#125;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">      );</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    &#125;);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!-- HTML_TAG_END --></div>
<p>I don&#39;t understand line-by-line everything that happened in the file, but I do know that the line highlighted above, is where webpack concats the <code class="inline">varExpression =</code> (in the case of <code class="inline">commonjs</code>, <code class="inline">varExpression</code> is <code class="inline">module.exports</code>, thus <code class="inline">module.exports =</code>) and the source (which in this case is the bundled code).</p>
<p>So, to have the following:</p>
<div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-constant)">customRegistry</span><span style="color: var(--shiki-token-function)">.register</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&#39;my-app&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> &#123;&#123;BUNDLED_CODE&#125;&#125;);</span></span></code></pre><!-- HTML_TAG_END --></div>
<p>we need:</p>
<div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">new</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">ConcatSource</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&#96;customRegistry.register(&#39;my-app&#39;, &#96;</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> source</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;)&#39;</span><span style="color: var(--shiki-color-text)">);</span></span></code></pre><!-- HTML_TAG_END --></div>
<p>So, I did the following:</p>
<ol><li>Created a new file and pasted the entire source from <a href="https://github.com/webpack/webpack/blob/master/lib/SetVarTemplatePlugin.js" rel="nofollow">SetVarTemplatePlugin.js</a></li>
<li>Searched + replaced to rename the plugin name to something more appropriate, (SetModuleTemplatePlugin)</li>
<li>Replaced relative import, <code class="inline">require(&quot;./RuntimeGlobals&quot;)</code> to require from webpack, <code class="inline">require(&quot;webpack/lib/RuntimeGlobals&quot;)</code></li>
<li>Replaced the line <code class="inline">return new ConcatSource(prefix, source);</code> to the following:</li></ol>
<div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">new</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">ConcatSource</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&#96;customRegistry.register(&#39;my-app&#39;, &#96;</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> source</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;)&#39;</span><span style="color: var(--shiki-color-text)">);</span></span></code></pre><!-- HTML_TAG_END --></div>
<ol><li>Removed <code class="inline">output.library</code>, <code class="inline">output.libraryTarget</code> from webpack config</li>
<li>Added my new plugin:</li></ol>
<div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-comment)">// webpack.config.js</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">module</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">exports</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  plugins</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> [</span><span style="color: var(--shiki-token-keyword)">new</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">SetModuleTemplatePlugin</span><span style="color: var(--shiki-color-text)">()]</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;;</span></span></code></pre><!-- HTML_TAG_END --></div>
<p>To my surprise, it worked! Almost.</p>
<p>When I run the bundled code, the customRegistry registered an empty object, nothing is exported from the bundled code.</p>
<p>I went into <a href="https://github.com/webpack/webpack/blob/master/lib/LibraryTemplatePlugin.js" rel="nofollow">LibraryTemplatePlugin.js</a> to look about, because that&#39;s the most obvious place to start looking, since I&#39;ve copied line-by-line from <a href="https://github.com/webpack/webpack/blob/master/lib/SetVarTemplatePlugin.js" rel="nofollow">SetVarTemplatePlugin.js</a>.</p>
<p>I found a pretty obvious line that says:</p>
<div class="code-section"><!-- HTML_TAG_START --><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">FlagEntryExportAsUsedPlugin</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">require</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&quot;./FlagEntryExportAsUsedPlugin&quot;</span><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">new</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">FlagEntryExportAsUsedPlugin</span><span style="color: var(--shiki-color-text)">(</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">options</span><span style="color: var(--shiki-color-text)">.libraryTarget </span><span style="color: var(--shiki-token-keyword)">!==</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&quot;module&quot;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-string-expression)">&quot;used a library export&quot;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">)</span><span style="color: var(--shiki-token-function)">.apply</span><span style="color: var(--shiki-color-text)">(compiler);</span></span></code></pre><!-- HTML_TAG_END --></div>
<p>If I would have to guess, I think that what this line is doing is to mark the export of the entry file as used, so that webpack would not <em>treeshake them away</em>.</p>
<blockquote><p>Which, <strong>treeshake</strong> is a cool word that means remove them.</p>
<blockquote><p>Which you could argue that <strong>treeshake</strong> does way more that just remove the entry exports, it removes things that is only used by the entry exports, recursively.</p></blockquote></blockquote>
<p>I added these 2 lines into my <code class="inline">SetModuleTemplatePlugin</code>, and it worked! Perfectly this time. </p>
<p>I created <a href="https://gist.github.com/tanhauhau/b6b355fbbabe224c9242a5257baa4dec" rel="nofollow">a gist</a> for the complete code, if you are lazy.</p>
<p>Lastly, if you noticed, this example is based on the latest master webpack source (at the time writing), which is <code class="inline">webpack@5.0.0-beta.12</code>.</p>
<p>If you want a similar plugin with <code class="inline">webpack^4</code>, you can trust me that this article serves as a good enough entry point for you to write the plugin on your own.</p>
<p><strong>And I trust you that you can do it. </strong></p></section>
<section><h2><a href="#closing-note" id="closing-note">Closing Note</a></h2>
<p>Writing a webpack plugin is not impossible. It will especially be easier if you have a good understanding how webpack as a bundler works.</p>
<p><em>(Plug: if you want to know more, you can read my <a href="/what-is-module-bundler-and-how-does-it-work/">&quot;What is module bundler and how does it work?&quot;</a>)</em></p></section></article>

<div style="height: 1px; width: 100%"></div>

</main>

<footer class="svelte-70a8h7">
</footer>


		<script type="module" data-hydrate="cudmyi">
		import { start } from "/_app/start-51123d14.js";
		start({
			target: document.querySelector('[data-hydrate="cudmyi"]').parentNode,
			paths: {"base":"","assets":""},
			session: {},
			route: true,
			spa: false,
			trailing_slash: "always",
			hydrate: {
				status: 200,
				error: null,
				nodes: [
					import("/_app/pages/__layout.svelte-9b1df45b.js"),
						import("/_app/pages/webpack-plugin-main-template/index.md-2c39eae6.js")
				],
				params: {}
			}
		});
	</script></div>
		<script>(function (i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () { (i[r].q = i[r].q || []).push(arguments) }, i[r].l = 1 * new Date(); a = s.createElement(o), m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m) })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga'); if (typeof ga === "function") { ga('create', 'UA-135921142-1', 'auto', {}); }</script>
	</body>
</html>
