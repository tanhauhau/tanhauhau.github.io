{"componentChunkName":"component---src-templates-blog-post-js","path":"/writing-your-own-module-bundler/","webpackCompilationHash":"d6884a8b81cd519591aa","result":{"data":{"site":{"siteMetadata":{"title":"Tan Li Hau","author":"Tan Li Hau"}},"markdownRemark":{"id":"061049a8-c42d-5419-ade6-1069aa9cde28","excerpt":"","html":"<p>In my <a href=\"/what-is-module-bundler-and-how-does-it-work/\">previous article</a>, I explained how module bundler works, and I used <a href=\"https://webpack.js.org\">webpack</a> and <a href=\"https://rollupjs.org\">rollup</a> as example, and each of them gave us a different perspective in how we can bundle our JavaScript application.</p>\n<p>If you haven’t read it, please do <a href=\"/what-is-module-bundler-and-how-does-it-work/\">check it out</a>, because in this article, I am going to talk about how we are going to write a module bundler ourselves.</p>\n<h1>Getting Started</h1>\n<p>We have seen the input (the JavaScript modules) and the output (the bundled JavaScript file) of a module bundler in the <a href=\"/what-is-module-bundler-and-how-does-it-work/\">previous article</a>, now let’s take a look how we can create a tool to get takes in the input and produce the output.</p>\n<p>A basic module bundler can be broken down into 2 parts:</p>\n<ul>\n<li>Understands the code and constructs the dependency graph <strong>(Dependency Resolution)</strong></li>\n<li>Assembles the module into a single (or multiple) JavaScript file <strong>(Bundle)</strong></li>\n</ul>\n<blockquote>\n<p>A <strong>dependency graph</strong> is a graph representation of the dependency relationship between modules.</p>\n</blockquote>\n<h2>The Input</h2>\n<p>We will be using the following files as input to our bundler:</p>\n<p class=\"filename\">index.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> squareArea <span class=\"token keyword\">from</span> <span class=\"token string\">'./square.js'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> circleArea <span class=\"token keyword\">from</span> <span class=\"token string\">'./circle.js'</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of square: '</span><span class=\"token punctuation\">,</span> <span class=\"token function\">squareArea</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of circle'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">circleArea</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p class=\"filename\">square.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">area</span><span class=\"token punctuation\">(</span>side<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> side <span class=\"token operator\">*</span> side<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> area<span class=\"token punctuation\">;</span></code></pre></div>\n<p class=\"filename\">circle.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">PI</span> <span class=\"token operator\">=</span> <span class=\"token number\">3.141</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">area</span><span class=\"token punctuation\">(</span>radius<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token constant\">PI</span> <span class=\"token operator\">*</span> radius <span class=\"token operator\">*</span> radius<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> area<span class=\"token punctuation\">;</span></code></pre></div>\n<p>If you want to try along, you can clone <a href=\"https://github.com/tanhauhau/byo-bundler/tree/master/fixture\">this project</a> and checkout the <code class=\"language-text\">fixture-1</code> tag. the input files are in the <code class=\"language-text\">fixture/</code> folder.</p>\n<h1>Writing</h1>\n<p>So let’s start with creating the outline of the main function of our module bundler, and let’s call it <code class=\"language-text\">build</code>.</p>\n<!-- prettier-ignore -->\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> entryFile<span class=\"token punctuation\">,</span> outputFolder <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// build dependency graph</span>\n  <span class=\"token keyword\">const</span> graph <span class=\"token operator\">=</span> <span class=\"token function\">createDependencyGraph</span><span class=\"token punctuation\">(</span>entryFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// bundle the asset</span>\n  <span class=\"token keyword\">const</span> outputFiles <span class=\"token operator\">=</span> <span class=\"token function\">bundle</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// write to output folder</span>\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> outputFile <span class=\"token keyword\">of</span> outputFiles<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span>\n      path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>outputFolder<span class=\"token punctuation\">,</span> outputFile<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      outputFile<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'utf-8'</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>The <strong>dependency graph</strong> that we are going to build, is a <a href=\"https://en.wikipedia.org/wiki/Directed_graph\">directed graph</a>, where the vertex is the module, and the directed edge is the dependency relationship between the modules.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">createDependencyGraph</span><span class=\"token punctuation\">(</span>entryFile<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> rootModule <span class=\"token operator\">=</span> <span class=\"token function\">createModule</span><span class=\"token punctuation\">(</span>entryFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> rootModule<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The dependency graph creates a module with the entry file, and we are going to return just that at the moment.</p>\n<p>So, let’s implement <code class=\"language-text\">createModule</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">createModule</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Module</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The class <code class=\"language-text\">Module</code> will be used to record module properties, such as the content, the dependencies, exported keys, etc.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Module</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>filePath <span class=\"token operator\">=</span> filePath<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>content <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dependencies <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>While the <code class=\"language-text\">content</code> is the string content of the module, to understand what it actually means, we would need to <em>parse the content</em> into AST (Abstract Syntax Tree). Let’s use <a href=\"http://babeljs.io\">babel</a> to parse the code:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> babel <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/core'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Module</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>filePath <span class=\"token operator\">=</span> filePath<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>content <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ast <span class=\"token operator\">=</span> babel<span class=\"token punctuation\">.</span><span class=\"token function\">parseSync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The next thing we are looking for, is the dependency of this module:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Module</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>filePath <span class=\"token operator\">=</span> filePath<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>content <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ast <span class=\"token operator\">=</span> babel<span class=\"token punctuation\">.</span><span class=\"token function\">parseSync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dependencies <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">findDependencies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">findDependencies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token comment\">//</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>So, how do we know what is the dependency of this module? Well we can find the <code class=\"language-text\">import</code> statement from the AST we just got. How do we know how does our AST look like, and how to find the <code class=\"language-text\">import</code> statement from our AST? Well, you can visualise it through <a href=\"https://lihautan.com/babel-ast-explorer/#?eyJiYWJlbFNldHRpbmdzIjp7InZlcnNpb24iOiI3LjQuNSJ9LCJ0cmVlU2V0dGluZ3MiOnsiaGlkZUVtcHR5Ijp0cnVlLCJoaWRlTG9jYXRpb24iOnRydWUsImhpZGVUeXBlIjp0cnVlfSwiY29kZSI6ImltcG9ydCBzcXVhcmVBcmVhIGZyb20gJy4vc3F1YXJlLmpzJztcbmltcG9ydCBjaXJjbGVBcmVhIGZyb20gJy4vY2lyY2xlLmpzJztcblxuY29uc29sZS5sb2coJ0FyZWEgb2Ygc3F1YXJlOiAnLCBzcXVhcmVBcmVhKDUpKTtcbmNvbnNvbGUubG9nKCdBcmVhIG9mIGNpcmNsZScsIGNpcmNsZUFyZWEoNSkpO1xuIn0=\">babel-ast-explorer</a>:</p>\n<p>\n  <a class=\"gatsby-resp-image-link\" href=\"/static/87b78a845870fcfa5bb6756e80815d95/bb144/ast-import.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n  \n  <figure class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 38.67187499999999%; position: relative; bottom: 0; left: 0; background-image: url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABNUlEQVQoz41Ry0rDQBSd0gqC4La49jtcVa0bEfwAv0hX+iP6MwWF9DFpO5OkaYtN2mQm93jzIE1RoQdOztzHnNybiNHQgTMaYjIaQ8spPM+DUqqm1gqfEw9SSozdORw5x2zq4ktqSNfluobv+wiCAIPBAGKmNJbaR+KHiMMVFsslsixDE8YQNivCeksw+B9KeRCpsaCU21iTNEUUxyAi8KNQIls0x9EH/PAe37sHfuEN53sNXnNHjyd9hMibqWITVBua3JvxjO1WwAvPoaMOLOVXBdea7FaG9eU99/lyScreYK3g6U4512G2OduuNI9brJeHhn+hNqRXROsOFqsu1unZgWF5brEeYcgft1r5BWYnEMYn2Njf65bxxTETlj8lMe/Y7K6Q2DuO+lzoc61fnEu9ZX3CD9ttQVhUpVN6AAAAAElFTkSuQmCC&#x27;); background-size: cover; display: block;\">\n      <img class=\"gatsby-resp-image-image\" style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\" alt=\"babel-ast-explorer\" title=\"Visualizing AST through babel-ast-explorer\" src=\"/static/87b78a845870fcfa5bb6756e80815d95/623ee/ast-import.png\" srcset=\"/static/87b78a845870fcfa5bb6756e80815d95/816c5/ast-import.png 148w, /static/87b78a845870fcfa5bb6756e80815d95/c766b/ast-import.png 295w, /static/87b78a845870fcfa5bb6756e80815d95/623ee/ast-import.png 590w, /static/87b78a845870fcfa5bb6756e80815d95/e5345/ast-import.png 885w, /static/87b78a845870fcfa5bb6756e80815d95/7a439/ast-import.png 1180w, /static/87b78a845870fcfa5bb6756e80815d95/84fe0/ast-import.png 1770w, /static/87b78a845870fcfa5bb6756e80815d95/bb144/ast-import.png 2560w\" sizes=\"(max-width: 590px) 100vw, 590px\">\n    </span>\n  <figcaption>Visualizing AST through babel-ast-explorer</figcaption></figure>\n  \n  </a>\n    </p>\n<p>We can see that the node we are looking for is called <code class=\"language-text\">ImportDeclaration</code>, and the property that tells us where we are importing from is the <code class=\"language-text\">source.value</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">findDependencies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ast<span class=\"token punctuation\">.</span>program<span class=\"token punctuation\">.</span>body</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>node <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'ImportDeclaration'</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>node <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>source<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>So now we have the path that we are requesting, it could be relative to our current file, eg <em>”./foo/bar”</em>, or from our node*modules, eg: *“lodash”_, so how do we know what is the actual file path that we are requesting?</p>\n<p>The step that we need to do, to figure out the actual path based on the requested path, is called <strong>“Resolving”</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">findDependencies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ast<span class=\"token punctuation\">.</span>program<span class=\"token punctuation\">.</span>body\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>node <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'ImportDeclaration'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>node <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>source<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>relativePath <span class=\"token operator\">=></span> <span class=\"token function\">resolveRequest</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>filePath<span class=\"token punctuation\">,</span> relativePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token comment\">// resolving</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">function</span> <span class=\"token function\">resolveRequest</span><span class=\"token punctuation\">(</span>requester<span class=\"token punctuation\">,</span> requestedPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token comment\">//</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span></span></code></pre></div>\n<div class=\"caption\">Resolving path to the actual file path</div>\n<h2>Resolving</h2>\n<p>We know that “import”ing <code class=\"language-text\">./b.js</code> in the following examples will result in getting a different file, because when we specify <code class=\"language-text\">./</code>, we are “import”ing relative to the current file.</p>\n<p class=\"filename\"><root>/a.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token string\">'./b.js'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p class=\"filename\"><root>/foo/a.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token string\">'./b.js'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>So, what are the rules of resolving a module? <a href=\"http://nodejs.org/api/modules.html#modules_all_together\">Node.js Modules Resolving</a> list out the detail step of the Node.js resolving algorithm:</p>\n<p>When we specify a relative path, <code class=\"language-text\">./b</code>, Node.js will first assume that <code class=\"language-text\">./b</code> is a file, and tries the following extension if it doesn’t exactly match the file name:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">b\nb.js\nb.json\nb.node</code></pre></div>\n<p>If the file does not exist, Node.js will then try to treat <code class=\"language-text\">./b</code> as a directory, and try the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&quot;main&quot; in b/package.json\nb/index.js\nb/index.json\nb/index.node</code></pre></div>\n<p>If we specify <code class=\"language-text\">import &#39;b&#39;</code> instead, Node.js will treat it as a package within <code class=\"language-text\">node_modules/</code>, and have a different resolving strategy.</p>\n<p>Through the above illustration, we can see that resolving <code class=\"language-text\">import &#39;./b&#39;</code> is not as simple as it seems. Besides the default Node.js resolving behaviour, <a href=\"webpack.js.org/configuration/resolve/\">webpack provides a lot more customisation options</a>, such as custom extensions, alias, modules folders, etc.</p>\n<p>To move things forward, we are going to handle resolving relative path for now:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token comment\">// resolving</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">function</span> <span class=\"token function\">resolveRequest</span><span class=\"token punctuation\">(</span>requester<span class=\"token punctuation\">,</span> requestedPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">dirname</span><span class=\"token punctuation\">(</span>requester<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> requestedPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span></span></code></pre></div>\n<blockquote>\n<p><small><strong>Note:</strong> You should try out writing a full node resolvers that resolve relatively as well as absolutely from <code class=\"language-text\">node_modules/</code></small></p>\n</blockquote>\n<p>Now we know the actual requested file path, let’s create a module out of them as well!</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">findDependencies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ast<span class=\"token punctuation\">.</span>program<span class=\"token punctuation\">.</span>body\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>node <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'ImportDeclaration'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>node <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>source<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>relativePath <span class=\"token operator\">=></span> <span class=\"token function\">resolveRequest</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>filePath<span class=\"token punctuation\">,</span> relativePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>absolutePath <span class=\"token operator\">=></span> <span class=\"token function\">createModule</span><span class=\"token punctuation\">(</span>absolutePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>So, for each module, we find their dependencies, parse them, and find each dependency’s dependencies recursively. At the end of the process, we will get a module dependency graph. If you console out the dependency graph, you will see something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Module <span class=\"token punctuation\">{</span>\n  filePath<span class=\"token punctuation\">:</span> <span class=\"token string\">'/Projects/byo-bundler/fixture/index.js'</span><span class=\"token punctuation\">,</span>\n  content<span class=\"token punctuation\">:</span>\n   <span class=\"token string\">'import squareArea from \\'./square.js\\';\\nimport circleArea from \\'./circle.js\\';\\n\\nconsole.log(\\'Area of square: \\', squareArea(5));\\nconsole.log(\\'Area of circle\\', circleArea(5));\\n'</span><span class=\"token punctuation\">,</span>\n  ast<span class=\"token punctuation\">:</span>\n   Node <span class=\"token punctuation\">{</span> <span class=\"token comment\">/*...*/</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  dependencies<span class=\"token punctuation\">:</span>\n   <span class=\"token punctuation\">[</span> Module <span class=\"token punctuation\">{</span>\n       filePath<span class=\"token punctuation\">:</span> <span class=\"token string\">'/Projects/byo-bundler/fixture/square.js'</span><span class=\"token punctuation\">,</span>\n       content<span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'function area(side) {\\n  return side * side;\\n}\\nexport default area;\\n'</span><span class=\"token punctuation\">,</span>\n       ast<span class=\"token punctuation\">:</span> Node <span class=\"token punctuation\">{</span><span class=\"token comment\">/* ... */</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n       dependencies<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n     Module <span class=\"token punctuation\">{</span>\n       filePath<span class=\"token punctuation\">:</span> <span class=\"token string\">'/Projects/byo-bundler/fixture/circle.js'</span><span class=\"token punctuation\">,</span>\n       content<span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'const PI = 3.141;\\nfunction area(radius) {\\n    return PI * radius * radius;\\n}\\nexport default area;\\n'</span><span class=\"token punctuation\">,</span>\n       ast<span class=\"token punctuation\">:</span> Node <span class=\"token punctuation\">{</span><span class=\"token comment\">/* ... */</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n       dependencies<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> \n      <span class=\"token punctuation\">}</span> \n   <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The root of the graph is our entry module, and you can traverse the graph through the <code class=\"language-text\">dependencies</code> of the module. As you can see, the <code class=\"language-text\">index.js</code> has 2 dependencies, the <code class=\"language-text\">square.js</code> and the <code class=\"language-text\">circle.js</code>.</p>\n<blockquote>\n<p><small><strong>Note:</strong> If you are following along, you can checkout the tag <code class=\"language-text\">feat-1-module-dependency-graph</code>, to see the code that we have written so far.</small></p>\n</blockquote>\n<h2>Bundling</h2>\n<p>So now with the module dependency graph, it’s time for us to bundle them into a file!</p>\n<p>At this point in time, we can choose whether we want to bundle it in the <strong>“webpack way”</strong> or the <strong>“rollup way”</strong>. In this article we are going to look at the <strong>“webpack way”</strong>, I’ll write about bundling in the <strong>“rollup way”</strong> in the next article.</p>\n<blockquote>\n<p>If you have no idea about what is the <strong>“webpack way”</strong> or <strong>“rollup way”</strong>, I have coined the term in my <a href=\"/what-is-module-bundler-and-how-does-it-work/\">previous article</a> and have detailed explanation about them!</p>\n</blockquote>\n<p>Let’s take a look how the final bundled file would look like:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> modules <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">'circle.js'</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> require<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">PI</span> <span class=\"token operator\">=</span> <span class=\"token number\">3.141</span><span class=\"token punctuation\">;</span>\n    exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">default</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">area</span><span class=\"token punctuation\">(</span>radius<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">PI</span> <span class=\"token operator\">*</span> radius <span class=\"token operator\">*</span> radius<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'square.js'</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> require<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">default</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">area</span><span class=\"token punctuation\">(</span>side<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> side <span class=\"token operator\">*</span> side<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'app.js'</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> require<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> squareArea <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'square.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> circleArea <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'circle.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of square: '</span><span class=\"token punctuation\">,</span> <span class=\"token function\">squareArea</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of circle'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">circleArea</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">webpackStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  modules<span class=\"token punctuation\">,</span>\n  entry<span class=\"token punctuation\">:</span> <span class=\"token string\">'app.js'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Let’s break it down to a few steps:</p>\n<ul>\n<li><strong>Create the module map</strong> and wrapping each module in a “special” module function</li>\n<li><strong>Create the “runtime”</strong>, the glue that links each module together.</li>\n</ul>\n<h1>Optimisation</h1>\n<h2>Circular dependency</h2>\n<h2>Module ID</h2>\n<h1>Summary</h1>\n<ul>\n<li>bundle(graph); returns an array -> we are going to do code splitting</li>\n</ul>\n<h1>Further Readings</h1>\n<ul>\n<li><a href=\"https://slides.com/lucianomammino/unbundling-the-javascript-module-bundler-dublinjs\">Luciano Mammino, Unbundling the JavaScript module bundler - DublinJS July 2018</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=Gc9-7PBqOC8\">Ronen Amiel, Build Your Own Webpack - You Gotta Love Frontend 2018</a></li>\n</ul>","fields":{"wip":true},"frontmatter":{"title":"Writing your own module bundler","date":"June 29, 2019","lastUpdated":null,"description":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/writing-your-own-module-bundler/","type":"blog","noteDate":null,"noteTitle":null,"wip":true,"previous":null,"next":null}}}