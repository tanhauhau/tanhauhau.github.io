<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="x-ua-compatible" content="ie=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
		<link rel="preconnect dns-prefetch" href="https://www.google-analytics.com" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://twitter.com/lihautan" rel="me" />
		<link rel="manifest" href="/manifest.webmanifest" />
		<meta name="theme-color" content="#bd93f9" />
		<link rel="apple-touch-icon" sizes="48x48" href="/icon-48x48.png" />
		<link rel="apple-touch-icon" sizes="72x72" href="/icon-72x72.png" />
		<link rel="apple-touch-icon" sizes="96x96" href="/icon-96x96.png" />
		<link rel="apple-touch-icon" sizes="144x144" href="/icon-144x144.png" />
		<link rel="apple-touch-icon" sizes="192x192" href="/icon-192x192.png" />
		<link rel="apple-touch-icon" sizes="256x256" href="/icon-256x256.png" />
		<link rel="apple-touch-icon" sizes="384x384" href="/icon-384x384.png" />
		<link rel="apple-touch-icon" sizes="512x512" href="/icon-512x512.png" />
		<link rel="icon" href="/icon-48x48.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link
			rel="preload"
			href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,400;0,500;0,700;1,300&family=Noto+Sans+SC:wght@500&display=swap"
			as="style"
			onload="this.rel='stylesheet'"
		/>
		<link
			rel="alternate"
			type="application/rss+xml"
			title="Tan Li Hau&#x27;s RSS Feed"
			href="/rss.xml"
		/>
		<link rel="sitemap" type="application/xml" href="/sitemap.xml" />
		<link rel="webmention" href="https://webmention.io/lihautan.com/webmention" />
		<link rel="pingback" href="https://webmention.io/lihautan.com/xmlrpc" />
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z6Y89Q69VY"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag('js', new Date());

			gtag('config', 'G-Z6Y89Q69VY');
		</script>
		
		<link href="https://lihautan.com/_app/immutable/assets/Links.C2CU1fXX.css" rel="stylesheet">
		<link href="https://lihautan.com/_app/immutable/assets/PreloadingIndicator.BQiUubKD.css" rel="stylesheet">
		<link href="https://lihautan.com/_app/immutable/assets/2.BeAuNOJS.css" rel="stylesheet">
		<link href="https://lihautan.com/_app/immutable/assets/ldjson.fEDs21Fy.css" rel="stylesheet">
		<link href="https://lihautan.com/_app/immutable/assets/BlogLayout.If62OGIu.css" rel="stylesheet">
		<link href="https://lihautan.com/_app/immutable/assets/code-snippet.DJDuXAlw.css" rel="stylesheet">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/entry/start.CvTXASZI.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/BToKt9Y9.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/D8xCbML1.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/C2PHntuy.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/F79hK6eD.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/NszcoyHp.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/5DLlqFsV.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/CSTksUBv.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/entry/app._8dSQ1Bw.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/Bzak7iHL.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/mnCOdu-q.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/BQPykor9.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/gzNpScmH.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/Oex6NZFd.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/nodes/0.D9jhjCBq.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/nodes/2.CdYW0wau.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/kfVmCPsV.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/Cek0FGb6.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/BQOOHHT8.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/C0LQ7Lkx.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/NbeVDlzF.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/DwHwQPD1.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/DLdlFW72.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/pHDcyWD2.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/CEusTUg_.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/BKJY_Hxi.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/BJpy2SH2.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/DnM2s-CZ.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/nodes/24.BirBJvX_.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/C3QlhiH-.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/B1caYEk9.js">
		<link rel="modulepreload" href="https://lihautan.com/_app/immutable/chunks/4IC_Y2Qv.js"><!--[--><meta name="description" content="I am going to tell you an anecdote on how I investigated and fixed a bug in Svelte. I documented down my train of thoughts as detailed as possible. I hope this gives anyone who is reading, a glimpse on how to work on the Svelte source code."/> <meta name="image" content=""/> <meta name="og:image" content=""/> <meta name="og:title" content="Contributing to Svelte - Fixing issue #4392"/> <meta name="og:description" content="I am going to tell you an anecdote on how I investigated and fixed a bug in Svelte. I documented down my train of thoughts as detailed as possible. I hope this gives anyone who is reading, a glimpse on how to work on the Svelte source code."/> <meta name="og:type" content="website"/> <meta name="twitter:card" content="summary_large_image"/> <meta name="twitter:creator" content="@lihautan"/> <meta name="twitter:title" content="Contributing to Svelte - Fixing issue #4392"/> <meta name="twitter:description" content="I am going to tell you an anecdote on how I investigated and fixed a bug in Svelte. I documented down my train of thoughts as detailed as possible. I hope this gives anyone who is reading, a glimpse on how to work on the Svelte source code."/> <meta name="twitter:image" content=""/> <!--[--><meta name="keywords" content="Svelte"/><meta name="keywords" content="JavaScript"/><meta name="keywords" content="Open Source"/><!--]--> <meta itemprop="url" content="https://lihautan.com/contributing-to-svelte-fixing-issue-4392"/> <meta itemprop="image" content=""/> <!----><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","author":{"@type":"Person","name":"Tan Li Hau","url":"https://lihautan.com/about/"},"copyrightHolder":{"@type":"Person","name":"Tan Li Hau","url":"https://lihautan.com/about/"},"copyrightYear":"2022","creator":{"@type":"Person","name":"Tan Li Hau","url":"https://lihautan.com/about/"},"publisher":{"@type":"Person","name":"Tan Li Hau","url":"https://lihautan.com/about/"},"description":"I am going to tell you an anecdote on how I investigated and fixed a bug in Svelte. I documented down my train of thoughts as detailed as possible. I hope this gives anyone who is reading, a glimpse on how to work on the Svelte source code.","headline":"Contributing to Svelte - Fixing issue #4392","name":"Contributing to Svelte - Fixing issue #4392","inLanguage":"en"}</script><!----> <!----><script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","description":"Breadcrumbs list","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","item":{"@id":"https://lihautan.com","name":"Homepage"},"name":"Homepage","position":1},{"@type":"ListItem","item":{"@id":"https://lihautan.com/contributing-to-svelte-fixing-issue-4392","name":"Contributing to Svelte - Fixing issue #4392"},"name":"Contributing to Svelte - Fixing issue #4392","position":2}]}</script><!----><!--]--><title>Contributing to Svelte - Fixing issue #4392 | Tan Li Hau</title>
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><!--[--><!----><!--[!--><!--]--> <!--[--><a href="#content" class="skip svelte-1x8iuzz">Skip to content</a> <header class="svelte-1x8iuzz"><nav><ul class="mode-sidebar svelte-2qf5mw"><!--[--><li class="svelte-2qf5mw"><a href="/" class="svelte-2qf5mw">Tan Li Hau</a></li><!--]--> <li class="desktop svelte-2qf5mw"><a data-sveltekit-preload-data="" href="/about" class="svelte-2qf5mw">About</a></li> <li class="desktop svelte-2qf5mw"><a data-sveltekit-preload-data="" href="/blogs" class="svelte-2qf5mw">Writings</a></li> <li class="desktop svelte-2qf5mw"><a data-sveltekit-preload-data="" href="/talks" class="svelte-2qf5mw">Talks</a></li> <li class="desktop svelte-2qf5mw"><a data-sveltekit-preload-data="" href="/notes" class="svelte-2qf5mw">Notes</a></li> <li class="desktop svelte-2qf5mw"><a data-sveltekit-preload-data="" href="/books" class="svelte-2qf5mw">Books</a></li> <li class="social svelte-2qf5mw"><a aria-label="Twitter account" href="https://twitter.com/lihautan" class="svelte-2qf5mw"><svg viewBox="0 0 24 24" width="1em" height="1em" class="svelte-2qf5mw"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66
  10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5
  4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a> <a aria-label="Github account" href="https://github.com/tanhauhau" class="svelte-2qf5mw"><svg viewBox="0 0 24 24" width="1em" height="1em" class="svelte-2qf5mw"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0
  0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07
  5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65
  5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42
  3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a> <a aria-label="YouTube account" href="https://youtube.com/c/lihautan" class="svelte-2qf5mw"><svg viewBox="0 0 461.001 461.001" width="1em" height="1em" class="svelte-2qf5mw"><path d="M365.257 67.393H95.744C42.866 67.393 0 110.259 0 163.137v134.728c0 52.878 42.866 95.744 95.744 95.744h269.513c52.878 0 95.744-42.866 95.744-95.744V163.137c0-52.878-42.866-95.744-95.744-95.744zm-64.751 169.663-126.06 60.123c-3.359 1.602-7.239-.847-7.239-4.568V168.607c0-3.774 3.982-6.22 7.348-4.514l126.06 63.881c3.748 1.899 3.683 7.274-.109 9.082z"></path></svg></a></li></ul><!----></nav></header> <div class="sidebar svelte-1de72ow"><!--[!--><div class="float svelte-1de72ow"><svg viewBox="0 0 30 50" width="30" height="50"><circle fill="currentColor" cy="15" cx="15" r="3"></circle><circle fill="currentColor" cy="25" cx="15" r="3"></circle><circle fill="currentColor" cy="35" cx="15" r="3"></circle></svg></div><!--]--></div><!----><!--]--> <main id="content" class="svelte-1x8iuzz"><!----><!----><h1>Contributing to Svelte - Fixing issue #4392</h1> <div class="date svelte-fva41n">May 23, 2020</div> <!--[--><a class="tag series svelte-fva41n" href="/series/Contributing to Svelte/">Series: Contributing to Svelte</a><!--]--> <!--[--><a class="tag svelte-fva41n" href="/tags/Svelte/">Svelte</a><a class="tag svelte-fva41n" href="/tags/JavaScript/">JavaScript</a><a class="tag svelte-fva41n" href="/tags/Open Source/">Open Source</a><!--]--> <!--[--><section role="navigation" aria-label="Table of Contents" class="svelte-zmasws"><ol class="svelte-zmasws"><!--[--><li class="svelte-zmasws"><a href="#background" class="svelte-zmasws">Background</a> <!--[!--><!--]--></li><li class="svelte-zmasws"><a href="#the-story-begins" class="svelte-zmasws">The story begins</a> <!--[!--><!--]--></li><li class="svelte-zmasws"><a href="#verifying-the-bug" class="svelte-zmasws">Verifying the bug</a> <!--[!--><!--]--></li><li class="svelte-zmasws"><a href="#investigating-the-bug" class="svelte-zmasws">Investigating the bug</a> <!--[!--><!--]--></li><li class="svelte-zmasws"><a href="#fixing-the-bug" class="svelte-zmasws">Fixing the bug</a> <!--[!--><!--]--></li><li class="svelte-zmasws"><a href="#submitting-the-fix" class="svelte-zmasws">Submitting the fix</a> <!--[!--><!--]--></li><!--]--></ol></section><!--]--> <article class="blog"><!----><section><h2><a href="#background" id="background">Background</a></h2> <p>As Svelte gains more attention, I find that more and more people are interested in contributing to Svelte.</p> <p>Of course, contributing to Svelte, does not mean to contribute only in code, it could be:</p> <ul><li>answering questions about Svelte, on social media, Stack Overflow, or <a href="https://svelte.dev/chat" rel="nofollow">Discord</a></li> <li>improving Svelte docs, or write tutorials and articles about Svelte</li> <li>organising and speaking in meetups about Svelte</li></ul> <p>For those who want to contribute in code, most people are unsure where to start. So I wrote <a href="/the-svelte-compiler-handbook/">The Svelte Compiler Handbook</a> as an overview of the Svelte source code.</p> <p>However, today, I want to try a different tone.</p> <p>I am going to tell you an anecdote on how I investigated and fixed a bug in Svelte.</p> <p>I documented down my train of thoughts as detailed as possible.</p> <p>I hope this gives anyone who is reading, a glimpse on how to work on the Svelte source code.</p></section> <section><h2><a href="#the-story-begins" id="the-story-begins">The story begins</a></h2> <p>I was combing through <a href="https://github.com/sveltejs/svelte/issues?q=is%3Aopen+is%3Aissue+label%3Abug" rel="nofollow">bugs on GitHub</a>, and found this rather interesting bug:</p> <hr/> <p><strong>Select multiple value does not get set with spread props <a href="https://github.com/sveltejs/svelte/issues/4392" rel="nofollow">#4392</a></strong></p> <p>Adding any type of spread, even an empty object <code class="inline">{...{}}</code>, causes the value not to be set:</p> <div class="code-section"><!----><pre class="prism language-svelte"><code><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"></div><div class="line">  <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Hello'</span><span class="token punctuation">,</span> <span class="token string">'World'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><div class="line"></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></div><div class="line"></div><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">multiple</span> <span class="token language-javascript"><span class="token punctuation">&#123;</span>value<span class="token punctuation">&#125;</span></span> <span class="token language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span></div><div class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span><span class="token punctuation">></span></span>Hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span></div><div class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span><span class="token punctuation">></span></span>World<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span></div><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span></div></code></pre><!----></div> <p>To reproduce: <a href="https://svelte.dev/repl/99bd5ebecc464e328972252e287ab716?version=3.18.1" rel="nofollow">REPL</a>.</p> <hr/></section> <section><h2><a href="#verifying-the-bug" id="verifying-the-bug">Verifying the bug</a></h2> <p>I clicked into the REPL and tried to understand about the bug.</p> <p>I found that if the <code class="inline">&lt;select multiple></code> has spread attribute <code class="inline">{...any}</code>, the <code class="inline">value</code> attribute will not be reactive. Changes in the value of <code class="inline">value</code> will not be reflected to the <code class="inline">&lt;select></code>.</p> <p>I noticed the REPL link uses the version <code class="inline">3.18.1</code>, it's not the latest version of Svelte. At the point of writing, Svelte is at <strong>3.22.3</strong>. I tried removing the <code class="inline">?version=3.18.1</code> from the query params to verify whether the bug has fixed, and realised that the bug is still there. (Great! Something interesting to investigate into.)</p> <p>To understand the current status of the issue, I read through the comments. According to <a href="https://github.com/Conduitry" rel="nofollow">Conduitry</a>, the issue is related to <strong>Radio/checkbox input with bind:group and spread props makes variable undefined</strong> <a href="https://github.com/sveltejs/svelte/issues/3680" rel="nofollow">#3680</a> and can be fixed together. However, the issue <a href="https://github.com/sveltejs/svelte/issues/3680" rel="nofollow">#3680</a> was fixed and closed, yet this issue is still open.</p> <p>Nevertheless, I read through <a href="https://github.com/sveltejs/svelte/pull/4398" rel="nofollow">the PR</a> for the closed issue <a href="https://github.com/sveltejs/svelte/issues/3680" rel="nofollow">#3680</a>, roughly understand how it was fixed and hopefully it can give me some inspirations on this issue.</p></section> <section><h2><a href="#investigating-the-bug" id="investigating-the-bug">Investigating the bug</a></h2> <p>Once I verified that the behavior described in the issue is unexpected and reproducible in the latest version of Svelte, I copied the REPL code into my local machine to investigate.</p> <p>I have a <code class="inline">test-svelte</code> folder ready in my local machine, where I created using <a href="https://github.com/sveltejs/template" rel="nofollow">Svelte Template</a>. I have <code class="inline">npm link</code>ed my local Svelte clone to the <code class="inline">test-svelte</code> folder, so I can rebuild <code class="inline">test-svelte</code> anytime with the latest changes done to my Svelte clone.</p> <div class="code-section"><!----><pre class="prism language-"><code><span class="line">- /Projects</span>
<span class="line">  - svelte                &lt;-- cloned from https://github.com/sveltejs/svelte</span>
<span class="line">  - test-svelte           &lt;-- initialised with Svelte Template</span>
<span class="line">    - node_modules/svelte &lt;-- symlink to &#96;/Projects/svelte&#96;</span></code></pre><!----></div> <p>I have <code class="inline">yarn dev</code> running in the Svelte folder, so any changes I make gets compiled immediately.</p> <p>I prefer to <strong>build</strong> <code class="inline">test-svelte</code> and serve it with <a href="https://www.npmjs.com/package/http-server" rel="nofollow">http-server</a> rather than start a dev server <code class="inline">test-svelte</code> in watch mode. That allows me to</p> <ul><li>Run the <code class="inline">http-server</code> in the background while tweaking the Svelte code or the <code class="inline">test-svelte</code> app.</li> <li>Not having to restart the dev server whenever I've made changes to the Svelte code</li> <li>Able to inspect and modify <code class="inline">bundle.js</code> without worrying that accidentaly save in the <code class="inline">test-svelte</code> app will overwrite the <code class="inline">bundle.js</code></li></ul> <p>Looking at the different <code class="inline">bundle.js</code> generated from with <code class="inline">{...spread}</code> attributes and without spread attributes</p> <div class="code-section"><!----><pre class="prism language-svelte"><code><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"></div><div class="line">  <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Hello'</span><span class="token punctuation">,</span> <span class="token string">'World'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><div class="line"></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></div><div class="line"></div><div class="line"><span class="token comment">&lt;!-- with spread --></span></div><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">multiple</span> <span class="token language-javascript"><span class="token punctuation">&#123;</span>value<span class="token punctuation">&#125;</span></span> <span class="token language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span></div><div class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span><span class="token punctuation">></span></span>Hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span></div><div class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span><span class="token punctuation">></span></span>World<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span></div><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span></div><div class="line"></div><div class="line"><span class="token comment">&lt;!-- without spread --></span></div><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">multiple</span> <span class="token language-javascript"><span class="token punctuation">&#123;</span>value<span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span></div><div class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span><span class="token punctuation">></span></span>Hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span></div><div class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span><span class="token punctuation">></span></span>World<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span></div><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span></div></code></pre><!----></div> <p>I found the following diffs in the bundled output:</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line inserted"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">let</span><span style="color: var(--shiki-color-text)"> select_levels </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> [&#123; multiple</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">true</span><span style="color: var(--shiki-color-text)"> &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> &#123; value</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-comment)">/*value*/</span><span style="color: var(--shiki-color-text)"> ctx[</span><span style="color: var(--shiki-token-constant)">0</span><span style="color: var(--shiki-color-text)">] &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> &#123;&#125;];</span></span>
<span class="line inserted"><span style="color: var(--shiki-color-text)"> 	</span><span style="color: var(--shiki-token-keyword)">let</span><span style="color: var(--shiki-color-text)"> select_data </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> &#123;&#125;;</span></span>
<span class="line inserted"><span style="color: var(--shiki-color-text)"> 	</span><span style="color: var(--shiki-token-keyword)">for</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-keyword)">let</span><span style="color: var(--shiki-color-text)"> i </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">0</span><span style="color: var(--shiki-color-text)">; i </span><span style="color: var(--shiki-token-keyword)">&lt;</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">select_levels</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">length</span><span style="color: var(--shiki-color-text)">; i </span><span style="color: var(--shiki-token-keyword)">+=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">1</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line inserted"><span style="color: var(--shiki-color-text)"> 	  select_data </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">assign</span><span style="color: var(--shiki-color-text)">(select_data</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> select_levels[i]);</span></span>
<span class="line inserted"><span style="color: var(--shiki-color-text)"> 	&#125;</span></span>
<span class="line deleted"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">let</span><span style="color: var(--shiki-color-text)"> select_value_value;</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">c</span><span style="color: var(--shiki-color-text)">() &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-comment)">/* ... */</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-function)">set_attributes</span><span style="color: var(--shiki-color-text)">(select</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> select_data);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">m</span><span style="color: var(--shiki-color-text)">(target</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> anchor) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-comment)">/* ... */</span></span>
<span class="line deleted"><span style="color: var(--shiki-color-text)">      select_value_value </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-comment)">/*value*/</span><span style="color: var(--shiki-color-text)"> ctx[</span><span style="color: var(--shiki-token-constant)">0</span><span style="color: var(--shiki-color-text)">];</span></span>
<span class="line"></span>
<span class="line deleted"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-keyword)">for</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-keyword)">var</span><span style="color: var(--shiki-color-text)"> i </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">0</span><span style="color: var(--shiki-color-text)">; i </span><span style="color: var(--shiki-token-keyword)">&lt;</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">select</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">options</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">length</span><span style="color: var(--shiki-color-text)">; i </span><span style="color: var(--shiki-token-keyword)">+=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">1</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line deleted"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-keyword)">var</span><span style="color: var(--shiki-color-text)"> option </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">select</span><span style="color: var(--shiki-color-text)">.options[i];</span></span>
<span class="line deleted"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-constant)">option</span><span style="color: var(--shiki-color-text)">.selected </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">~</span><span style="color: var(--shiki-token-constant)">select_value_value</span><span style="color: var(--shiki-token-function)">.indexOf</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-constant)">option</span><span style="color: var(--shiki-color-text)">.__value);</span></span>
<span class="line deleted"><span style="color: var(--shiki-color-text)">      &#125;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line deleted"><span style="color: var(--shiki-color-text)">    p</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> noop</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line inserted"><span style="color: var(--shiki-color-text)">     </span><span style="color: var(--shiki-token-function)">p</span><span style="color: var(--shiki-color-text)">(ctx</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> [dirty]) &#123;</span></span>
<span class="line inserted"><span style="color: var(--shiki-color-text)">       </span><span style="color: var(--shiki-token-function)">set_attributes</span><span style="color: var(--shiki-color-text)">(select</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">get_spread_update</span><span style="color: var(--shiki-color-text)">(select_levels</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> [&#123; multiple</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)">   </span><span style="color: var(--shiki-token-constant)">true</span><span style="color: var(--shiki-color-text)"> &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> dirty </span><span style="color: var(--shiki-token-keyword)">&amp;</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-comment)">/*value*/</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">1</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">&amp;&amp;</span><span style="color: var(--shiki-color-text)"> &#123; value</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-comment)">/*value*/</span><span style="color: var(--shiki-color-text)"> ctx[</span><span style="color: var(--shiki-token-constant)">0</span><span style="color: var(--shiki-color-text)">] &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> &#123;&#125;]));</span></span>
<span class="line inserted"><span style="color: var(--shiki-color-text)">     &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">/* ... */</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125;;</span></span></code></pre><!----></div> <p>Well, I know I haven't cover how spread attribute works in any of my <a href="/compile-svelte-in-your-head-part-1/">"Compile Svelte in your Head"</a> articles, but the general idea is that, Svelte builds an array of attributes, and then apply it to the element / Component.</p> <p>For example, if we write the following in Svelte</p> <div class="code-section"><!----><pre class="prism language-svelte"><code><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">foo</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>foo<span class="token punctuation">"</span></span> <span class="token language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">...</span>bar<span class="token punctuation">&#125;</span></span> <span class="token attr-name">baz</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>baz<span class="token punctuation">"</span></span> <span class="token language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">...</span>qux<span class="token punctuation">&#125;</span></span> <span class="token punctuation">/></span></span></div></code></pre><!----></div> <p>It gets compiled to something like this:</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">levels</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> [&#123; foo</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;foo&#39;</span><span style="color: var(--shiki-color-text)"> &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> bar</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> &#123; baz</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;baz&#39;</span><span style="color: var(--shiki-color-text)"> &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> qux];</span></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// build the attribute maps</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">data</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> &#123;&#125;;</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">for</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-keyword)">let</span><span style="color: var(--shiki-color-text)"> i </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">0</span><span style="color: var(--shiki-color-text)">; i </span><span style="color: var(--shiki-token-keyword)">&lt;</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">levels</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">length</span><span style="color: var(--shiki-color-text)">; i</span><span style="color: var(--shiki-token-keyword)">++</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  data </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">Object</span><span style="color: var(--shiki-token-function)">.assign</span><span style="color: var(--shiki-color-text)">(data</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> levels[i]);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// set attribute to element</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">for</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">attributeName</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">in</span><span style="color: var(--shiki-color-text)"> data) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-constant)">div</span><span style="color: var(--shiki-token-function)">.setAttribute</span><span style="color: var(--shiki-color-text)">(attributeName</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> data[attributeName]);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// if &#96;bar&#96; changed</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">updates</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">get_spread_update</span><span style="color: var(--shiki-color-text)">(levels</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> [</span><span style="color: var(--shiki-token-constant)">false</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> bar</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">false</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">false</span><span style="color: var(--shiki-color-text)">]);</span></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// updates will return the updates needed to make, in this case, the diff in &#96;bar&#96;, eg: &#123; aa: &#39;1&#39; &#125;</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">for</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">attributeName</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">in</span><span style="color: var(--shiki-color-text)"> updates) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-constant)">div</span><span style="color: var(--shiki-token-function)">.setAttribute</span><span style="color: var(--shiki-color-text)">(attributeName</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> updates[attributeName]);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!----></div> <p>So, this roughly explains the additional code added into the <code class="inline">bundle.js</code> for handling spread attributes.</p> <p>However the code that is removed, is something I am not familiar with.</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-comment)">// in &#96;mount&#96; method</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">for</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-keyword)">var</span><span style="color: var(--shiki-color-text)"> i </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">0</span><span style="color: var(--shiki-color-text)">; i </span><span style="color: var(--shiki-token-keyword)">&lt;</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">select</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">options</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">length</span><span style="color: var(--shiki-color-text)">; i </span><span style="color: var(--shiki-token-keyword)">+=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">1</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">var</span><span style="color: var(--shiki-color-text)"> option </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">select</span><span style="color: var(--shiki-color-text)">.options[i];</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-constant)">option</span><span style="color: var(--shiki-color-text)">.selected </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">~</span><span style="color: var(--shiki-token-constant)">select_value_value</span><span style="color: var(--shiki-token-function)">.indexOf</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-constant)">option</span><span style="color: var(--shiki-color-text)">.__value);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!----></div> <p>It seems like we are trying to set <code class="inline">option.selected</code> after we mount the <code class="inline">&lt;select></code> element. Not sure how important is that to us.</p> <p>To verify that the bug is because that the above code snippet is missing when having a spread attribute, I tried adding the code snippet into the <code class="inline">bundle.js</code> manually, and refresh the page.</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-function)">m</span><span style="color: var(--shiki-color-text)">(target</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> anchor) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">insert</span><span style="color: var(--shiki-color-text)">(target</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> select</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> anchor);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">append</span><span style="color: var(--shiki-color-text)">(select</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> option0);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">append</span><span style="color: var(--shiki-color-text)">(select</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> option1);</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">for</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-keyword)">var</span><span style="color: var(--shiki-color-text)"> i </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">0</span><span style="color: var(--shiki-color-text)">; i </span><span style="color: var(--shiki-token-keyword)">&lt;</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">select</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">options</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">length</span><span style="color: var(--shiki-color-text)">; i </span><span style="color: var(--shiki-token-keyword)">+=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">1</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-keyword)">var</span><span style="color: var(--shiki-color-text)"> option </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">select</span><span style="color: var(--shiki-color-text)">.options[i];</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-constant)">option</span><span style="color: var(--shiki-color-text)">.selected </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">~</span><span style="color: var(--shiki-color-text)">ctx[</span><span style="color: var(--shiki-token-constant)">0</span><span style="color: var(--shiki-color-text)">]</span><span style="color: var(--shiki-token-function)">.indexOf</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-constant)">option</span><span style="color: var(--shiki-color-text)">.__value);</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">    &#125;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span></code></pre><!----></div> <p>Instead of <code class="inline">~select_value_value.indexOf(...)</code>, I changed it to <code class="inline">~ctx[0].indexOf(...)</code>, as <code class="inline">select_value_value</code> wasn't created when using spread attribute.</p> <p>...and it works!</p> <p><span style="display: block; position: relative; padding-top: 58.266%; width: 100%;"><picture><source type="image/webp" srcset="https://lihautan.com/_app/immutable/assets/fixed.B2IwkBVx.webp, https://lihautan.com/_app/immutable/assets/fixed.FqJuJ3lN.webp 2x"/><img src="https://lihautan.com/_app/immutable/assets/fixed.4ZDRTC6o.png" srcset="https://lihautan.com/_app/immutable/assets/fixed.4ZDRTC6o.png, https://lihautan.com/_app/immutable/assets/fixed.DmxDyUgL.png 2x" loading="lazy" style="position: absolute; top: 0; width: 100%; height: 100%" alt="Fixed"/></picture></span></p> <p>So, now we know that the bug is caused by missing setting <code class="inline">option.selected</code> on mount, now its time to figure out what the code snippet is not generated when there's a spread attribute.</p> <p>To quickly find out why something is not generated, I tried to look for where it is generated, figuring out probably whether certain condition was not set correctly to cause the Svelte compiler to omit out the code snippet.</p> <p>To find the right place to start looking is an art. Usually I try to global search a small snippet of code that is <strong>most likely static</strong>, something that has no variable name, for example:</p> <ul><li><code class="inline">.indexOf(option.__value)</code></li> <li><code class="inline">.options.length;</code></li> <li><code class="inline">.selected = ~</code></li></ul> <p>The only search result I got when searching for <code class="inline">.indexOf(option.__value)</code> is in <a href="https://github.com/sveltejs/svelte/blob/e34f2088434423914bbc91b84a450a7f7477252b/src/runtime/internal/dom.ts#L221-L226" rel="nofollow">src/runtime/internal/dom.ts</a></p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">export</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">select_options</span><span style="color: var(--shiki-color-text)">(select</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> value) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">for</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-keyword)">let</span><span style="color: var(--shiki-color-text)"> i </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">0</span><span style="color: var(--shiki-color-text)">; i </span><span style="color: var(--shiki-token-keyword)">&lt;</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">select</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">options</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">length</span><span style="color: var(--shiki-color-text)">; i </span><span style="color: var(--shiki-token-keyword)">+=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">1</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">option</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">select</span><span style="color: var(--shiki-color-text)">.options[i];</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">option</span><span style="color: var(--shiki-color-text)">.selected </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">~</span><span style="color: var(--shiki-token-constant)">value</span><span style="color: var(--shiki-token-function)">.indexOf</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-constant)">option</span><span style="color: var(--shiki-color-text)">.__value);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!----></div> <p>Anything within <code class="inline">src/runtime/</code> are helper functions that are referenced from the output code, to reduce the output code size. Hmm... probably we should reuse the <code class="inline">select_options</code> helper function:</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-function)">m</span><span style="color: var(--shiki-color-text)">(target</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> anchor) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">insert</span><span style="color: var(--shiki-color-text)">(target</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> select</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> anchor);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">append</span><span style="color: var(--shiki-color-text)">(select</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> option0);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-function)">append</span><span style="color: var(--shiki-color-text)">(select</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> option1);</span></span>
<span class="line highlight"><span style="color: var(--shiki-token-keyword)">-</span><span style="color: var(--shiki-color-text)">   </span><span style="color: var(--shiki-token-keyword)">for</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-keyword)">var</span><span style="color: var(--shiki-color-text)"> i </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">0</span><span style="color: var(--shiki-color-text)">; i </span><span style="color: var(--shiki-token-keyword)">&lt;</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">select</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">options</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">length</span><span style="color: var(--shiki-color-text)">; i </span><span style="color: var(--shiki-token-keyword)">+=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">1</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line highlight"><span style="color: var(--shiki-token-keyword)">-</span><span style="color: var(--shiki-color-text)">     </span><span style="color: var(--shiki-token-keyword)">var</span><span style="color: var(--shiki-color-text)"> option </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">select</span><span style="color: var(--shiki-color-text)">.options[i];</span></span>
<span class="line highlight"><span style="color: var(--shiki-token-keyword)">-</span><span style="color: var(--shiki-color-text)">     </span><span style="color: var(--shiki-token-constant)">option</span><span style="color: var(--shiki-color-text)">.selected </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">~</span><span style="color: var(--shiki-color-text)">ctx[</span><span style="color: var(--shiki-token-constant)">0</span><span style="color: var(--shiki-color-text)">]</span><span style="color: var(--shiki-token-function)">.indexOf</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-constant)">option</span><span style="color: var(--shiki-color-text)">.__value);</span></span>
<span class="line highlight"><span style="color: var(--shiki-token-keyword)">-</span><span style="color: var(--shiki-color-text)">   &#125;</span></span>
<span class="line highlight"><span style="color: var(--shiki-token-keyword)">+</span><span style="color: var(--shiki-color-text)">   </span><span style="color: var(--shiki-token-function)">select_options</span><span style="color: var(--shiki-color-text)">(select</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> select_value_value);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span></code></pre><!----></div> <p>Anyway, <code class="inline">src/runtime/internal/dom.ts</code> is not where I am looking for, so I tried searching <code class="inline">.options.length</code></p> <div class="code-section"><!----><div class="filename">src/compiler/compile/render_dom/wrappers/Element/Attribute.ts</div><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-color-text)">updater </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">  for (var </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">i</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)"> = 0; </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">i</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)"> &lt; </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">element</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.options.length; </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">i</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)"> += 1) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">    var </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">option</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)"> = </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">element</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.options[</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">i</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">];</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">    </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">if_statement</span><span style="color: var(--shiki-token-keyword)">&#125;</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">  &#125;</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">&#96;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">mount</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">  </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">last</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)"> = </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">value</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">;</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">  </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">updater</span><span style="color: var(--shiki-token-keyword)">&#125;</span></span>
<span class="line"><span style="color: var(--shiki-token-string-expression)">&#96;</span><span style="color: var(--shiki-color-text)">);</span></span></code></pre><!----></div> <p>Yes, this is most likely where it is.</p> <p>Firstly, let me update the <code class="inline">updater</code> to use the <code class="inline">src/runtime/</code> <code class="inline">select_options</code> helper instead:</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line highlight"><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (is_multiple_select) &#123;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  updater </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;@select_options(</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">element</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">, </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">last</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">);&#96;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">&#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  updater </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;@select_option(</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">element</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">, </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">last</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">);&#96;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">&#125;</span></span>
<span class="line dim"></span>
<span class="line dim"><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">mount</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;</span></span>
<span class="line dim"><span style="color: var(--shiki-token-string-expression)">  </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">last</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)"> = </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">value</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">;</span></span>
<span class="line dim"><span style="color: var(--shiki-token-string-expression)">  </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">updater</span><span style="color: var(--shiki-token-keyword)">&#125;</span></span>
<span class="line dim"><span style="color: var(--shiki-token-string-expression)">&#96;</span><span style="color: var(--shiki-color-text)">);</span></span></code></pre><!----></div> <p>The <code class="inline">b`...`</code>, is called a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals#Tagged_templates" rel="nofollow">tagged template</a>, where the <code class="inline">b</code> is a function that takes in the template literal and return something. In this case, the <code class="inline">b</code> function returns an <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" rel="nofollow">Abstract Syntaxt Tree (AST)</a>.</p> <p>The <code class="inline">b</code> function comes from <a href="https://www.npmjs.com/package/code-red" rel="nofollow">code-red</a>, a utility to generate a JavaScript AST node. Beside <code class="inline">b</code>, <code class="inline">code-red</code> provides a few helper functions:</p> <ul><li><code class="inline">b</code> returns a block node</li> <li><code class="inline">x</code> returns an expression node</li> <li><code class="inline">p</code> returns a object property node</li></ul> <p>These helper functions are useful in generating code in Svelte compiler, particularly because the placeholder itself can takes in another AST node:</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">node</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> &#123; type</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;Identifier&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> name</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;foo&#39;</span><span style="color: var(--shiki-color-text)"> &#125;;</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">code</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;const </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">node</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)"> = 1;&#96;</span><span style="color: var(--shiki-color-text)">; </span><span style="color: var(--shiki-token-comment)">// returns an AST node for &#96;const foo = 1;&#96;</span></span></code></pre><!----></div> <p><code class="inline">@</code> in front of <code class="inline">@select_option</code> is a convention in Svelte, where it will <a href="https://github.com/sveltejs/svelte/blob/e34f2088434423914bbc91b84a450a7f7477252b/src/compiler/compile/Component.ts#L245-L264" rel="nofollow">get replaced</a> to refer to helpr functions in <code class="inline">src/runtime/</code> before writing the generated AST out:</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">code</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;@foo(bar)&#96;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// turns into</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// import &#123; foo &#125; from &#39;svelte/internal&#39;;</span></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// foo(bar);</span></span></code></pre><!----></div> <p>Coming back to figure out why this piece of code is not executed when there's a spread attribute,</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line highlight"><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (is_legacy_input_type) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">&#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (is_select_value_attribute) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (is_multiple_select) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    updater </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;@select_options(</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">element</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">, </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">last</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">);&#96;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    updater </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;@select_option(</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">element</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">, </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">last</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">);&#96;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125;</span></span>
<span class="line dim"></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">mount</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;</span></span>
<span class="line dim"><span style="color: var(--shiki-token-string-expression)">    </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">last</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)"> = </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">value</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">;</span></span>
<span class="line dim"><span style="color: var(--shiki-token-string-expression)">    </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">updater</span><span style="color: var(--shiki-token-keyword)">&#125;</span></span>
<span class="line dim"><span style="color: var(--shiki-token-string-expression)">  &#96;</span><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (is_src) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!----></div> <p>I tried adding <code class="inline">console.log</code> before the if statement, to figure out the value for <code class="inline">is_legacy_input_type</code> and <code class="inline">is_select_value_attribute</code>:</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line highlight"><span style="color: var(--shiki-token-constant)">console</span><span style="color: var(--shiki-token-function)">.log</span><span style="color: var(--shiki-color-text)">(</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-string-expression)">&#39;is_legacy_input_type:&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  is_legacy_input_type</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-string-expression)">&#39;is_select_value_attribute:&#39;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  is_select_value_attribute</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line dim"><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (is_legacy_input_type) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!----></div> <p>To my surpise, there was no log. <code class="inline">AttributeWrapper#render</code> wasn't executed.</p> <p>I tried removing the spread attribute, and verified from the log that the <code class="inline">AttributeWrapper#render</code> method was indeed executed when there's no spread attribute.</p> <p>To figure out the caller of the <code class="inline">AttributeWrapper#render</code> method, I added <code class="inline">console.trace</code> at the top of the method:</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-token-function)">render</span><span style="color: var(--shiki-color-text)">(block: Block) &#123;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-constant)">console</span><span style="color: var(--shiki-token-function)">.trace</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&#39;trace&#39;</span><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!----></div> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-color-text)">Trace: trace</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  at AttributeWrapper.render (/Projects/svelte/compiler.js:8269:11)</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  at /Projects/svelte/compiler.js:10749:14</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  at Array.forEach (&lt;anonymous&gt;)</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  at ElementWrapper.add_attributes (/Projects/svelte/compiler.js:10748:19)</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  at ElementWrapper.render (/Projects/svelte/compiler.js:10472:8)</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  at /Projects/svelte/compiler.js:10454:11</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  at Array.forEach (&lt;anonymous&gt;)</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  at ElementWrapper.render (/Projects/svelte/compiler.js:10453:24)</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  at FragmentWrapper.render (/Projects/svelte/compiler.js:13030:18)</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  at new Renderer (/Projects/svelte/compiler.js:13112:17)</span></span></code></pre><!----></div> <p>This brought me to <a href="https://github.com/sveltejs/svelte/blob/e34f2088434423914bbc91b84a450a7f7477252b/src/compiler/compile/render_dom/wrappers/Element/index.ts#L642-L659" rel="nofollow">src/compiler/compile/render_dom/wrappers/Element/index.ts</a></p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-token-function)">add_attributes</span><span style="color: var(--shiki-color-text)">(block: Block) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// Get all the class dependencies first</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">attributes</span><span style="color: var(--shiki-token-function)">.forEach</span><span style="color: var(--shiki-color-text)">((attribute) </span><span style="color: var(--shiki-token-keyword)">=&gt;</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">attribute</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">node</span><span style="color: var(--shiki-color-text)">.name </span><span style="color: var(--shiki-token-keyword)">===</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;class&#39;</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">dependencies</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">attribute</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">node</span><span style="color: var(--shiki-token-function)">.get_dependencies</span><span style="color: var(--shiki-color-text)">();</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">class_dependencies</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-keyword)">...</span><span style="color: var(--shiki-color-text)">dependencies);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    &#125;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125;);</span></span>
<span class="line dim"></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">node</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">attributes</span><span style="color: var(--shiki-token-function)">.some</span><span style="color: var(--shiki-color-text)">(attr </span><span style="color: var(--shiki-token-keyword)">=&gt;</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">attr</span><span style="color: var(--shiki-color-text)">.is_spread)) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-token-function)">.add_spread_attributes</span><span style="color: var(--shiki-color-text)">(block);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125;</span></span>
<span class="line dim"></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">attributes</span><span style="color: var(--shiki-token-function)">.forEach</span><span style="color: var(--shiki-color-text)">((attribute) </span><span style="color: var(--shiki-token-keyword)">=&gt;</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">attribute</span><span style="color: var(--shiki-token-function)">.render</span><span style="color: var(--shiki-color-text)">(block);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125;);</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!----></div> <p>If there's a spread attribute, it will call the <code class="inline">this.node.attributes.some(attr => attr.is_spread)</code> method instead of calling <code class="inline">attribute.render(block)</code>, so that's probably why <code class="inline">AttributeWrapper#render</code> wasn't called.</p> <p>I looked into the method <code class="inline">add_spread_attributes</code>, found out it contain only the code about handling spread attributes as I explained earlier. It didn't have any code related to <code class="inline">select_options</code>, so I figured that, maybe <code class="inline">&lt;select multiple></code> with spread attribute is an edge case that wasn't handled currently at all.</p> <p>So, I tried to add a special check for this case at the bottom of the <code class="inline">add_spread_attributes</code> method:</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-token-function)">add_spread_attributes</span><span style="color: var(--shiki-color-text)">(block: Block) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// for &#96;&lt;select&gt;&#96; element only</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">node</span><span style="color: var(--shiki-color-text)">.name </span><span style="color: var(--shiki-token-keyword)">===</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;select&#39;</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">mount</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;@select_options(</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">, </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">data</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.value);&#96;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">    );</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  &#125;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!----></div> <p>As mentioned in the <a href="/the-svelte-compiler-handbook/#dom-renderer">The Svelte Compiler Handbook</a>, a <code class="inline">block</code> is where it keeps the code to generate the <a href="/compile-svelte-in-your-head-part-1/#create_fragment"><code class="inline">create_fragment</code></a> function. The return object of the <code class="inline">create_fragment</code> function contains various method as mentioned in <a href="/compile-svelte-in-your-head-part-1/#create_fragment">Compile Svelte in your Head</a>, such as <code class="inline">c()</code>, <code class="inline">m()</code> and <code class="inline">d()</code>. To add code into different method, you can push them into the array in <code class="inline">block.chunks</code>, for example:</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-comment)">// push &#96;const foo = 1&#96; to &#96;m()&#96;</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">mount</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;const foo = 1&#96;</span><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// push &#96;const bar = 2&#96; to &#96;c()&#96;</span></span>
<span class="line"><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">create</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;const bar = 2&#96;</span><span style="color: var(--shiki-color-text)">);</span></span></code></pre><!----></div> <p>I tried adding <code class="inline">@select_options(...)</code> into the <code class="inline">m()</code> method and yup, the <code class="inline">&lt;select></code> element is pre-selected correctly!</p></section> <section><h2><a href="#fixing-the-bug" id="fixing-the-bug">Fixing the bug</a></h2> <p>To ensure the bug is fixed, I need to come up with a test.</p> <p>Usually I come up with test cases that try to entail various scenario I can imagine.</p> <p>In this example, we've manually tested the case where the <code class="inline">&lt;select multiple {value} {...{}}></code>, the value is set correctly during initialisation. but have we check the case where:</p> <ul><li>we update the value of <code class="inline">value</code>, will the <code class="inline">&lt;select></code> get updated accordingly?</li> <li>if the value is overriden by the spreaded attribute, eg <code class="inline">&lt;select mutliple {value} { ...{value: []} }></code>?</li></ul> <p>Ideally, the test cases come up should be failed before the fix, and passed after the fix.</p> <p>So here's the test case I came up:</p> <div class="code-section"><!----><pre class="prism language-svelte"><code><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"></div><div class="line">  <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Hello'</span><span class="token punctuation">,</span> <span class="token string">'World'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></div><div class="line">  <span class="token keyword">export</span> <span class="token keyword">let</span> spread <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></div><div class="line"></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></div><div class="line"></div><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">multiple</span> <span class="token language-javascript"><span class="token punctuation">&#123;</span>value<span class="token punctuation">&#125;</span></span> <span class="token language-javascript"><span class="token punctuation">&#123;</span><span class="token operator">...</span>spread<span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span></div><div class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span><span class="token punctuation">></span></span>Hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span></div><div class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span><span class="token punctuation">></span></span>World<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span></div><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span></div><div class="line"></div><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Hello<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">bind:</span>group=</span><span class="token language-javascript"><span class="token punctuation">&#123;</span>value<span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span></div><div class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>World<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">bind:</span>group=</span><span class="token language-javascript"><span class="token punctuation">&#123;</span>value<span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span></div></code></pre><!----></div> <p>I can check and uncheck the checkbox to change the value of <code class="inline">value</code> to verify the the <code class="inline">value</code> is reactive, and <code class="inline">&lt;select></code> will get updated accordingly.</p> <p>Besides that, I exported <code class="inline">spread</code>, so that I can change the object to something object to contain <code class="inline">value</code>, eg: <code class="inline">{ value: [] }</code>, and see how <code class="inline">&lt;select></code> will update accordingly. Make sure that our fix not just work with <code class="inline">value</code> attribute, and also when the <code class="inline">value</code> is spreaded into <code class="inline">&lt;select></code>.</p> <p>You may think that we are familiar with our fix, we know what it will fix, what it will not fix, do we need think up and write all the edge cases?</p> <p>Well, I think you should. Future you will thank the present you when he encounter a fail test, that just mean his change may have an unintentional regression change. If you don't have the test case, the future you will never know what edge case he didn't accounted for.</p> <p>Runtime test cases are added into <code class="inline">test/runtime/samples/</code>. Each folder represent 1 test case. Inside the folder, the component to be tested is named <code class="inline">App.svelte</code>, and the test case is written <code class="inline">_config.js</code>.</p> <p><code class="inline">_config.js</code> default exports a object:</p> <div class="code-section"><!----><div class="filename">_config.js</div><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">export</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">default</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// initial props to passed to the component</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  props</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> &#123; </span><span style="color: var(--shiki-token-comment)">/*...*/</span><span style="color: var(--shiki-color-text)"> &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// initial rendered html</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  html</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#96;&#96;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// test case</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">async</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">test</span><span style="color: var(--shiki-color-text)">(&#123; assert</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> target &#125;) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// you can test the behavior of the component here</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;;</span></span></code></pre><!----></div> <p>An example of test case of unchecking the checkbox, and verify <code class="inline">&lt;select></code> value get updated</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">export</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">default</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">	</span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">	</span><span style="color: var(--shiki-token-keyword)">async</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">test</span><span style="color: var(--shiki-color-text)">(&#123; assert</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> target</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> window &#125;) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// find the element</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">		</span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> [</span><span style="color: var(--shiki-token-constant)">input1</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">input2</span><span style="color: var(--shiki-color-text)">] </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">target</span><span style="color: var(--shiki-token-function)">.querySelectorAll</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&quot;input&quot;</span><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">		</span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">select</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">target</span><span style="color: var(--shiki-token-function)">.querySelector</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&quot;select&quot;</span><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">		</span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> [</span><span style="color: var(--shiki-token-constant)">option1</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">option2</span><span style="color: var(--shiki-color-text)">] </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">select</span><span style="color: var(--shiki-color-text)">.childNodes;</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// uncheck the checkbox</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">		</span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">event</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">new</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">window</span><span style="color: var(--shiki-token-function)">.Event</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&quot;change&quot;</span><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">		</span><span style="color: var(--shiki-token-constant)">input1</span><span style="color: var(--shiki-color-text)">.checked </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">false</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">		</span><span style="color: var(--shiki-token-keyword)">await</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">input1</span><span style="color: var(--shiki-token-function)">.dispatchEvent</span><span style="color: var(--shiki-color-text)">(event);</span></span>
<span class="line"></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// verify the component updated correctly</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">		</span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">selections</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">Array</span><span style="color: var(--shiki-token-function)">.from</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-constant)">select</span><span style="color: var(--shiki-color-text)">.selectedOptions);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">		</span><span style="color: var(--shiki-token-constant)">assert</span><span style="color: var(--shiki-token-function)">.equal</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-constant)">selections</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">length</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">1</span><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">		</span><span style="color: var(--shiki-token-constant)">assert</span><span style="color: var(--shiki-token-function)">.ok</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-keyword)">!</span><span style="color: var(--shiki-token-constant)">selections</span><span style="color: var(--shiki-token-function)">.includes</span><span style="color: var(--shiki-color-text)">(option1));</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">		</span><span style="color: var(--shiki-token-constant)">assert</span><span style="color: var(--shiki-token-function)">.ok</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-constant)">selections</span><span style="color: var(--shiki-token-function)">.includes</span><span style="color: var(--shiki-color-text)">(option2));</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">	&#125;</span><span style="color: var(--shiki-token-punctuation)">,</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;;</span></span></code></pre><!----></div> <p>To run only this test, so that we can focus on ensuring the test case pass, we can set <code class="inline">solo: true</code>:</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-token-keyword)">export</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">default</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">  solo</span><span style="color: var(--shiki-token-keyword)">:</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">true</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;;</span></span></code></pre><!----></div> <p><strong>Quick tip:</strong> running <code class="inline">npm run test</code> will build Svelte code first before executing the test. If you are like me, running <code class="inline">npm run dev</code> on the background, Svelte code is build on every code change. So, <code class="inline">npm run quicktest</code> would allow you to skip the <code class="inline">pretest</code> build, and run the test suite immediately.</p> <p>With the test, I realised that I didn't handle the case when the <code class="inline">value</code> is updated.</p> <p>So I guess what I needed to do is to add the same code in the <code class="inline">p()</code> (update) method too!</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-token-function)">add_spread_attributes</span><span style="color: var(--shiki-color-text)">(block: Block) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">node</span><span style="color: var(--shiki-color-text)">.name </span><span style="color: var(--shiki-token-keyword)">===</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;select&#39;</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">mount</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;@select_options(</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">, </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">data</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.value);&#96;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    );</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">update</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;@select_options(</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">, </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">data</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.value);&#96;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">    );</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!----></div> <p>Well, of course in this way, the <code class="inline">select_options</code> get executed unconditionally whenever any variable is updated.</p> <p>I need to make sure that the <code class="inline">select_options(...)</code> inside the <code class="inline">p()</code> method get executed only when the value of <code class="inline">value</code> changes, and also probably when <code class="inline">spread</code> changes too, because it could potentially override the value of <code class="inline">value</code>.</p> <p>If you've read <a href="/compile-svelte-in-your-head-part-2/#bitmask-in-svelte">Compile Svelte in your Head - Bitmask in Svelte</a>, you know that Svelte uses bitmask to check any variable changes.</p> <p>How do I know what is the bitmask to use in this case, well I dont have to.</p> <p>I can use <a href="https://github.com/sveltejs/svelte/blob/e34f2088434423914bbc91b84a450a7f7477252b/src/compiler/compile/render_dom/Renderer.ts#L206" rel="nofollow"><code class="inline">renderer.dirty(dependencies)</code></a> to help me with that:</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-token-function)">add_spread_attributes</span><span style="color: var(--shiki-color-text)">(block: Block) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">node</span><span style="color: var(--shiki-color-text)">.name </span><span style="color: var(--shiki-token-keyword)">===</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;select&#39;</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">dependencies</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> [</span><span style="color: var(--shiki-token-keyword)">...</span><span style="color: var(--shiki-color-text)">];</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">mount</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;@select_options(</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">, </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">data</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.value);&#96;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    );</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">update</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-comment)">// block.renderer.dirty(...) will give me &#96;dirty &amp; bitmask&#96;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;if (</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">renderer</span><span style="color: var(--shiki-token-function)">.dirty</span><span style="color: var(--shiki-color-text)">(dependencies)</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">) @select_options(</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">, </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">data</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.value);&#96;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">    );</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!----></div> <p>Next, I need to figure out what are the dependencies to be included. In this particular case, the dependencies of all attributes have to be taken consideration, because it is hard to tell which one would be eventually applied due to the spread attribute.</p> <div class="code-section"><!----><pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line dim"><span style="color: var(--shiki-token-function)">add_spread_attributes</span><span style="color: var(--shiki-color-text)">(block: Block) &#123;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">node</span><span style="color: var(--shiki-color-text)">.name </span><span style="color: var(--shiki-token-keyword)">===</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;select&#39;</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">dependencies</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">new</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">Set</span><span style="color: var(--shiki-color-text)">();</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">for</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">attr</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">of</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.attributes) &#123;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-keyword)">for</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">dep</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">of</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">attr</span><span style="color: var(--shiki-color-text)">.</span><span style="color: var(--shiki-token-constant)">node</span><span style="color: var(--shiki-color-text)">.dependencies) &#123;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-constant)">dependencies</span><span style="color: var(--shiki-token-function)">.add</span><span style="color: var(--shiki-color-text)">(dep);</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">      &#125;</span></span>
<span class="line highlight"><span style="color: var(--shiki-color-text)">    &#125;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">mount</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;@select_options(</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">, </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">data</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.value);&#96;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    );</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">chunks</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">update</span><span style="color: var(--shiki-token-function)">.push</span><span style="color: var(--shiki-color-text)">(</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-function)">b</span><span style="color: var(--shiki-token-string-expression)">&#96;if (</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">block</span><span style="color: var(--shiki-token-function)">.</span><span style="color: var(--shiki-token-constant)">renderer</span><span style="color: var(--shiki-token-function)">.dirty</span><span style="color: var(--shiki-color-text)">(dependencies)</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">) @select_options(</span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.var</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">, </span><span style="color: var(--shiki-token-keyword)">$&#123;</span><span style="color: var(--shiki-color-text)">data</span><span style="color: var(--shiki-token-keyword)">&#125;</span><span style="color: var(--shiki-token-string-expression)">.value);&#96;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">    );</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">  &#125;</span></span>
<span class="line dim"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre><!----></div> <p>After a few tweaks, finally I passed all my test cases, and its time to create a pull request!</p></section> <section><h2><a href="#submitting-the-fix" id="submitting-the-fix">Submitting the fix</a></h2> <p>Before pushing the fix to remote, it is important to make sure that all the lints and typescript definitions are correct. You can run <code class="inline">npm run lint --fixed</code> for linting, and <code class="inline">npm run tsd</code> to generate typescript definition.</p> <p>If you are unsure on how to create a pull request, you can check out <a href="https://www.freecodecamp.org/news/how-to-make-your-first-pull-request-on-github-3/" rel="nofollow">How to make your first pull request on GitHub</a>.</p> <p>I pushed my branch and created a <a href="https://github.com/sveltejs/svelte/pull/4894" rel="nofollow">Pull Request to Svelte</a>, and now I am waiting for feedback and for it to get merged.</p> <p>Svelte is not maintained by full-time maintainers, everyone has their full-time job, so please be patient and be nice.</p> <hr/> <p>If you wish to learn more about Svelte, <a href="https://twitter.com/lihautan" rel="nofollow">follow me on Twitter</a>.</p> <p>If you have anything unclear about this article, find me on <a href="https://twitter.com/lihautan" rel="nofollow">Twitter</a> too!</p></section><!----></article> <!--[--><div style="height: 1px; width: 100%"></div><!--]--> <!--[!--><!--]--><!----><!----><!----></main> <footer class="svelte-1x8iuzz"><!--[--><!--]--></footer><!----><!--]--><!----><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_nf1wji = {
						base: new URL(".", location).pathname.slice(0, -1),
						assets: "https://lihautan.com"
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("https://lihautan.com/_app/immutable/entry/start.CvTXASZI.js"),
						import("https://lihautan.com/_app/immutable/entry/app._8dSQ1Bw.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 2, 24],
							data: [null,null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
