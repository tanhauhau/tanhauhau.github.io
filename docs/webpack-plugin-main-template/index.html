<!DOCTYPE html>
<html lang="en">

<head>
  <meta charSet="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link href="https://lihautan.com" rel="me">
  <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300&display=swap"
    rel="stylesheet">
  <style>
    html {
      font-family: 'Lato', sans-serif;
      font-weight: 300;
      font-size: 19px;
      background: linear-gradient(0deg, transparent, #bd93f917, transparent);
    }

    html,
    body {
      margin: 0;
      padding: 0;
    }

    :root {
      --prism-padding: 20px;
      --margin: 1.62em;
      --box-shadow-size: 6px;
      --box-shadow: var(--box-shadow-size) var(--box-shadow-size) var(--primary-color);
      --box-shadow-hover: 10px 10px var(--primary-color);
      --easing: 200ms ease-in-out;
      --primary-color: #bd93f9;
      --secondary-color: #9547b7;
      --dark-color: #282936;
    }
  </style>

  
  <title>Webpack&#39;s TemplatePlugin | Tan Li Hau</title><meta name="description" data-svelte="svelte-n0q11s"><meta name="image" data-svelte="svelte-n0q11s"><meta name="og:image" data-svelte="svelte-n0q11s"><meta name="og:title" content="Webpack&#39;s TemplatePlugin" data-svelte="svelte-n0q11s"><meta name="og:description" data-svelte="svelte-n0q11s"><meta name="og:type" content="website" data-svelte="svelte-n0q11s"><meta name="twitter:card" content="summary_large_image" data-svelte="svelte-n0q11s"><meta name="twitter:creator" content="@lihautan" data-svelte="svelte-n0q11s"><meta name="twitter:title" content="Webpack&#39;s TemplatePlugin" data-svelte="svelte-n0q11s"><meta name="twitter:description" data-svelte="svelte-n0q11s"><meta name="twitter:image" data-svelte="svelte-n0q11s"><meta itemprop="url" content="https%3A%2F%2Flihautan.com%2Fwebpack-plugin-main-template" data-svelte="svelte-n0q11s"><meta itemprop="image" data-svelte="svelte-n0q11s"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","author":{"@type":"Person","name":"Tan Li Hau"},"copyrightHolder":{"@type":"Person","name":"Tan Li Hau"},"copyrightYear":"2020","creator":{"@type":"Person","name":"Tan Li Hau"},"publisher":{"@type":"Person","name":"Tan Li Hau"},"headline":"Webpack's TemplatePlugin","name":"Webpack's TemplatePlugin","inLanguage":"en"}</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","description":"Breadcrumbs list","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","item":{"@id":"https://lihautan.com","name":"Homepage"},"position":1},{"@type":"ListItem","item":{"@id":"https%3A%2F%2Flihautan.com%2Fwebpack-plugin-main-template","name":"Webpack's TemplatePlugin"},"position":2}]}</script><link as="script" rel="preload" href="./435a71d4.js"><link as="style" rel="preload" href="./assets/blog-base-ed21726f.css"><link as="style" rel="preload" href="./435a71d4.css"><link href="./assets/blog-base-ed21726f.css" rel="stylesheet"><link href="./435a71d4.css" rel="stylesheet">
</head>

<body>
  <div id="app">

<a href="#content" class="skip svelte-2w4dum">Skip to content</a>
<header class="svelte-f3e4uo"><nav><ul class="svelte-f3e4uo"><li class="svelte-f3e4uo"><a href="/" class="svelte-f3e4uo">Tan Li Hau</a></li>
    <li class="svelte-f3e4uo"><a href="/about" class="svelte-f3e4uo">About</a></li>
    <li class="svelte-f3e4uo"><a href="/blogs" class="svelte-f3e4uo">Writings</a></li>
    <li class="svelte-f3e4uo"><a href="/talks" class="svelte-f3e4uo">Talks</a></li>
    <li class="svelte-f3e4uo"><a href="/notes" class="svelte-f3e4uo">Notes</a></li>
    <li class="svelte-f3e4uo"><a href="/newsletter" class="svelte-f3e4uo">Newsletter</a></li>
    <li class="social svelte-f3e4uo"><a href="https://twitter.com/lihautan" class="svelte-f3e4uo"><svg viewBox="0 0 24 24" class="svelte-f3e4uo"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66
    10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5
    4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a>
      <a href="https://github.com/tanhauhau" class="svelte-f3e4uo"><svg viewBox="0 0 24 24" class="svelte-f3e4uo"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0
    0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07
    5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65
    5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42
    3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></li></ul></nav>
</header>

<main id="content" class="blog svelte-2w4dum"><h1>Webpack&#39;s TemplatePlugin</h1>
  
  

  <article><section><ul class="sitemap" id="sitemap" role="navigation" aria-label="Table of Contents"><li><a href="#webpack-s-output-library-options">Webpack&#39;s output.library *  options</a></li><ul><ul><li><a href="#name-of-a-module-system-commonjs-commonjs-amd-umd">1. Name of a module system:  &quot;commonjs&quot; ,  &quot;commonjs2&quot; ,  &quot;amd&quot; ,  &quot;umd&quot; , ...</a></li><li><a href="#name-of-a-variable-var-this-self-window-global">2. Name of a variable:  &quot;var&quot; ,  &quot;this&quot; ,  &quot;self&quot; ,  &quot;window&quot; ,  &quot;global&quot;</a></li></ul></ul><li><a href="#writing-a-webpack-plugin">Writing a webpack plugin</a></li><li><a href="#closing-note">Closing Note</a></li></ul></section>
<p>If you are using webpack to bundle your library, you most likely will export something in your entry file:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// weback.config.js</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  entry<span class="token punctuation">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// src/index.js</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token string">'foo'</span><span class="token punctuation">;</span></code></pre>
<p>And if you build it with webpack just like that, out-of-the-box, you may be surprised that if you try to <code>require()</code> the built file, you would find that there&#39;s nothing being exported by the built file.</p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/bundle.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints &#96;&#123;&#125;&#96; (empty object)</span></code></pre>
<p>If you&#39;ve read <a href="/i-wrote-my-module-bundler/">my previous article on writing a module bundler</a>, you can imagine that the output bundle looks something like this:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// dist/bundle.js</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">webpackStart</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> moduleMap<span class="token punctuation">,</span> entryPoint <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token string">'src/index.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    exports<span class="token punctuation">.</span><span class="token keyword module">default</span> <span class="token operator">=</span> <span class="token string">'foo'</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><em>(Everything should be familiar, except the fact that instead of calling <code>webpackStart</code> in a separate statement, I made it into a IIFE (Immediately Invoked Function Expression) for reasons that will be apparent later)</em></p>
<p>In order to build for a library, ie: to expose whatever is exported by the entry file, webpack provides 3 options that you can play with:</p>
<ul><li><a href="https://webpack.js.org/configuration/output/#outputlibrary" rel="nofollow">output.library</a></li>
<li><a href="https://webpack.js.org/configuration/output/#outputlibraryexport" rel="nofollow">output.libraryExport</a></li>
<li><a href="https://webpack.js.org/configuration/output/#outputlibrarytarget" rel="nofollow">output.libraryTarget</a></li></ul>
<section><h2><a href="#webpack-s-output-library-options" id="webpack-s-output-library-options">Webpack&#39;s output.library* options</a></h2>
<p>To understand how each of them works, let&#39;s start with <code>output.libraryTarget</code>.</p>
<p><code>output.libraryTarget</code> accepts <code>string</code> as value, there are 2 main groups of values that you can provide to the <code>output.libraryTarget</code> option:</p></section>
<section><h4><a href="#name-of-a-module-system-commonjs-commonjs-amd-umd" id="name-of-a-module-system-commonjs-commonjs-amd-umd">1. Name of a module system: <code>&quot;commonjs&quot;</code>, <code>&quot;commonjs2&quot;</code>, <code>&quot;amd&quot;</code>, <code>&quot;umd&quot;</code>, ...</a></h4>
<p>Webpack allows you to specify the name of the module system that you want to use to expose the exported values of the entry file.</p>
<p>You can specify a module system that is different from the one that you are using in your library.</p>
<p>Let&#39;s try <code>commonjs2</code> as an example:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  libraryTarget<span class="token punctuation">:</span> <span class="token string">'commonjs2'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token comment">// dist/bundle.js</span>
<span class="token comment">// highlight-next-line</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">webpackStart</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> moduleMap<span class="token punctuation">,</span> entryPoint <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token string">'src/index.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    exports<span class="token punctuation">.</span><span class="token keyword module">default</span> <span class="token operator">=</span> <span class="token string">'foo'</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><code>commonjs2</code> uses <code>module.exports</code> to export values from a module. In this example, webpack assigns the return value of the IIFE to <code>module.exports</code>.</p>
<p>If you look at the bundled code, it is not much different than the one without specifying <code>output.libraryTarget</code>. The only difference is that the bundled code is prefixed with <code>module.exports =</code>;</p>
<blockquote><p>By the way, if you are curious about the difference between commonjs and commonjs2, you can follow the thread of <a href="https://github.com/webpack/webpack/issues/1114" rel="nofollow">this issue</a>.</p></blockquote></section>
<section><h4><a href="#name-of-a-variable-var-this-self-window-global" id="name-of-a-variable-var-this-self-window-global">2. Name of a variable: <code>&quot;var&quot;</code>, <code>&quot;this&quot;</code>, <code>&quot;self&quot;</code>, <code>&quot;window&quot;</code>, <code>&quot;global&quot;</code></a></h4>
<p>On the other hand, instead of exposing the library content through a module system, you can specify the variable name which the export object is assigned to.</p>
<p>Let&#39;s take <code>self</code> as an example:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  libraryTarget<span class="token punctuation">:</span> <span class="token string">'self'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token comment">// dist/bundle.js</span>
<span class="token comment">// highlight-next-line</span>
<span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">assign</span><span class="token punctuation">(</span>
  <span class="token comment">// highlight-next-line</span>
  self<span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">webpackStart</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> moduleMap<span class="token punctuation">,</span> entryPoint <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token string">'src/index.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      exports<span class="token punctuation">.</span><span class="token keyword module">default</span> <span class="token operator">=</span> <span class="token string">'foo'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// self.default === 'foo'</span></code></pre>
<p>All the exported values are assigned to <code>self</code>.</p>
<p>Again observe the bundled code, this time round we prefixed the bundled code with <code>Object.assign(self,</code> and suffixed it with <code>);</code>.</p>
<p>Specifiying the <code>output.libraryTarget</code> as <code>var</code> on the other hand, allows you to assign it to a variable name, which you can provide in <code>output.library</code> option:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  library<span class="token punctuation">:</span> <span class="token string">'myApp'</span><span class="token punctuation">,</span>
  libraryTarget<span class="token punctuation">:</span> <span class="token string">'var'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// dist/bundle.js</span>
<span class="token comment">// highlight-next-line</span>
<span class="token keyword">var</span> myApp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">webpackStart</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> moduleMap<span class="token punctuation">,</span> entryPoint <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token string">'src/index.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    exports<span class="token punctuation">.</span><span class="token keyword module">default</span> <span class="token operator">=</span> <span class="token string">'foo'</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// myApp === &#123; default: 'foo' &#125;</span></code></pre>
<p>If you don&#39;t want <code>myApp</code> to contain all the exported value of the entry file, you can provide the key that you want to export only in the <code>output.libraryExport</code> option:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  library<span class="token punctuation">:</span> <span class="token string">'myApp'</span><span class="token punctuation">,</span>
  libraryTarget<span class="token punctuation">:</span> <span class="token string">'var'</span><span class="token punctuation">,</span>
  libraryExport<span class="token punctuation">:</span> <span class="token string">'default'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// dist/bundle.js</span>
<span class="token keyword">var</span> myApp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">webpackStart</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> moduleMap<span class="token punctuation">,</span> entryPoint <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span>entryPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token string">'src/index.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    exports<span class="token punctuation">.</span><span class="token keyword module">default</span> <span class="token operator">=</span> <span class="token string">'foo'</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token comment">// highlight-next-line</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword module">default</span><span class="token punctuation">;</span>

<span class="token comment">// myApp === 'foo'</span></code></pre>
<p>Again you can observe that by playing different option values of <code>output.library</code>, <code>output.libraryTarget</code>, <code>output.libraryExport</code>, webpack adds different prefix and suffix to the bundled code:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// libraryTarget: 'commonjs2':</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token constant">BUNDLED_CODE</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// libraryTarget: 'self':</span>
<span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">assign</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token constant">BUNDLED_CODE</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// library: 'myApp', libraryTarget: 'var':</span>
<span class="token keyword">var</span> myApp <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token constant">BUNDLED_CODE</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// library: 'myApp', libraryTarget: 'var', libraryExport: 'default':</span>
<span class="token keyword">var</span> myApp <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token constant">BUNDLED_CODE</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token keyword module">default</span><span class="token punctuation">;</span></code></pre>
<p>So, instead of using the webpack built-in library targets, what should we do if we want to support a custom library target that looks something like below:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// libraryTarget: ???</span>
customRegistry<span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token string">'my-app'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token constant">BUNDLED_CODE</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>I searched through the <a href="https://webpack.js.org/configuration/output/" rel="nofollow">webpack official docs</a> and found no options that allows that. So the only solution at the moment is to write a webpack plugin.</p></section>
<section><h2><a href="#writing-a-webpack-plugin" id="writing-a-webpack-plugin">Writing a webpack plugin</a></h2>
<p>After digging around the <a href="https://github.com/webpack/webpack" rel="nofollow">webpack source code</a>, I found out that <a href="https://github.com/webpack/webpack/blob/master/lib/LibraryTemplatePlugin.js" rel="nofollow">LibraryTemplatePlugin</a> instantiates different TemplatePlugins based on the value of the <code>output.libraryTarget</code> option:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// webpack/lib/LibraryTemplatePlugin.js</span>
<span class="token keyword">class</span> <span class="token class-name">LibraryTemplatePlugin</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// ...</span>
<span class="token function">apply</span> <span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// ...</span>
<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">options</span><span class="token punctuation">.</span><span class="token property-access">libraryTarget</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">case</span> <span class="token string">'amd'</span><span class="token punctuation">:</span>
  <span class="token keyword">case</span> <span class="token string">'amd-require'</span><span class="token punctuation">:</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">new</span> <span class="token class-name">AmdTemplatePlugin</span><span class="token punctuation">(</span><span class="token comment">/*...*/</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token string">'var'</span><span class="token punctuation">:</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">new</span> <span class="token class-name">SetVarTemplatePlugin</span><span class="token punctuation">(</span><span class="token comment">/*...*/</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token string">'this'</span><span class="token punctuation">:</span>
  <span class="token keyword">case</span> <span class="token string">'self'</span><span class="token punctuation">:</span>
  <span class="token keyword">case</span> <span class="token string">'window'</span><span class="token punctuation">:</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">new</span> <span class="token class-name">SetVarTemplatePlugin</span><span class="token punctuation">(</span><span class="token comment">/*...*/</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>I went to look into one of the TemplatePlugins, the <a href="https://github.com/webpack/webpack/blob/master/lib/SetVarTemplatePlugin.js" rel="nofollow">SetVarTemplatePlugin</a>:</p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token maybe-class-name">ConcatSource</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-sources'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">SetVarTemplatePlugin</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    compiler<span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token property-access">thisCompilation</span><span class="token punctuation">.</span><span class="token method function property-access">tap</span><span class="token punctuation">(</span><span class="token string">'SetVarTemplatePlugin'</span><span class="token punctuation">,</span> <span class="token parameter">compilation</span> <span class="token arrow operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// ...</span>
      hooks<span class="token punctuation">.</span><span class="token property-access">render</span><span class="token punctuation">.</span><span class="token method function property-access">tap</span><span class="token punctuation">(</span>
        <span class="token string">'SetVarTemplatePlugin'</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> chunk<span class="token punctuation">,</span> chunkGraph <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// ...</span>
          <span class="token comment">// highlight-start</span>
          <span class="token keyword">const</span> prefix <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>varExpression<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> =</span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConcatSource</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// highlight-end</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>I don&#39;t understand line-by-line everything that happened in the file, but I do know that the line highlighted above, is where webpack concats the <code>varExpression =</code> (in the case of <code>commonjs</code>, <code>varExpression</code> is <code>module.exports</code>, thus <code>module.exports =</code>) and the source (which in this case is the bundled code).</p>
<p>So, to have the following:</p>
<pre class="language-js">
<code class="language-js">customRegistry<span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token string">'my-app'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token constant">BUNDLED_CODE</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>we need:</p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConcatSource</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">customRegistry.register('my-app', </span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> <span class="token string">')'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>So, I did the following:</p>
<ol><li>Created a new file and pasted the entire source from <a href="https://github.com/webpack/webpack/blob/master/lib/SetVarTemplatePlugin.js" rel="nofollow">SetVarTemplatePlugin.js</a></li>
<li>Searched + replaced to rename the plugin name to something more appropriate, (SetModuleTemplatePlugin)</li>
<li>Replaced relative import, <code>require(&quot;./RuntimeGlobals&quot;)</code> to require from webpack, <code>require(&quot;webpack/lib/RuntimeGlobals&quot;)</code></li>
<li>Replaced the line <code>return new ConcatSource(prefix, source);</code> to the following:</li></ol>
<pre class="language-js">
<code class="language-js"><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConcatSource</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">customRegistry.register('my-app', </span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> <span class="token string">')'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ol><li>Removed <code>output.library</code>, <code>output.libraryTarget</code> from webpack config</li>
<li>Added my new plugin:</li></ol>
<pre class="language-js">
<code class="language-js"><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">SetModuleTemplatePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>
<p>To my surprise, it worked! Almost.</p>
<p>When I run the bundled code, the customRegistry registered an empty object, nothing is exported from the bundled code.</p>
<p>I went into <a href="https://github.com/webpack/webpack/blob/master/lib/LibraryTemplatePlugin.js" rel="nofollow">LibraryTemplatePlugin.js</a> to look about, because that&#39;s the most obvious place to start looking, since I&#39;ve copied line-by-line from <a href="https://github.com/webpack/webpack/blob/master/lib/SetVarTemplatePlugin.js" rel="nofollow">SetVarTemplatePlugin.js</a>.</p>
<p>I found a pretty obvious line that says:</p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">const</span> <span class="token maybe-class-name">FlagEntryExportAsUsedPlugin</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./FlagEntryExportAsUsedPlugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">FlagEntryExportAsUsedPlugin</span><span class="token punctuation">(</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">options</span><span class="token punctuation">.</span><span class="token property-access">libraryTarget</span> <span class="token operator">!==</span> <span class="token string">"module"</span><span class="token punctuation">,</span>
  <span class="token string">"used a library export"</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>If I would have to guess, I think that what this line is doing is to mark the export of the entry file as used, so that webpack would not <em>treeshake them away</em>.</p>
<blockquote><p>Which, <strong>treeshake</strong> is a cool word that means remove them.</p>
<blockquote><p>Which you could argue that <strong>treeshake</strong> does way more that just remove the entry exports, it removes things that is only used by the entry exports, recursively.</p></blockquote></blockquote>
<p>I added these 2 lines into my <code>SetModuleTemplatePlugin</code>, and it worked! Perfectly this time. ðŸŽ‰</p>
<p>I created <a href="https://gist.github.com/tanhauhau/b6b355fbbabe224c9242a5257baa4dec" rel="nofollow">a gist</a> for the complete code, if you are lazy.</p>
<p>Lastly, if you noticed, this example is based on the latest master webpack source (at the time writing), which is <code>webpack@5.0.0-beta.12</code>.</p>
<p>If you want a similar plugin with <code>webpack^4</code>, you can trust me that this article serves as a good enough entry point for you to write the plugin on your own.</p>
<p><strong>And I trust you that you can do it. ðŸ˜Ž</strong></p></section>
<section><h2><a href="#closing-note" id="closing-note">Closing Note</a></h2>
<p>Writing a webpack plugin is not impossible. It will especially be easier if you have a good understanding how webpack as a bundler works.</p>
<p><em>(Plug: if you want to know more, you can read my <a href="/what-is-module-bundler-and-how-does-it-work/">&quot;What is module bundler and how does it work?&quot;</a>)</em></p></section></article></main>

<footer class="svelte-2w4dum"><div class="form svelte-1k1s1co"><h1>Subscribe to my newsletter</h1>
  <h2 class="svelte-1k1s1co">Get the latest blog posts and project updates delivered right to your inbox</h2>
  <form action="https://buttondown.email/api/emails/embed-subscribe/lihautan" method="post" target="popupwindow" onsubmit="window.open('https://buttondown.email/lihautan', 'popupwindow')" class="embeddable-buttondown-form"><div class="form-item svelte-1k1s1co"><input type="email" name="email" id="bd-email" placeholder="youremail@example.com" class="svelte-1k1s1co">
      <input type="submit" value="Subscribe" disabled class="svelte-1k1s1co"></div>
    <input type="hidden" value="1" name="embed" class="svelte-1k1s1co">
    <p class="svelte-1k1s1co">Powered by Buttondown.</p></form>
</div></footer>

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><script src="./435a71d4.js" async></script></div>
  
</body>

</html>