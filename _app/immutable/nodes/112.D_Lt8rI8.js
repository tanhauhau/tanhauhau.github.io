import{s as ao,d as zt,e as lo,f as Xs,n as no}from"../chunks/scheduler.D6VJxl8L.js";import{S as ro,i as io,m as po,n as co,o as ho,t as ko,a as fo,p as vo,e as t,s as a,H as m,b as Vs,c as s,q as r,h as l,d as u,r as b,g as k,f as Us,u as g,j as y,k as e}from"../chunks/index.CLAVN-Y5.js";import{g as uo,a as Gs}from"../chunks/code-snippet.Gym6WUAG.js";import{B as yo}from"../chunks/BlogLayout.BMJM32nZ.js";import{t as mo}from"../chunks/twitter-card-image.C3bQ3Oc7.js";function bo(M){let f,_='<h2><a href="#background" id="background">Background</a></h2> <p>Mentioned in the <a href="/errors-encountered-upgrading-flow-0.85/">previous post</a>, we have <a href="https://babeljs.io/docs/en/v7-migration" rel="nofollow">upgraded babel 7</a> to support the new Flow syntax.</p> <p><code class="inline">foobar&lt;Type&gt;(x)</code> is now <em>call foobar with x, and type parameter <code class="inline">Type</code></em> rather than <code class="inline">(foobar &lt; Type) &gt; x)</code> <em>is the result of foobar smaller than Type, greater than x?</em>.</p> <blockquote><p>Everything is great, until a weird runtime error caught us off guard.</p></blockquote>',x,n,v,w='<a href="#referenceerror-xtype-is-not-defined" id="referenceerror-xtype-is-not-defined">ReferenceError: XType is not defined</a>',H,A,Le,Ys=`<pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">export</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">foobar</span><span style="color: var(--shiki-color-text)">&lt;</span><span style="color: var(--shiki-token-function)">XType</span><span style="color: var(--shiki-color-text)">&gt;(baz);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">                       </span><span style="color: var(--shiki-token-keyword)">^</span><span style="color: var(--shiki-color-text)"> ReferenceError</span><span style="color: var(--shiki-token-punctuation)">:</span><span style="color: var(--shiki-color-text)"> XType is not defined</span></span></code></pre>`,Ge,P,Xt='The first time I saw this error, my first impression was that I forgot to import <code class="inline">XType</code>, so I scrolled to the top of the document. But, alas, I <strong>did import</strong> <code class="inline">XType</code>.',Ne,E,Vt="So what is going on? ü§∑‚Äç",Ye,q,Ut="I clicked into the error,",We,S,Me,Ws='<pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">export</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">foobar</span><span style="color: var(--shiki-color-text)"> &lt; </span><span style="color: var(--shiki-token-function)">XType</span><span style="color: var(--shiki-color-text)"> &gt; </span><span style="color: var(--shiki-token-function)">baz</span><span style="color: var(--shiki-color-text)">;</span></span></code></pre>',$e,j,Gt='looked at me innocently. I knew something was wrong. <code class="inline">XType</code> wasn&#39;t stripeed by babel!',Je,B,Nt='Shameless plug: If you read my <a href="/eslint-for-flow-explicit-type-argument-syntax/">eslint for flow syntax</a>, you should be able to come to the same conclusion! üòÖ',Qe,F,Yt='So I checked the <a href="https://babeljs.io/docs/en/babel-plugin-transform-flow-strip-types" rel="nofollow">@babel/plugin strip-flow-types</a>, I realise there&#39;s a <code class="inline">all</code> option that I had missed out, basically it says,',Ke,O,Wt='<p><strong>only parse</strong> Flow-specific features if a <code class="inline">@flow</code> pragma is <strong>present atop</strong> the file</p>',Ze,R,$t="It seems that in my file,",et,D,He,$s=`<pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-comment)">/** </span><span style="color: var(--shiki-token-keyword)">@module</span><span style="color: var(--shiki-token-comment)"> </span><span style="color: var(--shiki-token-function)">foobar</span><span style="color: var(--shiki-token-comment)"> */</span></span>
<span class="line"><span style="color: var(--shiki-token-comment)">// ...</span></span>
<span class="line"><span style="color: var(--shiki-token-keyword)">export</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">function</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">foobar</span><span style="color: var(--shiki-color-text)">&lt;</span><span style="color: var(--shiki-token-function)">XType</span><span style="color: var(--shiki-color-text)">&gt;(baz);</span></span></code></pre>`,tt,z,Jt='I had a innocent looking <code class="inline">/** @module */</code> comment above <code class="inline">// @flow</code> that breaks my babel plugin!',st,X,Qt="So the quick fix is to either:",ot,V,Kt='<li>Move <code class="inline">// @flow</code> comment above <code class="inline">/** @module foobar */</code>, or</li> <li>Set <code class="inline">all: true</code> in <code class="inline">@babel/plugin-transform-flow-strip-types</code>.</li>',at,U,Zt="Either way, it solves the issue.",lt,G,es="However, one thing bothers me:",nt,N,ts='<p>My Flow works perfectly fine with an extra comment on top <code class="inline">// @flow</code>, it still typechecks and provides auto-suggestions.</p>',rt,Y,ss='So, the logic for <code class="inline">@babel/plugin-transform-flow-strip-types</code> and Flow to determine whether a file is a Flow file or not <strong>is different</strong>!',it,W,os="And as a frequent user of Open Source libraries, this is something I think I <del>can</del> should fix, for the betterment of the JavaScript Open Source world üòÖ. I always imagine there&#39;s another innocent front-end developer across the world like me stumbled upon a perplexing bug, if only me let the bug go with a workaround/patch.",pt,$,as="<p>There&#39;s so much to achieve if we, not just consume the effort of others from the Open Source, but to also contribute into it.</p>",Ae,C,ls=`<h2><a href="#game-plan" id="game-plan">Game Plan</a></h2> <p>So, to fix this bug, one simply has to:</p> <ul><li>Read Flow&#39;s source code and understand the logic</li> <li>Read @babel/plugin-transform-strip-flow-type&#39;s source code and understand the logic</li> <li>Make changes to babel code</li> <li>Send a MR and brag about it üòé</li></ul> <p>Whether this is achieveable at my current level, that&#39;s a different story.
But <strong>one has nothing to lose to try and fail</strong>.</p>`,Pe,i,J,ns='<a href="#flow" id="flow">Flow</a>',ct,Q,rs='I&#39;ve read a bit of Flow source code previously, mainly to <a href="https://github.com/facebook/flow/pull/7083" rel="nofollow">fix a bad developer experience I had with flowconfig previously</a>. I had to learn <a href="https://ocaml.org/" rel="nofollow">OCaml</a>, which was a fad a while ago because of <a href="https://reasonml.github.io/" rel="nofollow">ReasonML</a>, to understand Flow source code.',ht,K,is="So, this time around, I am much more comfortable to dig the code to find out the information I want.",dt,Z,ps='I searched for the term <code class="inline">&quot;@flow&quot;</code>, which ended me up with <a href="https://github.com/facebook/flow/blob/master/src/parsing/parsing_service_js.ml#L143" rel="nofollow">this function</a>, <code class="inline">extract_docblock</code> which returns me the information of whether <code class="inline">@flow</code> is present in the file. And I dug further, I ended up with <a href="https://github.com/facebook/flow/blob/master/src/parsing/parsing_service_js.ml#L275" rel="nofollow">the annonymous function that <code class="inline">extract_docblck</code> returns</a>.',kt,ee,cs="Allow me to loosely translate the logic into some pseudo JavaScript:",ft,te,Ee,Js=`<pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">extract_docblock</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> (&#123; maxTokens</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> filename</span><span style="color: var(--shiki-token-punctuation)">,</span><span style="color: var(--shiki-color-text)"> content &#125;) </span><span style="color: var(--shiki-token-keyword)">=&gt;</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">file</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">read</span><span style="color: var(--shiki-color-text)">(filename);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">for</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-keyword)">let</span><span style="color: var(--shiki-color-text)"> i </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> maxTokens; i </span><span style="color: var(--shiki-token-keyword)">&gt;</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">0</span><span style="color: var(--shiki-color-text)">; i</span><span style="color: var(--shiki-token-keyword)">--</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">token</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">file</span><span style="color: var(--shiki-token-function)">.nextToken</span><span style="color: var(--shiki-color-text)">();</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">switch</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">token</span><span style="color: var(--shiki-color-text)">.type) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-keyword)">case</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;string&#39;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-keyword)">case</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;semicolon&#39;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-keyword)">continue</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-keyword)">case</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&#39;comment&#39;</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-function)">isFlowComment</span><span style="color: var(--shiki-color-text)">(token)) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">          </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">flowPragmaType</span><span style="color: var(--shiki-color-text)">(token);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        &#125;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-keyword)">break</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-keyword)">default</span><span style="color: var(--shiki-color-text)">:</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">        </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">null</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;;</span></span></code></pre>`,vt,se,hs="In human language:",ut,oe,ds='Flow will read <code class="inline">maxTokens</code> number of tokens, look for comments that matches <code class="inline">@flow</code>, if it encounters any order tokens, it will bail out early, with the exception of string and semicolon.',yt,ae,ks="So,",mt,le,qe,Qs=`<pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-string-expression)">&#39;use strict&#39;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-token-function)">foobar</span><span style="color: var(--shiki-color-text)">();</span></span></code></pre>`,bt,ne,fs="and",xt,re,Se,Ks=`<pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-comment)">/** </span><span style="color: var(--shiki-token-keyword)">@module</span><span style="color: var(--shiki-token-comment)"> */</span></span>
<span class="line"><span style="color: var(--shiki-token-function)">foobar</span><span style="color: var(--shiki-color-text)">();</span></span></code></pre>`,wt,ie,vs="is considered as a valid Flow file.",gt,pe,us="But",_t,ce,je,Zs='<pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-function)">foobar</span><span style="color: var(--shiki-color-text)">();</span></span></code></pre>',Ct,he,ys="or",Tt,de,Be,eo='<pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-function)">foobar</span><span style="color: var(--shiki-color-text)">();</span></span></code></pre>',It,ke,ms="is not.",Fe,c,fe,bs='<a href="#babel" id="babel">Babel</a>',Lt,ve,xs='At first, I thought that the logic would be in <code class="inline">@babel/transform-strip-flow-types</code>, but apparently, its not.',Mt,ue,ws='I discovered that by realising that the <a href="https://github.com/babel/babel/blob/master/packages/babel-plugin-transform-flow-strip-types/src/index.js" rel="nofollow">source code of @babel/transform-strip-flow-types</a> did not include anything about the <code class="inline">all</code> options, and <a href="https://github.com/babel/babel/blob/master/packages/babel-plugin-transform-flow-strip-types/src/index.js#L14" rel="nofollow">this plugin extends the @babel/plugin-syntax-flow</a>, which I knew fairly well that syntax plugins in babel does nothing but to enable syntax switch of the <code class="inline">@babel/parser</code>. The bulk of the logic lies within the <a href="https://github.com/babel/babel/blob/master/packages/babel-parser/src/plugins/flow.js" rel="nofollow"><code class="inline">@babel/parser</code>&#39;s flow plugin</a>.',Ht,ye,gs='That was all because <a href="https://github.com/babel/babel/pulls?q=is%3Apr+is%3Aclosed+author%3Atanhauhau" rel="nofollow">I contributed to <code class="inline">@babel/parser</code> before</a>.',At,me,_s='And here we are in babel-parser, and the line that caught my attention is <a href="https://github.com/babel/babel/blob/master/packages/babel-parser/src/plugins/flow.js#L98" rel="nofollow">this</a>:',Pt,be,Oe,to=`<pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-token-function)">addComment</span><span style="color: var(--shiki-color-text)">(comment: </span><span style="color: var(--shiki-token-constant)">N</span><span style="color: var(--shiki-color-text)">.Comment): </span><span style="color: var(--shiki-token-keyword)">void</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.flowPragma </span><span style="color: var(--shiki-token-keyword)">===</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">undefined</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-comment)">// Try to parse a flow pragma.</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">const</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">matches</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">FLOW_PRAGMA_REGEX</span><span style="color: var(--shiki-token-function)">.exec</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-constant)">comment</span><span style="color: var(--shiki-color-text)">.value);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (</span><span style="color: var(--shiki-token-keyword)">!</span><span style="color: var(--shiki-color-text)">matches) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.flowPragma </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">null</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (matches[</span><span style="color: var(--shiki-token-constant)">1</span><span style="color: var(--shiki-color-text)">] </span><span style="color: var(--shiki-token-keyword)">===</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&quot;flow&quot;</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.flowPragma </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&quot;flow&quot;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">if</span><span style="color: var(--shiki-color-text)"> (matches[</span><span style="color: var(--shiki-token-constant)">1</span><span style="color: var(--shiki-color-text)">] </span><span style="color: var(--shiki-token-keyword)">===</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&quot;noflow&quot;</span><span style="color: var(--shiki-color-text)">) &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-constant)">this</span><span style="color: var(--shiki-color-text)">.flowPragma </span><span style="color: var(--shiki-token-keyword)">=</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-string-expression)">&quot;noflow&quot;</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125; </span><span style="color: var(--shiki-token-keyword)">else</span><span style="color: var(--shiki-color-text)"> &#123;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">      </span><span style="color: var(--shiki-token-keyword)">throw</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-keyword)">new</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">Error</span><span style="color: var(--shiki-color-text)">(</span><span style="color: var(--shiki-token-string-expression)">&quot;Unexpected flow pragma&quot;</span><span style="color: var(--shiki-color-text)">);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">    &#125;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  &#125;</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">  </span><span style="color: var(--shiki-token-keyword)">return</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-function)">super.addComment</span><span style="color: var(--shiki-color-text)">(comment);</span></span>
<span class="line"><span style="color: var(--shiki-color-text)">&#125;</span></span></code></pre>`,Et,xe,Cs="So, the babel's logic of getting a Flow pragma is that as soon as the first comment encountered, we parse the comment and we turn on the Flow syntax switch.",qt,we,Ts='This is the reason why if we have a comment before <code class="inline">// @flow</code>, we will not treat the file as a valid Flow file.',St,ge,Is="Interesting enough, this means that if we write",jt,_e,Re,so=`<pre class="shiki" style="background-color: var(--shiki-color-background)"><code><span class="line"><span style="color: var(--shiki-color-text)">foobar </span><span style="color: var(--shiki-token-keyword)">&lt;</span><span style="color: var(--shiki-color-text)"> XType </span><span style="color: var(--shiki-token-keyword)">&gt;</span><span style="color: var(--shiki-color-text)"> </span><span style="color: var(--shiki-token-constant)">1</span><span style="color: var(--shiki-color-text)">;</span></span>
<span class="line"><span style="color: var(--shiki-token-function)">foobar</span><span style="color: var(--shiki-color-text)">&lt;</span><span style="color: var(--shiki-token-function)">XType</span><span style="color: var(--shiki-color-text)">&gt;(</span><span style="color: var(--shiki-token-constant)">1</span><span style="color: var(--shiki-color-text)">);</span></span></code></pre>`,Bt,Ce,Ls='the first half of the code before <code class="inline">// @flow</code> was parsed as a normal JS code, and the second half after <code class="inline">// @flow</code> was parsed as a Flow code.',Ft,T,Ot,De,oo='<a href="https://lihautan.com/babel-ast-explorer/#?%7B%22babel%22%3A%7B%22jsx%22%3Afalse%2C%22flow%22%3Atrue%2C%22typescript%22%3Afalse%2C%22objectRestSpread%22%3Afalse%2C%22pipelineOperator%22%3Afalse%2C%22throwExpressions%22%3Afalse%2C%22optionalChaining%22%3Afalse%2C%22nullishCoalescingOperator%22%3Afalse%2C%22exportDefaultFrom%22%3Afalse%2C%22dynamicImport%22%3Afalse%7D%2C%22code%22%3A%22foobar%3CXType%3E(1)%3B%5Cn%2F%2F%20%40flow%5Cnfoobar%3CXType%3E(1)%3B%22%7D">my recently build ASTExplorer clone for babel</a>',ze,Rt,Te,Ms="<em>(I built it with React + Hooks over a long weekend, which I will share about how did it in the future.)</em>.",Dt,Ie,Hs='You can see that the first expression is a <code class="inline">BinaryExpression</code> but the second expression is a <code class="inline">CallExpression</code>;',Xe,I,As='<h2><a href="#make-changes-to-the-babel-code" id="make-changes-to-the-babel-code">Make changes to the babel code</a></h2> <p>Now step 3, make changes to babel code. So I decided to open an issue and started fixing the code. Surprisingly, someone else <a href="https://github.com/babel/babel/issues/9240" rel="nofollow">had reported the issue a few months ago</a>, and the issue was still opened.</p> <p>So <a href="https://github.com/babel/babel/issues/9240#issuecomment-485370957" rel="nofollow">I explained what I had discovered</a>, and tried to <a href="https://github.com/babel/babel/pull/9885" rel="nofollow">propose a solution</a>. Well, after some struggle, I realised I am still a bit behind from being able to fix this code.</p> <p>So how?</p> <p>I submitted a <a href="https://github.com/babel/babel/pull/9885" rel="nofollow">PR</a> with a big <strong>WIP</strong>, because I didn&#39;t know how to look ahead <code class="inline">n</code> tokens and determine the <code class="inline">flowPragma</code> flag before <code class="inline">babel</code> starts parsing the code. I explored around the <code class="inline">babel-parser</code> source code, uncover new concepts that I never knew before. It took me a day to contemplate and fiddle around, until something sparked me.</p> <p>I realised I do not have to follow exactly Flow&#39;s logic in order to achieve similar behaviour. That&#39;s when I submitted another <a href="https://github.com/babel/babel/pull/9891" rel="nofollow">PR</a> and closed the previous one. <em>(You can check it out if you are curious about it)</em>.</p> <p>And finally, the fix has merged into <a href="https://github.com/babel/babel/releases/tag/v7.4.4" rel="nofollow">babel v7.4.4</a>! üéâüéâ</p> <p>And I can&#39;t wait to try all the edge cases that I have fixed in babel repl:</p> <ul><li><a href="https://babeljs.io/repl#?babili=false&amp;browsers=&amp;build=&amp;builtIns=false&amp;spec=false&amp;loose=false&amp;code_lz=OQVwzgpgBGAuBOBLAxrYBuAUAem1AAgGYA2A9gO6aGmkA8AggHwAUARgJRbV1NudA&amp;debug=false&amp;forceAllTransforms=false&amp;shippedProposals=false&amp;circleciRepo=&amp;evaluate=false&amp;fileSize=false&amp;timeTravel=false&amp;sourceType=module&amp;lineWrap=false&amp;presets=&amp;prettier=false&amp;targets=&amp;version=7.4.4&amp;externalPlugins=%40babel%2Fplugin-transform-flow-strip-types%407.4.4" rel="nofollow"><code class="inline">&#39;use strict&#39;</code>; before <code class="inline">// @flow</code></a></li> <li><a href="https://babeljs.io/repl#?babili=false&amp;browsers=&amp;build=&amp;builtIns=false&amp;spec=false&amp;loose=false&amp;code_lz=PQKhAIAEFsHsBMCuAbApgZ3AM1rcJgAoYYKLZWAd0J1gB4BBAPgAoAjASgG4bdHXOXIA&amp;debug=false&amp;forceAllTransforms=false&amp;shippedProposals=false&amp;circleciRepo=&amp;evaluate=false&amp;fileSize=false&amp;timeTravel=false&amp;sourceType=module&amp;lineWrap=false&amp;presets=&amp;prettier=false&amp;targets=&amp;version=7.4.4&amp;externalPlugins=%40babel%2Fplugin-transform-flow-strip-types%407.4.4" rel="nofollow">comments before <code class="inline">//@flow</code></a></li> <li><a href="https://babeljs.io/repl#?babili=false&amp;browsers=&amp;build=&amp;builtIns=false&amp;spec=false&amp;loose=false&amp;code_lz=GYexB4EED4AoCMCUBuAUAenQAgALADYgDuqoEMCKQA&amp;debug=false&amp;forceAllTransforms=false&amp;shippedProposals=false&amp;circleciRepo=&amp;evaluate=false&amp;fileSize=false&amp;timeTravel=false&amp;sourceType=module&amp;lineWrap=false&amp;presets=&amp;prettier=false&amp;targets=&amp;version=7.4.4&amp;externalPlugins=%40babel%2Fplugin-transform-flow-strip-types%407.4.4" rel="nofollow">first comment is <code class="inline">//@flow</code>, but in the middle of the file</a></li></ul>',Ve,L,Ps='<h2><a href="#closing-remark" id="closing-remark">Closing Remark</a></h2> <p><del>Well, I am sorry that I am going to stop here, because the issue is still opened, but I hoped you enjoy the detective journey along the way of hunting this bug.</del></p> <p><del>If you encountered similar issues, you can patch it first with the solution I mentioned earlier. And do follow the Github issue, I will do my best to fix this.</del></p> <p>If you encountered similar issues, please <a href="https://github.com/babel/babel/releases/tag/v7.4.4" rel="nofollow">upgrade babel to v7.4.4</a>.</p> <blockquote><p>The best thing about open source is that the source code is open. As part of the JS community, we should not just reap the efforts of the community when we are building our next billion dollar idea, we should also contribute back so that the community as a whole can grow and improve together.</p></blockquote> <p>As usual, here are the list of references for this article:</p> <ul><li><a href="/errors-encountered-upgrading-flow-0.85">Blog: Errors encountered upgrading Flow v0.85</a></li> <li><a href="/eslint-for-flow-explicit-type-argument-syntax/">My eslint doesn‚Äôt work with for flow 0.85‚Äôs explicit type argument syntax</a></li> <li><a href="https://babeljs.io/docs/en/v7-migration" rel="nofollow">Docs: Upgrading Babel v7</a></li> <li><a href="https://babeljs.io/docs/en/babel-plugin-transform-flow-strip-types" rel="nofollow">Docs: @babel/transform-plugin-flow-strip-types</a></li> <li><a href="https://reasonml.github.io/" rel="nofollow">Docs: ReasonML</a></li> <li><a href="https://github.com/facebook/flow/blob/master/src/parsing/parsing_service_js.ml" rel="nofollow">Code: Flow Parsing Service</a></li> <li><a href="https://github.com/babel/babel/issues/9240" rel="nofollow">Issue: Parsing error when calling generic functions with type arguments when flow pragma is not first comment</a></li></ul>';return{c(){f=t("section"),f.innerHTML=_,x=a(),n=t("section"),v=t("h2"),v.innerHTML=w,H=a(),A=t("div"),Le=new m(!1),Ge=a(),P=t("p"),P.innerHTML=Xt,Ne=a(),E=t("p"),E.textContent=Vt,Ye=a(),q=t("p"),q.textContent=Ut,We=a(),S=t("div"),Me=new m(!1),$e=a(),j=t("p"),j.innerHTML=Gt,Je=a(),B=t("p"),B.innerHTML=Nt,Qe=a(),F=t("p"),F.innerHTML=Yt,Ke=a(),O=t("blockquote"),O.innerHTML=Wt,Ze=a(),R=t("p"),R.textContent=$t,et=a(),D=t("div"),He=new m(!1),tt=a(),z=t("p"),z.innerHTML=Jt,st=a(),X=t("p"),X.textContent=Qt,ot=a(),V=t("ul"),V.innerHTML=Kt,at=a(),U=t("p"),U.textContent=Zt,lt=a(),G=t("p"),G.textContent=es,nt=a(),N=t("blockquote"),N.innerHTML=ts,rt=a(),Y=t("p"),Y.innerHTML=ss,it=a(),W=t("p"),W.innerHTML=os,pt=a(),$=t("blockquote"),$.innerHTML=as,Ae=a(),C=t("section"),C.innerHTML=ls,Pe=a(),i=t("section"),J=t("h2"),J.innerHTML=ns,ct=a(),Q=t("p"),Q.innerHTML=rs,ht=a(),K=t("p"),K.textContent=is,dt=a(),Z=t("p"),Z.innerHTML=ps,kt=a(),ee=t("p"),ee.textContent=cs,ft=a(),te=t("div"),Ee=new m(!1),vt=a(),se=t("p"),se.textContent=hs,ut=a(),oe=t("p"),oe.innerHTML=ds,yt=a(),ae=t("p"),ae.textContent=ks,mt=a(),le=t("div"),qe=new m(!1),bt=a(),ne=t("p"),ne.textContent=fs,xt=a(),re=t("div"),Se=new m(!1),wt=a(),ie=t("p"),ie.textContent=vs,gt=a(),pe=t("p"),pe.textContent=us,_t=a(),ce=t("div"),je=new m(!1),Ct=a(),he=t("p"),he.textContent=ys,Tt=a(),de=t("div"),Be=new m(!1),It=a(),ke=t("p"),ke.textContent=ms,Fe=a(),c=t("section"),fe=t("h2"),fe.innerHTML=bs,Lt=a(),ve=t("p"),ve.innerHTML=xs,Mt=a(),ue=t("p"),ue.innerHTML=ws,Ht=a(),ye=t("p"),ye.innerHTML=gs,At=a(),me=t("p"),me.innerHTML=_s,Pt=a(),be=t("div"),Oe=new m(!1),Et=a(),xe=t("p"),xe.textContent=Cs,qt=a(),we=t("p"),we.innerHTML=Ts,St=a(),ge=t("p"),ge.textContent=Is,jt=a(),_e=t("div"),Re=new m(!1),Bt=a(),Ce=t("p"),Ce.innerHTML=Ls,Ft=a(),T=t("p"),Ot=Vs("You can see this clearly with "),De=new m(!1),ze=Vs("."),Rt=a(),Te=t("p"),Te.innerHTML=Ms,Dt=a(),Ie=t("p"),Ie.innerHTML=Hs,Xe=a(),I=t("section"),I.innerHTML=As,Ve=a(),L=t("section"),L.innerHTML=Ps,this.h()},l(h){f=s(h,"SECTION",{"data-svelte-h":!0}),r(f)!=="svelte-hm54sv"&&(f.innerHTML=_),x=l(h),n=s(h,"SECTION",{});var o=u(n);v=s(o,"H2",{"data-svelte-h":!0}),r(v)!=="svelte-1cqvnrh"&&(v.innerHTML=w),H=l(o),A=s(o,"DIV",{class:!0});var Es=u(A);Le=b(Es,!1),Es.forEach(k),Ge=l(o),P=s(o,"P",{"data-svelte-h":!0}),r(P)!=="svelte-3iac2w"&&(P.innerHTML=Xt),Ne=l(o),E=s(o,"P",{"data-svelte-h":!0}),r(E)!=="svelte-16pzmoi"&&(E.textContent=Vt),Ye=l(o),q=s(o,"P",{"data-svelte-h":!0}),r(q)!=="svelte-1n2isf7"&&(q.textContent=Ut),We=l(o),S=s(o,"DIV",{class:!0});var qs=u(S);Me=b(qs,!1),qs.forEach(k),$e=l(o),j=s(o,"P",{"data-svelte-h":!0}),r(j)!=="svelte-qgctfl"&&(j.innerHTML=Gt),Je=l(o),B=s(o,"P",{"data-svelte-h":!0}),r(B)!=="svelte-6hawn3"&&(B.innerHTML=Nt),Qe=l(o),F=s(o,"P",{"data-svelte-h":!0}),r(F)!=="svelte-1joduty"&&(F.innerHTML=Yt),Ke=l(o),O=s(o,"BLOCKQUOTE",{"data-svelte-h":!0}),r(O)!=="svelte-x1763z"&&(O.innerHTML=Wt),Ze=l(o),R=s(o,"P",{"data-svelte-h":!0}),r(R)!=="svelte-1a13gx2"&&(R.textContent=$t),et=l(o),D=s(o,"DIV",{class:!0});var Ss=u(D);He=b(Ss,!1),Ss.forEach(k),tt=l(o),z=s(o,"P",{"data-svelte-h":!0}),r(z)!=="svelte-12lo3w5"&&(z.innerHTML=Jt),st=l(o),X=s(o,"P",{"data-svelte-h":!0}),r(X)!=="svelte-16pbc0j"&&(X.textContent=Qt),ot=l(o),V=s(o,"UL",{"data-svelte-h":!0}),r(V)!=="svelte-15od61i"&&(V.innerHTML=Kt),at=l(o),U=s(o,"P",{"data-svelte-h":!0}),r(U)!=="svelte-ae8n93"&&(U.textContent=Zt),lt=l(o),G=s(o,"P",{"data-svelte-h":!0}),r(G)!=="svelte-1b0p3z1"&&(G.textContent=es),nt=l(o),N=s(o,"BLOCKQUOTE",{"data-svelte-h":!0}),r(N)!=="svelte-6wn3y0"&&(N.innerHTML=ts),rt=l(o),Y=s(o,"P",{"data-svelte-h":!0}),r(Y)!=="svelte-19tdw87"&&(Y.innerHTML=ss),it=l(o),W=s(o,"P",{"data-svelte-h":!0}),r(W)!=="svelte-hrq5t8"&&(W.innerHTML=os),pt=l(o),$=s(o,"BLOCKQUOTE",{"data-svelte-h":!0}),r($)!=="svelte-1t6u9c6"&&($.innerHTML=as),o.forEach(k),Ae=l(h),C=s(h,"SECTION",{"data-svelte-h":!0}),r(C)!=="svelte-1nsq32t"&&(C.innerHTML=ls),Pe=l(h),i=s(h,"SECTION",{});var p=u(i);J=s(p,"H2",{"data-svelte-h":!0}),r(J)!=="svelte-1bsxhtk"&&(J.innerHTML=ns),ct=l(p),Q=s(p,"P",{"data-svelte-h":!0}),r(Q)!=="svelte-1wveye6"&&(Q.innerHTML=rs),ht=l(p),K=s(p,"P",{"data-svelte-h":!0}),r(K)!=="svelte-1m0eujw"&&(K.textContent=is),dt=l(p),Z=s(p,"P",{"data-svelte-h":!0}),r(Z)!=="svelte-wnqbwj"&&(Z.innerHTML=ps),kt=l(p),ee=s(p,"P",{"data-svelte-h":!0}),r(ee)!=="svelte-qw0drd"&&(ee.textContent=cs),ft=l(p),te=s(p,"DIV",{class:!0});var js=u(te);Ee=b(js,!1),js.forEach(k),vt=l(p),se=s(p,"P",{"data-svelte-h":!0}),r(se)!=="svelte-qubuxy"&&(se.textContent=hs),ut=l(p),oe=s(p,"P",{"data-svelte-h":!0}),r(oe)!=="svelte-16hz92m"&&(oe.innerHTML=ds),yt=l(p),ae=s(p,"P",{"data-svelte-h":!0}),r(ae)!=="svelte-nw716m"&&(ae.textContent=ks),mt=l(p),le=s(p,"DIV",{class:!0});var Bs=u(le);qe=b(Bs,!1),Bs.forEach(k),bt=l(p),ne=s(p,"P",{"data-svelte-h":!0}),r(ne)!=="svelte-1qlona5"&&(ne.textContent=fs),xt=l(p),re=s(p,"DIV",{class:!0});var Fs=u(re);Se=b(Fs,!1),Fs.forEach(k),wt=l(p),ie=s(p,"P",{"data-svelte-h":!0}),r(ie)!=="svelte-1gb3vqh"&&(ie.textContent=vs),gt=l(p),pe=s(p,"P",{"data-svelte-h":!0}),r(pe)!=="svelte-1yif00b"&&(pe.textContent=us),_t=l(p),ce=s(p,"DIV",{class:!0});var Os=u(ce);je=b(Os,!1),Os.forEach(k),Ct=l(p),he=s(p,"P",{"data-svelte-h":!0}),r(he)!=="svelte-93sdsf"&&(he.textContent=ys),Tt=l(p),de=s(p,"DIV",{class:!0});var Rs=u(de);Be=b(Rs,!1),Rs.forEach(k),It=l(p),ke=s(p,"P",{"data-svelte-h":!0}),r(ke)!=="svelte-72cwj1"&&(ke.textContent=ms),p.forEach(k),Fe=l(h),c=s(h,"SECTION",{});var d=u(c);fe=s(d,"H2",{"data-svelte-h":!0}),r(fe)!=="svelte-194vkco"&&(fe.innerHTML=bs),Lt=l(d),ve=s(d,"P",{"data-svelte-h":!0}),r(ve)!=="svelte-fgx0li"&&(ve.innerHTML=xs),Mt=l(d),ue=s(d,"P",{"data-svelte-h":!0}),r(ue)!=="svelte-1s8q2s8"&&(ue.innerHTML=ws),Ht=l(d),ye=s(d,"P",{"data-svelte-h":!0}),r(ye)!=="svelte-1k280qb"&&(ye.innerHTML=gs),At=l(d),me=s(d,"P",{"data-svelte-h":!0}),r(me)!=="svelte-1ifx2vb"&&(me.innerHTML=_s),Pt=l(d),be=s(d,"DIV",{class:!0});var Ds=u(be);Oe=b(Ds,!1),Ds.forEach(k),Et=l(d),xe=s(d,"P",{"data-svelte-h":!0}),r(xe)!=="svelte-egz7hr"&&(xe.textContent=Cs),qt=l(d),we=s(d,"P",{"data-svelte-h":!0}),r(we)!=="svelte-2ri27d"&&(we.innerHTML=Ts),St=l(d),ge=s(d,"P",{"data-svelte-h":!0}),r(ge)!=="svelte-1vzw40n"&&(ge.textContent=Is),jt=l(d),_e=s(d,"DIV",{class:!0});var zs=u(_e);Re=b(zs,!1),zs.forEach(k),Bt=l(d),Ce=s(d,"P",{"data-svelte-h":!0}),r(Ce)!=="svelte-1itxaob"&&(Ce.innerHTML=Ls),Ft=l(d),T=s(d,"P",{});var Ue=u(T);Ot=Us(Ue,"You can see this clearly with "),De=b(Ue,!1),ze=Us(Ue,"."),Ue.forEach(k),Rt=l(d),Te=s(d,"P",{"data-svelte-h":!0}),r(Te)!=="svelte-pp2jlv"&&(Te.innerHTML=Ms),Dt=l(d),Ie=s(d,"P",{"data-svelte-h":!0}),r(Ie)!=="svelte-m1n08m"&&(Ie.innerHTML=Hs),d.forEach(k),Xe=l(h),I=s(h,"SECTION",{"data-svelte-h":!0}),r(I)!=="svelte-eew3sd"&&(I.innerHTML=As),Ve=l(h),L=s(h,"SECTION",{"data-svelte-h":!0}),r(L)!=="svelte-f2j570"&&(L.innerHTML=Ps),this.h()},h(){Le.a=null,g(A,"class","code-section"),Me.a=null,g(S,"class","code-section"),He.a=null,g(D,"class","code-section"),Ee.a=null,g(te,"class","code-section"),qe.a=null,g(le,"class","code-section"),Se.a=null,g(re,"class","code-section"),je.a=null,g(ce,"class","code-section"),Be.a=null,g(de,"class","code-section"),Oe.a=null,g(be,"class","code-section"),Re.a=null,g(_e,"class","code-section"),De.a=ze},m(h,o){y(h,f,o),y(h,x,o),y(h,n,o),e(n,v),e(n,H),e(n,A),Le.m(Ys,A),e(n,Ge),e(n,P),e(n,Ne),e(n,E),e(n,Ye),e(n,q),e(n,We),e(n,S),Me.m(Ws,S),e(n,$e),e(n,j),e(n,Je),e(n,B),e(n,Qe),e(n,F),e(n,Ke),e(n,O),e(n,Ze),e(n,R),e(n,et),e(n,D),He.m($s,D),e(n,tt),e(n,z),e(n,st),e(n,X),e(n,ot),e(n,V),e(n,at),e(n,U),e(n,lt),e(n,G),e(n,nt),e(n,N),e(n,rt),e(n,Y),e(n,it),e(n,W),e(n,pt),e(n,$),y(h,Ae,o),y(h,C,o),y(h,Pe,o),y(h,i,o),e(i,J),e(i,ct),e(i,Q),e(i,ht),e(i,K),e(i,dt),e(i,Z),e(i,kt),e(i,ee),e(i,ft),e(i,te),Ee.m(Js,te),e(i,vt),e(i,se),e(i,ut),e(i,oe),e(i,yt),e(i,ae),e(i,mt),e(i,le),qe.m(Qs,le),e(i,bt),e(i,ne),e(i,xt),e(i,re),Se.m(Ks,re),e(i,wt),e(i,ie),e(i,gt),e(i,pe),e(i,_t),e(i,ce),je.m(Zs,ce),e(i,Ct),e(i,he),e(i,Tt),e(i,de),Be.m(eo,de),e(i,It),e(i,ke),y(h,Fe,o),y(h,c,o),e(c,fe),e(c,Lt),e(c,ve),e(c,Mt),e(c,ue),e(c,Ht),e(c,ye),e(c,At),e(c,me),e(c,Pt),e(c,be),Oe.m(to,be),e(c,Et),e(c,xe),e(c,qt),e(c,we),e(c,St),e(c,ge),e(c,jt),e(c,_e),Re.m(so,_e),e(c,Bt),e(c,Ce),e(c,Ft),e(c,T),e(T,Ot),De.m(oo,T),e(T,ze),e(c,Rt),e(c,Te),e(c,Dt),e(c,Ie),y(h,Xe,o),y(h,I,o),y(h,Ve,o),y(h,L,o)},p:no,d(h){h&&(k(f),k(x),k(n),k(Ae),k(C),k(Pe),k(i),k(Fe),k(c),k(Xe),k(I),k(Ve),k(L))}}}function xo(M){let f,_;const x=[M[0],Ns];let n={$$slots:{default:[bo]},$$scope:{ctx:M}};for(let v=0;v<x.length;v+=1)n=zt(n,x[v]);return f=new yo({props:n}),{c(){po(f.$$.fragment)},l(v){co(f.$$.fragment,v)},m(v,w){ho(f,v,w),_=!0},p(v,[w]){const H=w&1?uo(x,[w&1&&Gs(v[0]),w&0&&Gs(Ns)]):{};w&2&&(H.$$scope={dirty:w,ctx:v}),f.$set(H)},i(v){_||(ko(f.$$.fragment,v),_=!0)},o(v){fo(f.$$.fragment,v),_=!1},d(v){vo(f,v)}}}const Ns={title:"Parsing error when calling generic function with type arguments",date:"2019-04-23T08:00:00Z",lastUpdated:"2019-04-27T08:00:00Z",description:"üò±",label:"blog",tableOfContents:[{link:"background",title:"Background"},{link:"referenceerror-xtype-is-not-defined",title:"ReferenceError: XType is not defined"},{link:"game-plan",title:"Game Plan"},{link:"flow",title:"Flow"},{link:"babel",title:"Babel"},{link:"make-changes-to-the-babel-code",title:"Make changes to the babel code"},{link:"closing-remark",title:"Closing Remark"}]};function wo(M,f,_){return lo("blog",{image:mo}),M.$$set=x=>{_(0,f=zt(zt({},f),Xs(x)))},f=Xs(f),[f]}class Lo extends ro{constructor(f){super(),io(this,f,wo,xo,ao,{})}}export{Lo as component};
